<!doctype html><html lang=en-us dir=ltr><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="8. Stub resolvers in languages # Let’s now take a look at other popular languages and understand the capabilities, features and options they provide in the context of resolvers.
8.1 Python # We are going to talk about cpython 3.12.
8.1.1 Stub resolvers # The Python standard library provides socket.getaddrinfo():
socket.getaddrinfo(host, port, family=0, type=0, proto=0, flags=0) which internally calls libc getaddrinfo():
/* Python interface to getaddrinfo(host, port). */ /*ARGSUSED*/ static PyObject * socket_getaddrinfo(PyObject *self, PyObject *args, PyObject* kwargs) { ."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="http://localhost:1313/docs/resolver-dual-stack-application/8-stub-resolvers-in-languages/"><meta property="og:site_name" content="Viacheslav Biriukov"><meta property="og:title" content="Stub resolvers in languages"><meta property="og:description" content="8. Stub resolvers in languages # Let’s now take a look at other popular languages and understand the capabilities, features and options they provide in the context of resolvers.
8.1 Python # We are going to talk about cpython 3.12.
8.1.1 Stub resolvers # The Python standard library provides socket.getaddrinfo():
socket.getaddrinfo(host, port, family=0, type=0, proto=0, flags=0) which internally calls libc getaddrinfo():
/* Python interface to getaddrinfo(host, port). */ /*ARGSUSED*/ static PyObject * socket_getaddrinfo(PyObject *self, PyObject *args, PyObject* kwargs) { ."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><title>Stub resolvers in languages | Viacheslav Biriukov</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png><link rel=stylesheet href=/book.min.33a48f5432973b8ff9a82679d9e45d67f2c15d4399bd2829269455cfe390b5e8.css integrity="sha256-M6SPVDKXO4/5qCZ52eRdZ/LBXUOZvSgpJpRVz+OQteg=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script><script defer src=/en.search.min.1d41906aaf37198c05e8bca85b15248be7d2a4850e770874fce9182253d6a51a.js integrity="sha256-HUGQaq83GYwF6LyoWxUki+fSpIUOdwh0/OkYIlPWpRo=" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-599VSLESJL"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-599VSLESJL")</script><link rel=stylesheet href=/my_css/cookie.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Viacheslav Biriukov</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li class=book-section-flat><span>DNS resolvers and Dual-Stack applications</span><ul><li><a href=/docs/resolver-dual-stack-application/0-sre-should-know-about-gnu-linux-resolvers-and-dual-stack-applications/>Resolvers and Dual-Stack applications for SRE</a></li><li><a href=/docs/resolver-dual-stack-application/1-what-is-a-stub-resolver/>1. What is a stub resolver?</a></li><li><a href=/docs/resolver-dual-stack-application/2-history-gethostbyname/>2. History: gethostbyname()</a></li><li><a href=/docs/resolver-dual-stack-application/3-getaddrinfo-and-posix-spec/>3. getaddrinfo() and POSIX spec</a></li><li><a href=/docs/resolver-dual-stack-application/4-getaddrinfo-from-glibc/>4. getaddrinfo() from glibc</a></li><li><a href=/docs/resolver-dual-stack-application/5-getaddrinfo-from-musl-libc/>5. getaddrinfo() from musl libc</a></li><li><a href=/docs/resolver-dual-stack-application/6-dual-stack-applications/>6. Dual-Stack applications</a></li><li><a href=/docs/resolver-dual-stack-application/7-async-non-blocking-resolvers-in-c/>7. C async non-blocking resolvers</a></li><li><a href=/docs/resolver-dual-stack-application/8-stub-resolvers-in-languages/ class=active>8. Stub resolvers in languages</a></li><li><a href=/docs/resolver-dual-stack-application/9-dual-stack-software-examples/>9. Dual-stack software examples</a></li><li><a href=/docs/resolver-dual-stack-application/10-systemd-resolved/>10. systemd-resolved</a></li><li><a href=/docs/resolver-dual-stack-application/11-querying-nameservers-on-dual-stack-hosts/>11. Querying Nameservers</a></li><li><a href=/docs/resolver-dual-stack-application/12-present-and-future-of-resolvers-and-dns-related-features/>12. Present and future</a></li><li><a href=/docs/resolver-dual-stack-application/troubleshooting-tools-for-resolvers-and-dns/>Troubleshooting tools</a></li></ul></li></ul><div style=margin-top:30px;margin-bottom:30px><b>More post series:</b><ul><li><a href=/docs/fd-pipe-session-terminal/0-sre-should-know-about-gnu-linux-shell-related-internals-file-descriptors-pipes-terminals-user-sessions-process-groups-and-daemons>1. File descriptors, pipes, terminals, user sessions, process groups and daemons</li><li><a href=/docs/page-cache/0-linux-page-cache-for-sre/>2. Linux Page Cache mini book</li><li><a href=/docs/resolver-dual-stack-application/0-sre-should-know-about-gnu-linux-resolvers-and-dual-stack-applications/>3. Resolvers and Dual-Stack applications <span style="padding:0 2px;border-radius:2px;background-color:#e84118;color:#f0f8ff">new</span></li></ul></div><ul><li><a href=https://twitter.com/brk0v/ target=_blank rel=noopener><i class="bi bi-twitter"></i>
Twitter</a></li><li><a href=https://www.linkedin.com/in/biriukov/ target=_blank rel=noopener><i class="bi bi-linkedin"></i>
Linkedin</a></li><li><a href=https://github.com/brk0v/ target=_blank rel=noopener><i class="bi bi-github"></i>
Github</a></li></ul><div style=margin-top:30px><p xmlns:cc=http://creativecommons.org/ns#>This content is licensed under
<a href="http://creativecommons.org/licenses/by-nc/4.0/?ref=chooser-v1" target=_blank rel="license noopener noreferrer" style=display:inline-block>CC BY-NC 4.0<img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1"><img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"><img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1"></a></p></div></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Stub resolvers in languages</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#8-stub-resolvers-in-languages>8. Stub resolvers in languages</a><ul><li><a href=#81-python>8.1 Python</a><ul><li><a href=#811--stub-resolvers>8.1.1 Stub resolvers</a></li><li><a href=#812-happy-eyeballs>8.1.2 Happy Eyeballs</a></li></ul></li><li><a href=#82-go-golang>8.2 Go (golang)</a><ul><li><a href=#821-resolver>8.2.1 Resolver</a></li><li><a href=#822-happy-eyeballs>8.2.2 Happy Eyeballs</a></li></ul></li><li><a href=#83-rust>8.3 Rust</a><ul><li><a href=#831-resolver>8.3.1 Resolver</a></li><li><a href=#832-happy-eyeballs>8.3.2 Happy Eyeballs</a></li></ul></li><li><a href=#84-java-and-netty>8.4 Java and Netty</a><ul><li><a href=#841-resolver>8.4.1 Resolver</a></li><li><a href=#842-java-securitymanager>8.4.2 Java SecurityManager</a></li><li><a href=#843-happy-eyeballs>8.4.3 Happy eyeballs</a></li></ul></li><li><a href=#85-nodejs>8.5 Node.js</a><ul><li><a href=#851-resoler>8.5.1 Resoler</a></li><li><a href=#852-happy-eyeballs>8.5.2 Happy Eyeballs</a></li></ul></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=8-stub-resolvers-in-languages>8. Stub resolvers in languages
<a class=anchor href=#8-stub-resolvers-in-languages>#</a></h1><p>Let’s now take a look at other popular languages and understand the capabilities, features and options they provide in the context of resolvers.</p><h2 id=81-python>8.1 Python
<a class=anchor href=#81-python>#</a></h2><p>We are going to talk about <code>cpython</code> 3.12.</p><h3 id=811--stub-resolvers>8.1.1 Stub resolvers
<a class=anchor href=#811--stub-resolvers>#</a></h3><p>The Python standard library provides <code><a href=https://docs.python.org/3/library/socket.html#socket.getaddrinfo: target=_blank rel=noopener>socket.getaddrinfo()</a></code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>socket<span style=color:#f92672>.</span>getaddrinfo(host, port, family<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>, type<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>, proto<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>, flags<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span></code></pre></div><p>which internally calls <code>libc</code> <code><a href=https://github.com/python/cpython/blob/5f6001130f8ada871193377954cfcfee01ef93b6/Modules/socketmodule.c#L6679: target=_blank rel=noopener>getaddrinfo()</a></code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* Python interface to getaddrinfo(host, port). */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*ARGSUSED*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> PyObject <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>socket_getaddrinfo</span>(PyObject <span style=color:#f92672>*</span>self, PyObject <span style=color:#f92672>*</span>args, PyObject<span style=color:#f92672>*</span> kwargs)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>hints, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(hints));
</span></span><span style=display:flex><span>    hints.ai_family <span style=color:#f92672>=</span> family;
</span></span><span style=display:flex><span>    hints.ai_socktype <span style=color:#f92672>=</span> socktype;
</span></span><span style=display:flex><span>    hints.ai_protocol <span style=color:#f92672>=</span> protocol;
</span></span><span style=display:flex><span>    hints.ai_flags <span style=color:#f92672>=</span> flags;
</span></span><span style=display:flex><span>    Py_BEGIN_ALLOW_THREADS
</span></span><span style=display:flex><span>    error <span style=color:#f92672>=</span> <span style=color:#a6e22e>getaddrinfo</span>(hptr, pptr, <span style=color:#f92672>&amp;</span>hints, <span style=color:#f92672>&amp;</span>res0);
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>There are also <code><a href=https://docs.python.org/3/library/socket.html#socket.gethostbyname target=_blank rel=noopener>socket.gethostbyname()</a></code> and <code><a href=https://docs.python.org/3/library/socket.html#socket.gethostbyname_ex target=_blank rel=noopener>socket.gethostbyname_ex()</a></code>, but they both don&rsquo;t support IPv6.</p><p>The latest significant paradigm shift in Python was the adoption of async functions. The async standard framework includes <code><a href=https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.loop.getaddrinfo target=_blank rel=noopener>loop.getaddrinfo()</a></code>, which provides asynchronous DNS resolution capabilities:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> asyncio
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> socket
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>resolve_hostname</span>(hostname):
</span></span><span style=display:flex><span>    loop <span style=color:#f92672>=</span> asyncio<span style=color:#f92672>.</span>get_running_loop()
</span></span><span style=display:flex><span>    addresses <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> loop<span style=color:#f92672>.</span>getaddrinfo(hostname, <span style=color:#66d9ef>None</span>, proto<span style=color:#f92672>=</span>socket<span style=color:#f92672>.</span>IPPROTO_TCP)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> addresses
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>addresses <span style=color:#f92672>=</span> asyncio<span style=color:#f92672>.</span>run(resolve_hostname(<span style=color:#e6db74>&#39;microsoft.com&#39;</span>))
</span></span></code></pre></div><p>which internally shows the same behavior as <code>getaddrinfo()</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>strace -f -s0 python3 ./main.py
</span></span></code></pre></div><p>Open config files:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>pid 49937<span style=color:#f92672>]</span> openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/etc/nsswitch.conf&#34;</span>, O_RDONLY|O_CLOEXEC<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>pid 49937<span style=color:#f92672>]</span> openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/etc/host.conf&#34;</span>, O_RDONLY|O_CLOEXEC<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> -1 ENOENT <span style=color:#f92672>(</span>No such file or directory<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>pid 49937<span style=color:#f92672>]</span> openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/etc/resolv.conf&#34;</span>, O_RDONLY|O_CLOEXEC<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>pid 49937<span style=color:#f92672>]</span> openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/etc/hosts&#34;</span>, O_RDONLY|O_CLOEXEC<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>pid 49937<span style=color:#f92672>]</span> openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/etc/gai.conf&#34;</span>, O_RDONLY|O_CLOEXEC<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>
</span></span></code></pre></div><p>Obtaining source addresses:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>pid 49955<span style=color:#f92672>]</span> connect<span style=color:#f92672>(</span>6, <span style=color:#f92672>{</span>sa_family<span style=color:#f92672>=</span>AF_UNSPEC, sa_data<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;</span><span style=color:#f92672>}</span>, 16<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>pid 49955<span style=color:#f92672>]</span> connect<span style=color:#f92672>(</span>6, <span style=color:#f92672>{</span>sa_family<span style=color:#f92672>=</span>AF_INET6, sin6_port<span style=color:#f92672>=</span>htons<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, sin6_flowinfo<span style=color:#f92672>=</span>htonl<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, inet_pton<span style=color:#f92672>(</span>AF_INET6, <span style=color:#e6db74>&#34;2603:1030:20e:3::23c&#34;</span>, &amp;sin6_addr<span style=color:#f92672>)</span>, sin6_scope_id<span style=color:#f92672>=</span>0<span style=color:#f92672>}</span>, 28<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>pid 49955<span style=color:#f92672>]</span> getsockname<span style=color:#f92672>(</span>6, <span style=color:#f92672>{</span>sa_family<span style=color:#f92672>=</span>AF_INET6, sin6_port<span style=color:#f92672>=</span>htons<span style=color:#f92672>(</span>33582<span style=color:#f92672>)</span>, sin6_flowinfo<span style=color:#f92672>=</span>htonl<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, inet_pton<span style=color:#f92672>(</span>AF_INET6, <span style=color:#e6db74>&#34;2001:db8:123:456:6af2:68fe:ff7c:e25c&#34;</span>, &amp;sin6_addr<span style=color:#f92672>)</span>, sin6_scope_id<span style=color:#f92672>=</span>0<span style=color:#f92672>}</span>, <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>28<span style=color:#f92672>])</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>So we can guess that under the hood <a href=https://github.com/python/cpython/blob/d9efa45d7457b0dfea467bb1c2d22c69056ffc73/Lib/asyncio/base_events.py#L928-L936 target=_blank rel=noopener>it still runs</a> <code>socket.getaddrinfo()</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>getaddrinfo</span>(self, host, port, <span style=color:#f92672>*</span>, family<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>, type<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>, proto<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>, flags<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>_debug:
</span></span><span style=display:flex><span>        getaddr_func <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_getaddrinfo_debug
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        getaddr_func <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>getaddrinfo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> self<span style=color:#f92672>.</span>run_in_executor(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>None</span>, getaddr_func, host, port, family, type, proto, flags)
</span></span></code></pre></div><p>The <code>socket.getaddrinfo()</code> is running in a thread execution pool.</p><p>Such a solution could show performance issues under high load, that’s why there are plenty of third party libraries. But I’d like to show the <code><a href=https://pypi.org/project/aiodns/ target=_blank rel=noopener>aiodns</a></code>. Internally it uses <code><a href=https://github.com/saghul/pycares target=_blank rel=noopener>pycares</a></code> which is a Python interface for <code>c-ares</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> aiodns
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> asyncio
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> socket
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>resolve_hostname</span>(hostname):
</span></span><span style=display:flex><span>    resolver <span style=color:#f92672>=</span> aiodns<span style=color:#f92672>.</span>DNSResolver()
</span></span><span style=display:flex><span>    result <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> resolver<span style=color:#f92672>.</span>gethostbyname(hostname, socket<span style=color:#f92672>.</span>AF_UNSPEC)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>addresses <span style=color:#f92672>=</span> asyncio<span style=color:#f92672>.</span>run(resolve_hostname(<span style=color:#e6db74>&#39;microsoft.com&#39;</span>))
</span></span><span style=display:flex><span>print(addresses<span style=color:#f92672>.</span>addresses)
</span></span></code></pre></div><p>Opening system files:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ strace -e openat python3 ./dns.py
</span></span><span style=display:flex><span>…
</span></span><span style=display:flex><span>openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/etc/resolv.conf&#34;</span>, O_RDONLY<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/etc/nsswitch.conf&#34;</span>, O_RDONLY<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/etc/host.conf&#34;</span>, O_RDONLY<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> -1 ENOENT <span style=color:#f92672>(</span>No such file or directory<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/etc/svc.conf&#34;</span>, O_RDONLY<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> -1 ENOENT <span style=color:#f92672>(</span>No such file or directory<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/etc/hosts&#34;</span>, O_RDONLY<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>…
</span></span></code></pre></div><p>Gather source addresses:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ strace -f -e trace<span style=color:#f92672>=</span>network python3 ./dns.py
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>socket<span style=color:#f92672>(</span>AF_INET6, SOCK_DGRAM, IPPROTO_UDP<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>connect<span style=color:#f92672>(</span>7, <span style=color:#f92672>{</span>sa_family<span style=color:#f92672>=</span>AF_INET6, sin6_port<span style=color:#f92672>=</span>htons<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, sin6_flowinfo<span style=color:#f92672>=</span>htonl<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, inet_pton<span style=color:#f92672>(</span>AF_INET6, <span style=color:#e6db74>&#34;2603:1030:b:3::152&#34;</span>, &amp;sin6_addr<span style=color:#f92672>)</span>, sin6_scope_id<span style=color:#f92672>=</span>0<span style=color:#f92672>}</span>, 28<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>getsockname<span style=color:#f92672>(</span>7, <span style=color:#f92672>{</span>sa_family<span style=color:#f92672>=</span>AF_INET6, sin6_port<span style=color:#f92672>=</span>htons<span style=color:#f92672>(</span>58701<span style=color:#f92672>)</span>, sin6_flowinfo<span style=color:#f92672>=</span>htonl<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, inet_pton<span style=color:#f92672>(</span>AF_INET6, <span style=color:#e6db74>&#34;2001:db8:123:456:6af2:68fe:ff7c:e25c&#34;</span>, &amp;sin6_addr<span style=color:#f92672>)</span>, sin6_scope_id<span style=color:#f92672>=</span>0<span style=color:#f92672>}</span>, <span style=color:#f92672>[</span>28<span style=color:#f92672>])</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>socket<span style=color:#f92672>(</span>AF_INET6, SOCK_DGRAM, IPPROTO_UDP<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>connect<span style=color:#f92672>(</span>7, <span style=color:#f92672>{</span>sa_family<span style=color:#f92672>=</span>AF_INET6, sin6_port<span style=color:#f92672>=</span>htons<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, sin6_flowinfo<span style=color:#f92672>=</span>htonl<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, inet_pton<span style=color:#f92672>(</span>AF_INET6, <span style=color:#e6db74>&#34;2603:1030:20e:3::23c&#34;</span>, &amp;sin6_addr<span style=color:#f92672>)</span>, sin6_scope_id<span style=color:#f92672>=</span>0<span style=color:#f92672>}</span>, 28<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>getsockname<span style=color:#f92672>(</span>7, <span style=color:#f92672>{</span>sa_family<span style=color:#f92672>=</span>AF_INET6, sin6_port<span style=color:#f92672>=</span>htons<span style=color:#f92672>(</span>43168<span style=color:#f92672>)</span>, sin6_flowinfo<span style=color:#f92672>=</span>htonl<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, inet_pton<span style=color:#f92672>(</span>AF_INET6, <span style=color:#e6db74>&#34;2001:db8:123:456:6af2:68fe:ff7c:e25c&#34;</span>, &amp;sin6_addr<span style=color:#f92672>)</span>, sin6_scope_id<span style=color:#f92672>=</span>0<span style=color:#f92672>}</span>, <span style=color:#f92672>[</span>28<span style=color:#f92672>])</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>socket<span style=color:#f92672>(</span>AF_INET6, SOCK_DGRAM, IPPROTO_UDP<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>connect<span style=color:#f92672>(</span>7, <span style=color:#f92672>{</span>sa_family<span style=color:#f92672>=</span>AF_INET6, sin6_port<span style=color:#f92672>=</span>htons<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, sin6_flowinfo<span style=color:#f92672>=</span>htonl<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, inet_pton<span style=color:#f92672>(</span>AF_INET6, <span style=color:#e6db74>&#34;2603:1010:3:3::5b&#34;</span>, &amp;sin6_addr<span style=color:#f92672>)</span>, sin6_scope_id<span style=color:#f92672>=</span>0<span style=color:#f92672>}</span>, 28<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>getsockname<span style=color:#f92672>(</span>7, <span style=color:#f92672>{</span>sa_family<span style=color:#f92672>=</span>AF_INET6, sin6_port<span style=color:#f92672>=</span>htons<span style=color:#f92672>(</span>36319<span style=color:#f92672>)</span>, sin6_flowinfo<span style=color:#f92672>=</span>htonl<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, inet_pton<span style=color:#f92672>(</span>AF_INET6, <span style=color:#e6db74>&#34;2001:db8:123:456:6af2:68fe:ff7c:e25c&#34;</span>, &amp;sin6_addr<span style=color:#f92672>)</span>, sin6_scope_id<span style=color:#f92672>=</span>0<span style=color:#f92672>}</span>, <span style=color:#f92672>[</span>28<span style=color:#f92672>])</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>socket<span style=color:#f92672>(</span>AF_INET6, SOCK_DGRAM, IPPROTO_UDP<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>connect<span style=color:#f92672>(</span>7, <span style=color:#f92672>{</span>sa_family<span style=color:#f92672>=</span>AF_INET6, sin6_port<span style=color:#f92672>=</span>htons<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, sin6_flowinfo<span style=color:#f92672>=</span>htonl<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, inet_pton<span style=color:#f92672>(</span>AF_INET6, <span style=color:#e6db74>&#34;2603:1020:201:10::10f&#34;</span>, &amp;sin6_addr<span style=color:#f92672>)</span>, sin6_scope_id<span style=color:#f92672>=</span>0<span style=color:#f92672>}</span>, 28<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>getsockname<span style=color:#f92672>(</span>7, <span style=color:#f92672>{</span>sa_family<span style=color:#f92672>=</span>AF_INET6, sin6_port<span style=color:#f92672>=</span>htons<span style=color:#f92672>(</span>42078<span style=color:#f92672>)</span>, sin6_flowinfo<span style=color:#f92672>=</span>htonl<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, inet_pton<span style=color:#f92672>(</span>AF_INET6, <span style=color:#e6db74>&#34;2001:db8:123:456:6af2:68fe:ff7c:e25c&#34;</span>, &amp;sin6_addr<span style=color:#f92672>)</span>, sin6_scope_id<span style=color:#f92672>=</span>0<span style=color:#f92672>}</span>, <span style=color:#f92672>[</span>28<span style=color:#f92672>])</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>socket<span style=color:#f92672>(</span>AF_INET6, SOCK_DGRAM, IPPROTO_UDP<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>
</span></span><span style=display:flex><span>connect<span style=color:#f92672>(</span>7, <span style=color:#f92672>{</span>sa_family<span style=color:#f92672>=</span>AF_INET6, sin6_port<span style=color:#f92672>=</span>htons<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, sin6_flowinfo<span style=color:#f92672>=</span>htonl<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, inet_pton<span style=color:#f92672>(</span>AF_INET6, <span style=color:#e6db74>&#34;2603:1030:c02:8::14&#34;</span>, &amp;sin6_addr<span style=color:#f92672>)</span>, sin6_scope_id<span style=color:#f92672>=</span>0<span style=color:#f92672>}</span>, 28<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>getsockname<span style=color:#f92672>(</span>7, <span style=color:#f92672>{</span>sa_family<span style=color:#f92672>=</span>AF_INET6, sin6_port<span style=color:#f92672>=</span>htons<span style=color:#f92672>(</span>43403<span style=color:#f92672>)</span>, sin6_flowinfo<span style=color:#f92672>=</span>htonl<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, inet_pton<span style=color:#f92672>(</span>AF_INET6, <span style=color:#e6db74>&#34;2001:db8:123:456:6af2:68fe:ff7c:e25c&#34;</span>, &amp;sin6_addr<span style=color:#f92672>)</span>, sin6_scope_id<span style=color:#f92672>=</span>0<span style=color:#f92672>}</span>, <span style=color:#f92672>[</span>28<span style=color:#f92672>])</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><h3 id=812-happy-eyeballs>8.1.2 Happy Eyeballs
<a class=anchor href=#812-happy-eyeballs>#</a></h3><p>The async <code><a href=https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.loop.create_connection target=_blank rel=noopener>loop.create_connection()</a></code> allows to use the Happy Eyeballs algorithm from <a href=https://datatracker.ietf.org/doc/html/rfc8305.html target=_blank rel=noopener>RFC 8305</a>. The code is in <code><a href=https://github.com/python/cpython/blob/d9efa45d7457b0dfea467bb1c2d22c69056ffc73/Lib/asyncio/base_events.py#L1142C13-L1147C53 target=_blank rel=noopener>in Lib/asyncio/base_events.py</a></code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>if</span> happy_eyeballs_delay <span style=color:#f92672>is</span> <span style=color:#66d9ef>None</span>:
</span></span><span style=display:flex><span>   <span style=color:#75715e># not using happy eyeballs</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>…</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>:  <span style=color:#75715e># using happy eyeballs</span>
</span></span><span style=display:flex><span>   sock, _, _ <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> staggered<span style=color:#f92672>.</span>staggered_race(
</span></span><span style=display:flex><span>       (functools<span style=color:#f92672>.</span>partial(self<span style=color:#f92672>.</span>_connect_sock,
</span></span><span style=display:flex><span>               exceptions, addrinfo, laddr_infos)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> addrinfo <span style=color:#f92672>in</span> infos),
</span></span><span style=display:flex><span>        happy_eyeballs_delay, loop<span style=color:#f92672>=</span>self)
</span></span></code></pre></div><p>The params of <code>loop.create_connection()</code>are:</p><blockquote><p><code>happy_eyeballs_delay</code>, if given, enables Happy Eyeballs for this connection. It should be a floating-point number representing the amount of time in seconds to wait for a connection attempt to complete, before starting the next attempt in parallel. This is the &ldquo;Connection Attempt Delay&rdquo; as defined in <a href=https://datatracker.ietf.org/doc/html/rfc8305.html target=_blank rel=noopener>RFC 8305</a>. A sensible default value recommended by the RFC is 0.25 (250 milliseconds).</p><p><code>interleave</code> – controls address reordering when a host name resolves to multiple IP addresses. If 0 or unspecified, no reordering is done, and addresses are tried in the order returned by <a href=https://docs.python.org/3/library/asyncio-eventloop.html#asyncio.loop.getaddrinfo target=_blank rel=noopener>getaddrinfo()</a>. If a positive integer is specified, the addresses are interleaved by address family, and the given integer is interpreted as &ldquo;First Address Family Count&rdquo; as defined in <a href=https://datatracker.ietf.org/doc/html/rfc8305.html target=_blank rel=noopener>RFC 8305</a>. The default is 0 if happy_eyeballs_delay is not specified, and 1 if it is.</p></blockquote><h2 id=82-go-golang>8.2 Go (golang)
<a class=anchor href=#82-go-golang>#</a></h2><h3 id=821-resolver>8.2.1 Resolver
<a class=anchor href=#821-resolver>#</a></h3><p>According to the documentation golang has <a href=https://github.com/golang/go/blob/ad77cefeb2f5b3f1cef4383e974195ffc8610236/src/net/net.go#L66-L67 target=_blank rel=noopener>two components</a> to resolve domain names:</p><blockquote><p>On Unix systems, the resolver has two options for resolving names.</p><p>It can use a pure Go resolver that sends DNS requests directly to the servers
listed in <code>/etc/resolv.conf</code>, or it can use a cgo-based resolver that calls C
library routines such as <code>getaddrinfo</code> and <code>getnameinfo</code>.</p><p>On Unix the pure Go resolver is preferred over the <code>cgo</code> resolver, because a blocked DNS
request consumes only a goroutine, while a blocked <code>C</code> call consumes an operating system thread.</p><p>When <code>cgo</code> is available, the <code>cgo</code>-based resolver is used instead under a variety of
conditions: on systems that do not let programs make direct DNS requests (OS X),
when the <code>LOCALDOMAIN</code> environment variable is present (even if empty),
when the <code>RES_OPTIONS</code> or <code>HOSTALIASES</code> environment variable is non-empty,
when the <code>ASR_CONFIG</code> environment variable is non-empty (OpenBSD only),
when <code>/etc/resolv.conf</code> or <code>/etc/nsswitch.conf</code> specify the use of features that the
<code>Go</code> resolver does not implement.</p><p>On all systems (except Plan 9), when the <code>cgo</code> resolver is being used
this package applies a concurrent <code>cgo</code> lookup limit to prevent the system
from running out of system threads. Currently, it is limited to 500 concurrent lookups.</p><p>The resolver decision can be overridden by setting the <code>netdns</code> value of the
<code>GODEBUG</code> environment variable (see package runtime) to <code>go</code> or <code>cgo</code>, as in:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export GODEBUG<span style=color:#f92672>=</span>netdns<span style=color:#f92672>=</span>go    <span style=color:#75715e># force pure Go resolver</span>
</span></span><span style=display:flex><span>export GODEBUG<span style=color:#f92672>=</span>netdns<span style=color:#f92672>=</span>cgo   <span style=color:#75715e># force native resolver (cgo, win32)</span>
</span></span></code></pre></div></blockquote><p>Let’s create an example client resolver:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;net&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>) &lt; <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Usage: go run main.go &lt;domain&gt;&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>domain</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ips</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>net</span>.<span style=color:#a6e22e>LookupIP</span>(<span style=color:#a6e22e>domain</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Could not get IPs: %v\n&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>ip</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ips</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>ip</span>.<span style=color:#a6e22e>String</span>())
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Build it with debug info:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go build -gcflags <span style=color:#e6db74>&#34;all=-N -l&#34;</span> -o resolver ./main.go
</span></span></code></pre></div><p>Run:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./resolver.go microsoft.com
</span></span><span style=display:flex><span>2603:1020:201:10::10f
</span></span><span style=display:flex><span>2603:1030:b:3::152
</span></span><span style=display:flex><span>2603:1030:20e:3::23c
</span></span><span style=display:flex><span>2603:1030:c02:8::14
</span></span><span style=display:flex><span>2603:1010:3:3::5b
</span></span><span style=display:flex><span>20.231.239.246
</span></span><span style=display:flex><span>20.76.201.171
</span></span><span style=display:flex><span>20.70.246.20
</span></span><span style=display:flex><span>20.236.44.162
</span></span><span style=display:flex><span>20.112.250.133
</span></span></code></pre></div><p>Run with <code>strace</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo strace -e openat ./resolver microsoft.com
</span></span><span style=display:flex><span>…
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>pid 48568<span style=color:#f92672>]</span> openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/etc/resolv.conf&#34;</span>, O_RDONLY|O_CLOEXEC<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>pid 48568<span style=color:#f92672>]</span> openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/etc/nsswitch.conf&#34;</span>, O_RDONLY|O_CLOEXEC<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>pid 48568<span style=color:#f92672>]</span> openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/etc/hosts&#34;</span>, O_RDONLY|O_CLOEXEC<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>…
</span></span></code></pre></div><p>It only reads the basic system configuration files. It also does source address retrieval:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo strace -f -e trace<span style=color:#f92672>=</span>network ./resolver microsoft.com 2&gt;&amp;<span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>pid 48674<span style=color:#f92672>]</span> socket<span style=color:#f92672>(</span>AF_INET6, SOCK_DGRAM|SOCK_CLOEXEC|SOCK_NONBLOCK, IPPROTO_IP<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>pid 48674<span style=color:#f92672>]</span> setsockopt<span style=color:#f92672>(</span>3, SOL_IPV6, IPV6_V6ONLY, <span style=color:#f92672>[</span>0<span style=color:#f92672>]</span>, 4<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>pid 48674<span style=color:#f92672>]</span> setsockopt<span style=color:#f92672>(</span>3, SOL_SOCKET, SO_BROADCAST, <span style=color:#f92672>[</span>1<span style=color:#f92672>]</span>, 4<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>pid 48674<span style=color:#f92672>]</span> connect<span style=color:#f92672>(</span>3, <span style=color:#f92672>{</span>sa_family<span style=color:#f92672>=</span>AF_INET6, sin6_port<span style=color:#f92672>=</span>htons<span style=color:#f92672>(</span>9<span style=color:#f92672>)</span>, sin6_flowinfo<span style=color:#f92672>=</span>htonl<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, inet_pton<span style=color:#f92672>(</span>AF_INET6, <span style=color:#e6db74>&#34;2603:1030:c02:8::14&#34;</span>, &amp;sin6_addr<span style=color:#f92672>)</span>, sin6_scope_id<span style=color:#f92672>=</span>0<span style=color:#f92672>}</span>, 28<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>pid 48674<span style=color:#f92672>]</span> getsockname<span style=color:#f92672>(</span>3, <span style=color:#f92672>{</span>sa_family<span style=color:#f92672>=</span>AF_INET6, sin6_port<span style=color:#f92672>=</span>htons<span style=color:#f92672>(</span>58438<span style=color:#f92672>)</span>, sin6_flowinfo<span style=color:#f92672>=</span>htonl<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, inet_pton<span style=color:#f92672>(</span>AF_INET6, <span style=color:#e6db74>&#34;2001:db8:123:456:6af2:68fe:ff7c:e25c&#34;</span>, &amp;sin6_addr<span style=color:#f92672>)</span>, sin6_scope_id<span style=color:#f92672>=</span>0<span style=color:#f92672>}</span>, <span style=color:#f92672>[</span>112 <span style=color:#f92672>=</span>&gt; 28<span style=color:#f92672>])</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>pid 48674<span style=color:#f92672>]</span> getpeername<span style=color:#f92672>(</span>3, <span style=color:#f92672>{</span>sa_family<span style=color:#f92672>=</span>AF_INET6, sin6_port<span style=color:#f92672>=</span>htons<span style=color:#f92672>(</span>9<span style=color:#f92672>)</span>, sin6_flowinfo<span style=color:#f92672>=</span>htonl<span style=color:#f92672>(</span>0<span style=color:#f92672>)</span>, inet_pton<span style=color:#f92672>(</span>AF_INET6, <span style=color:#e6db74>&#34;2603:1030:c02:8::14&#34;</span>, &amp;sin6_addr<span style=color:#f92672>)</span>, sin6_scope_id<span style=color:#f92672>=</span>0<span style=color:#f92672>}</span>, <span style=color:#f92672>[</span>112 <span style=color:#f92672>=</span>&gt; 28<span style=color:#f92672>])</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>Let make sure we don’t use <code>libc</code> <code>getaddrinfo()</code>. We use <code>gdb</code> debugger for that:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gdb ./resolver
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> set args microsoft.com
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> break getaddrinfo
</span></span><span style=display:flex><span>Breakpoint <span style=color:#ae81ff>1</span> at 0x11aa90
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> run
</span></span><span style=display:flex><span>2603:1010:3:3::5b
</span></span><span style=display:flex><span>2603:1030:b:3::152
</span></span><span style=display:flex><span>2603:1020:201:10::10f
</span></span><span style=display:flex><span>2603:1030:20e:3::23c
</span></span><span style=display:flex><span>2603:1030:c02:8::14
</span></span><span style=display:flex><span>20.112.250.133
</span></span><span style=display:flex><span>20.231.239.246
</span></span><span style=display:flex><span>20.76.201.171
</span></span><span style=display:flex><span>20.236.44.162
</span></span><span style=display:flex><span>20.70.246.20
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Inferior <span style=color:#ae81ff>1</span> <span style=color:#f92672>(</span>process 48729<span style=color:#f92672>)</span> exited normally<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> Quit
</span></span></code></pre></div><p>The break point was not hit, so there were no <code>getaddrinfo()</code> calls.</p><p>And if we recompile with <code>cgo</code> resolver:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ export GODEBUG<span style=color:#f92672>=</span>netdns<span style=color:#f92672>=</span>cgo
</span></span><span style=display:flex><span>$ go build -gcflags <span style=color:#e6db74>&#34;all=-N -l&#34;</span>  -o resolver ./main.go
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ gdb ./resolver
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> set args microsoft.com
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> break getaddrinfo
</span></span><span style=display:flex><span>Breakpoint <span style=color:#ae81ff>1</span> at 0x11aa90
</span></span><span style=display:flex><span><span style=color:#f92672>(</span>gdb<span style=color:#f92672>)</span> run
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Thread <span style=color:#ae81ff>1</span> <span style=color:#e6db74>&#34;resolver&#34;</span> hit Breakpoint 1, __GI_getaddrinfo <span style=color:#f92672>(</span>name<span style=color:#f92672>=</span>0x4000012120 <span style=color:#e6db74>&#34;microsoft.com&#34;</span>, service<span style=color:#f92672>=</span>0x0, hints<span style=color:#f92672>=</span>0x4000100540, pai<span style=color:#f92672>=</span>0x4000040048<span style=color:#f92672>)</span> at ./nss/getaddrinfo.c:2297
</span></span><span style=display:flex><span>warning: <span style=color:#ae81ff>2297</span>   ./nss/getaddrinfo.c: No such file or directory
</span></span></code></pre></div><p>The decision which resolver to use happens <a href=https://github.com/golang/go/blob/ad77cefeb2f5b3f1cef4383e974195ffc8610236/src/net/conf.go#L231 target=_blank rel=noopener>here</a> and has a lot of logic to make a decision which stub resolver would be beneficial.</p><p><code>Go</code> supports the destination address sorting (as we see earlier with obtaining source adresses) in its go resolver but doesn’t provide a way to change the sorting rules (doesn’t read <code>/etc/gai.conf</code>). The logic lives in <a href=https://github.com/golang/go/blob/master/src/net/addrselect.go target=_blank rel=noopener>https://github.com/golang/go/blob/master/src/net/addrselect.go</a>.</p><h3 id=822-happy-eyeballs>8.2.2 Happy Eyeballs
<a class=anchor href=#822-happy-eyeballs>#</a></h3><p>The standard golang library transparently supports <a href=https://datatracker.ietf.org/doc/html/rfc6555 target=_blank rel=noopener>RFC 6555 Happy Eyeballs: Success with Dual-Stack Hosts</a> in <code><a href=https://pkg.go.dev/net#Dialer target=_blank rel=noopener>net.Dialer</a></code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Dialer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>…</span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// FallbackDelay specifies the length of time to wait before
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// spawning a RFC 6555 Fast Fallback connection. That is, this
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// is the amount of time to wait for IPv6 to succeed before
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// assuming that IPv6 is misconfigured and falling back to
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// IPv4.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// If zero, a default delay of 300ms is used.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// A negative value disables Fast Fallback support.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>FallbackDelay</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>…</span> 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Internally <code>net.Dialer</code> in the <code><a href="https://cs.opensource.google/go/go/+/refs/tags/go1.22.5:src/net/dial.go;drc=1d45a7ef560a76318ed59dfdb178cecd58caf948;l=455" target=_blank rel=noopener>DialContext()</a></code> method resolves hostname into adresses, splits them into two groups by address families, and runs the <code>sysDialer.dialParallel()</code> function:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>d</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Dialer</span>) <span style=color:#a6e22e>DialContext</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>network</span>, <span style=color:#a6e22e>address</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>Conn</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>addrs</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>resolver</span>().<span style=color:#a6e22e>resolveAddrList</span>(<span style=color:#a6e22e>resolveCtx</span>, <span style=color:#e6db74>&#34;dial&#34;</span>, <span style=color:#a6e22e>network</span>, <span style=color:#a6e22e>address</span>, <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>LocalAddr</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>OpError</span>{<span style=color:#a6e22e>Op</span>: <span style=color:#e6db74>&#34;dial&#34;</span>, <span style=color:#a6e22e>Net</span>: <span style=color:#a6e22e>network</span>, <span style=color:#a6e22e>Source</span>: <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>Addr</span>: <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>Err</span>: <span style=color:#a6e22e>err</span>}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>sd</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>sysDialer</span>{
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Dialer</span>:  <span style=color:#f92672>*</span><span style=color:#a6e22e>d</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>network</span>: <span style=color:#a6e22e>network</span>,
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>address</span>: <span style=color:#a6e22e>address</span>,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>primaries</span>, <span style=color:#a6e22e>fallbacks</span> <span style=color:#a6e22e>addrList</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>dualStack</span>() <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>network</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;tcp&#34;</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>primaries</span>, <span style=color:#a6e22e>fallbacks</span> = <span style=color:#a6e22e>addrs</span>.<span style=color:#a6e22e>partition</span>(<span style=color:#a6e22e>isIPv4</span>)
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>primaries</span> = <span style=color:#a6e22e>addrs</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sd</span>.<span style=color:#a6e22e>dialParallel</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>primaries</span>, <span style=color:#a6e22e>fallbacks</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>where <code><a href="https://cs.opensource.google/go/go/+/refs/tags/go1.22.5:src/net/dial.go;drc=1d45a7ef560a76318ed59dfdb178cecd58caf948;l=515" target=_blank rel=noopener>dialParallel()</a></code> issues an IPv6 connection request first, waits for <code>FallbackDelay</code> or 300 ms by default in <code><a href="https://cs.opensource.google/go/go/+/refs/tags/go1.22.5:src/net/dial.go;l=221;drc=1d45a7ef560a76318ed59dfdb178cecd58caf948" target=_blank rel=noopener>fallbackDelay()</a></code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// dialParallel races two copies of dialSerial, giving the first a
</span></span></span><span style=display:flex><span><span style=color:#75715e>// head start. It returns the first established connection and
</span></span></span><span style=display:flex><span><span style=color:#75715e>// closes the others. Otherwise it returns an error from the first
</span></span></span><span style=display:flex><span><span style=color:#75715e>// primary address.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sysDialer</span>) <span style=color:#a6e22e>dialParallel</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>primaries</span>, <span style=color:#a6e22e>fallbacks</span> <span style=color:#a6e22e>addrList</span>) (<span style=color:#a6e22e>Conn</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>fallbacks</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sd</span>.<span style=color:#a6e22e>dialSerial</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>primaries</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>returned</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> close(<span style=color:#a6e22e>returned</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>type</span> <span style=color:#a6e22e>dialResult</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Conn</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>primary</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>done</span>    <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>results</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>dialResult</span>) <span style=color:#75715e>// unbuffered
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>startRacer</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>primary</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>ras</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>primaries</span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>primary</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ras</span> = <span style=color:#a6e22e>fallbacks</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>c</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sd</span>.<span style=color:#a6e22e>dialSerial</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>ras</span>)
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>results</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>dialResult</span>{<span style=color:#a6e22e>Conn</span>: <span style=color:#a6e22e>c</span>, <span style=color:#66d9ef>error</span>: <span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>primary</span>: <span style=color:#a6e22e>primary</span>, <span style=color:#a6e22e>done</span>: <span style=color:#66d9ef>true</span>}:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>returned</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>c</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>c</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>primary</span>, <span style=color:#a6e22e>fallback</span> <span style=color:#a6e22e>dialResult</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Start the main racer.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>primaryCtx</span>, <span style=color:#a6e22e>primaryCancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>primaryCancel</span>()
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>startRacer</span>(<span style=color:#a6e22e>primaryCtx</span>, <span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>// Start the timer for the fallback racer.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#a6e22e>fallbackTimer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTimer</span>(<span style=color:#a6e22e>sd</span>.<span style=color:#a6e22e>fallbackDelay</span>())
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>fallbackTimer</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>fallbackTimer</span>.<span style=color:#a6e22e>C</span>:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>fallbackCtx</span>, <span style=color:#a6e22e>fallbackCancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>fallbackCancel</span>()
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>startRacer</span>(<span style=color:#a6e22e>fallbackCtx</span>, <span style=color:#66d9ef>false</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> <span style=color:#a6e22e>res</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>results</span>:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>res</span>.<span style=color:#66d9ef>error</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>Conn</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>primary</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>primary</span> = <span style=color:#a6e22e>res</span>
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>fallback</span> = <span style=color:#a6e22e>res</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>primary</span>.<span style=color:#a6e22e>done</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>fallback</span>.<span style=color:#a6e22e>done</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>primary</span>.<span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>primary</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>fallbackTimer</span>.<span style=color:#a6e22e>Stop</span>() {
</span></span><span style=display:flex><span>				<span style=color:#75715e>// If we were able to stop the timer, that means it
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#75715e>// was running (hadn&#39;t yet started the fallback), but
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#75715e>// we just got an error on the primary path, so start
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#75715e>// the fallback immediately (in 0 nanoseconds).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>				<span style=color:#a6e22e>fallbackTimer</span>.<span style=color:#a6e22e>Reset</span>(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>d</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Dialer</span>) <span style=color:#a6e22e>fallbackDelay</span>() <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>FallbackDelay</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>FallbackDelay</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>300</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=83-rust>8.3 Rust
<a class=anchor href=#83-rust>#</a></h2><p>We are talking about Rust 1.80.0.</p><h3 id=831-resolver>8.3.1 Resolver
<a class=anchor href=#831-resolver>#</a></h3><p>Rust has a <code><a href=https://doc.rust-lang.org/std/net/trait.ToSocketAddrs.html target=_blank rel=noopener>ToSocketAddrs</a></code> trait:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>trait</span> ToSocketAddrs {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Iter</span>: Iterator<span style=color:#f92672>&lt;</span>Item <span style=color:#f92672>=</span> SocketAddr<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Required method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>to_socket_addrs</span>(<span style=color:#f92672>&amp;</span>self) -&gt; Result<span style=color:#f92672>&lt;</span>Self::Iter<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>where <code><a href=https://doc.rust-lang.org/std/net/enum.SocketAddr.html target=_blank rel=noopener>SocketAddr</a></code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>SocketAddr</span> {
</span></span><span style=display:flex><span>    V4(SocketAddrV4),
</span></span><span style=display:flex><span>    V6(SocketAddrV6),
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>stdlib</code> comes with the trait <a href=https://github.com/rust-lang/rust/blob/382148d9a21ae0b506adf44fc1e55a410acde828/library/std/src/net/socket_addr.rs#L251-L268 target=_blank rel=noopener>implementation</a> for the<code>(&amp;str, u16)</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#75715e>#[stable(feature = </span><span style=color:#e6db74>&#34;rust1&#34;</span><span style=color:#75715e>, since = </span><span style=color:#e6db74>&#34;1.0.0&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>impl</span> ToSocketAddrs <span style=color:#66d9ef>for</span> (<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>str</span>, <span style=color:#66d9ef>u16</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Iter</span> <span style=color:#f92672>=</span> vec::IntoIter<span style=color:#f92672>&lt;</span>SocketAddr<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>to_socket_addrs</span>(<span style=color:#f92672>&amp;</span>self) -&gt; <span style=color:#a6e22e>io</span>::Result<span style=color:#f92672>&lt;</span>vec::IntoIter<span style=color:#f92672>&lt;</span>SocketAddr<span style=color:#f92672>&gt;&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>let</span> (host, port) <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>self;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// try to parse the host as a regular IP address first
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> Ok(addr) <span style=color:#f92672>=</span> host.parse::<span style=color:#f92672>&lt;</span>Ipv4Addr<span style=color:#f92672>&gt;</span>() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> addr <span style=color:#f92672>=</span> SocketAddrV4::new(addr, port);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Ok(vec![SocketAddr::V4(addr)].into_iter());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#66d9ef>let</span> Ok(addr) <span style=color:#f92672>=</span> host.parse::<span style=color:#f92672>&lt;</span>Ipv6Addr<span style=color:#f92672>&gt;</span>() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> addr <span style=color:#f92672>=</span> SocketAddrV6::new(addr, port, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> Ok(vec![SocketAddr::V6(addr)].into_iter());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        resolve_socket_addr((host, port).try_into()<span style=color:#f92672>?</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>where <code><a href=https://github.com/rust-lang/rust/blob/382148d9a21ae0b506adf44fc1e55a410acde828/library/std/src/sys_common/net.rs#L203C1-L219C2 target=_blank rel=noopener>(host, port).try_into()</a></code> uses the <code>TryFrom</code> trait which is reciprocal for <code><a href=https://doc.rust-lang.org/std/convert/trait.TryInto.html target=_blank rel=noopener>TryInto</a></code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>impl</span><span style=color:#f92672>&lt;</span><span style=color:#a6e22e>&#39;a</span><span style=color:#f92672>&gt;</span> TryFrom<span style=color:#f92672>&lt;</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>&#39;a</span> <span style=color:#66d9ef>str</span>, <span style=color:#66d9ef>u16</span>)<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>for</span> LookupHost {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Error</span> <span style=color:#f92672>=</span> io::Error;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>try_from</span>((host, port): (<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>&#39;a</span> <span style=color:#66d9ef>str</span>, <span style=color:#66d9ef>u16</span>)) -&gt; <span style=color:#a6e22e>io</span>::Result<span style=color:#f92672>&lt;</span>LookupHost<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>        init();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        run_with_cstr(host.as_bytes(), <span style=color:#f92672>&amp;|</span>c_host<span style=color:#f92672>|</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> hints: <span style=color:#a6e22e>c</span>::addrinfo <span style=color:#f92672>=</span> <span style=color:#66d9ef>unsafe</span> { mem::zeroed() };
</span></span><span style=display:flex><span>            hints.ai_socktype <span style=color:#f92672>=</span> c::<span style=color:#66d9ef>SOCK_STREAM</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> res <span style=color:#f92672>=</span> ptr::null_mut();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span>                cvt_gai(c::getaddrinfo(c_host.as_ptr(), ptr::null(), <span style=color:#f92672>&amp;</span>hints, <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> res))
</span></span><span style=display:flex><span>                    .map(<span style=color:#f92672>|</span>_<span style=color:#f92672>|</span> LookupHost { original: <span style=color:#a6e22e>res</span>, cur: <span style=color:#a6e22e>res</span>, port })
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>And here we can see here, it uses <code>getaddrinfo()</code> from <code>libc.</code></p><p>If you need a non-boking resolver to run it with async rust feature, you can, for example, use <code><a href=https://github.com/hickory-dns/hickory-dns target=_blank rel=noopener>trust-dns-resolver</a></code> and <code><a href=https://tokio.rs/ target=_blank rel=noopener>tokio</a></code>:</p><p>Dependency:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#66d9ef>[dependencies]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>tokio</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>{ version = &#34;1&#34;, features = [&#34;full&#34;] }</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>trust-dns-resolver</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;0.20&#34;</span>
</span></span></code></pre></div><p>Code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>use</span> trust_dns_resolver::TokioAsyncResolver;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> trust_dns_resolver::config::<span style=color:#f92672>*</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>use</span> trust_dns_resolver::system_conf::read_system_conf;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#[tokio::main]</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>main</span>() -&gt; Result<span style=color:#f92672>&lt;</span>(), Box<span style=color:#f92672>&lt;</span><span style=color:#66d9ef>dyn</span> std::error::Error<span style=color:#f92672>&gt;&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create the resolver from system configuration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> (resolver_config, <span style=color:#66d9ef>mut</span> resolver_opts) <span style=color:#f92672>=</span>read_system_conf()<span style=color:#f92672>?</span>; 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Specify the LookupIpStrategy you want
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    resolver_opts.ip_strategy <span style=color:#f92672>=</span> LookupIpStrategy::Ipv4AndIpv6;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create the resolver with the system configuration and modified options
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>let</span> resolver <span style=color:#f92672>=</span> TokioAsyncResolver::tokio(resolver_config, resolver_opts)<span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> response <span style=color:#f92672>=</span> resolver.lookup_ip(<span style=color:#e6db74>&#34;microsoft.com&#34;</span>).<span style=color:#66d9ef>await</span><span style=color:#f92672>?</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Print the IP addresses
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> ip <span style=color:#66d9ef>in</span> response.iter() {
</span></span><span style=display:flex><span>        println!(<span style=color:#e6db74>&#34;IP address: </span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span>, ip);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Ok(())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>It doesn’t follow the <a href=https://datatracker.ietf.org/doc/html/rfc6724 target=_blank rel=noopener>RFC 6724 Default Address Selection for Internet Protocol Version 6 (IPv6)</a> but it has a lot of other interesting <a href=https://github.com/hickory-dns/hickory-dns/tree/main/crates/resolver target=_blank rel=noopener>features</a>.</p><p>Run it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cargo build --release <span style=color:#f92672>&amp;&amp;</span> ./target/release/resolver
</span></span><span style=display:flex><span>    Finished <span style=color:#e6db74>`</span>release<span style=color:#e6db74>`</span> profile <span style=color:#f92672>[</span>optimized<span style=color:#f92672>]</span> target<span style=color:#f92672>(</span>s<span style=color:#f92672>)</span> in 0.02s
</span></span><span style=display:flex><span>IP address: 20.76.201.171
</span></span><span style=display:flex><span>IP address: 20.236.44.162
</span></span><span style=display:flex><span>IP address: 20.231.239.246
</span></span><span style=display:flex><span>IP address: 20.70.246.20
</span></span><span style=display:flex><span>IP address: 20.112.250.133
</span></span><span style=display:flex><span>IP address: 2603:1010:3:3::5b
</span></span><span style=display:flex><span>IP address: 2603:1030:c02:8::14
</span></span><span style=display:flex><span>IP address: 2603:1030:b:3::152
</span></span><span style=display:flex><span>IP address: 2603:1020:201:10::10f
</span></span><span style=display:flex><span>IP address: 2603:1030:20e:3::23c
</span></span></code></pre></div><p>The <code>strace()</code> output regarding reading system config files:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/etc/resolv.conf&#34;</span>, O_RDONLY|O_CLOEXEC<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>9</span>
</span></span><span style=display:flex><span>openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/etc/hosts&#34;</span>, O_RDONLY|O_CLOEXEC<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>9</span>
</span></span></code></pre></div><h3 id=832-happy-eyeballs>8.3.2 Happy Eyeballs
<a class=anchor href=#832-happy-eyeballs>#</a></h3><p>Although there is no support in the standard library, several third-party libraries provide such capabilities.</p><h2 id=84-java-and-netty>8.4 Java and Netty
<a class=anchor href=#84-java-and-netty>#</a></h2><p>We will be talking about <code>OpenJDK</code> version 21.</p><h3 id=841-resolver>8.4.1 Resolver
<a class=anchor href=#841-resolver>#</a></h3><p>The usual way to resolve a hostname is to run <code><a href=https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/net/InetAddress.html#getAllByName%28java.lang.String%29 target=_blank rel=noopener>java.net.getAllByName(String host)</a></code>.</p><p>In order to change preferences of address families there are two system <a href=https://github.com/openjdk/jdk/blob/4bcb8f04ed3623da7c84dda28017f473cbc97e53/src/java.base/share/classes/java/net/doc-files/net-properties.html#L47C2-L64C92 target=_blank rel=noopener>properties</a>:</p><ol><li><code>java.net.preferIPv4Stack</code>:</li></ol><blockquote><p><code>systemProperty</code> <code>java.net.preferIPv4Stack</code> (default: <strong>false</strong>)
If IPv6 is available on the operating system the
underlying native socket will be, by default, an IPv6 socket which
lets applications connect to, and accept connections from, both
IPv4 and IPv6 hosts. However, in the case an application would
rather use IPv4 only sockets, then this property can be set to true.
The implication is that it will not be possible for the application
to communicate with IPv6 only hosts.</p></blockquote><ol start=2><li><code>java.net.preferIPv6Addresse</code>:</li></ol><blockquote><p><code>systemProperty</code> <code>java.net.preferIPv6Addresses</code> (default: <strong>false</strong>)
When dealing with a host which has both IPv4
and IPv6 addresses, and if IPv6 is available on the operating
system, <strong>the default behavior is to prefer using IPv4 addresses over</strong>
<strong>IPv6 ones.</strong> This is to ensure backward compatibility: for example,
for applications that depend on the representation of an IPv4 address
(e.g. 192.168.1.1). This property can be set to <strong>true</strong> to
change that preference and use IPv6 addresses over IPv4 ones where
possible, or <strong>system</strong> to preserve the order of the addresses as
returned by the system-wide <code>java.net.spi.InetAddressResolver</code> resolver.</p></blockquote><p>Internally the following static variables are initialized in <code><a href=https://github.com/openjdk/jdk/blob/3abe8a6e5e459fb764b8cef2425be50fe1a83fab/src/java.base/share/classes/java/net/InetAddress.java#L1455-L1465 target=_blank rel=noopener>java.net.InetAdress</a></code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>static</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// create the impl</span>
</span></span><span style=display:flex><span>        impl <span style=color:#f92672>=</span> isIPv6Supported() <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>new</span> Inet6AddressImpl() : <span style=color:#66d9ef>new</span> Inet4AddressImpl();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// impl must be initialized before calling this method</span>
</span></span><span style=display:flex><span>        PLATFORM_LOOKUP_POLICY <span style=color:#f92672>=</span> initializePlatformLookupPolicy();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// create built-in resolver</span>
</span></span><span style=display:flex><span>        BUILTIN_RESOLVER <span style=color:#f92672>=</span> createBuiltinInetAddressResolver();
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>which ends up in the <a href=https://github.com/openjdk/jdk/blob/5ff7c57f9ff5428ef3d2aedd7e860bb1e8ff29ea/src/java.base/unix/native/libnet/Inet6AddressImpl.c#L230C1-L230C55 target=_blank rel=noopener>native code</a> and calls our old friend <code>getaddrinfo()</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>JNIEXPORT jobjectArray JNICALL
</span></span><span style=display:flex><span><span style=color:#a6e22e>Java_java_net_Inet6AddressImpl_lookupAllHostAddr</span>(JNIEnv <span style=color:#f92672>*</span>env, jobject this,
</span></span><span style=display:flex><span>                                                 jstring host, 
</span></span><span style=display:flex><span>                                                 jintcharacteristics) {
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>hints, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(hints));
</span></span><span style=display:flex><span>    hints.ai_flags <span style=color:#f92672>=</span> AI_CANONNAME;
</span></span><span style=display:flex><span>    hints.ai_family <span style=color:#f92672>=</span> <span style=color:#a6e22e>lookupCharacteristicsToAddressFamily</span>(characteristics);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    error <span style=color:#f92672>=</span> <span style=color:#a6e22e>getaddrinfo</span>(hostname, NULL, <span style=color:#f92672>&amp;</span>hints, <span style=color:#f92672>&amp;</span>res);
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <a href=https://github.com/openjdk/jdk/blob/4bcb8f04ed3623da7c84dda28017f473cbc97e53/src/java.base/share/native/libnet/net_util.c#L336 target=_blank rel=noopener>lookupCharacteristicsToAddressFamily()</a> function is controlling preferences from the above system properties:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>lookupCharacteristicsToAddressFamily</span>(<span style=color:#66d9ef>int</span> characteristics) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> ipv4 <span style=color:#f92672>=</span> characteristics <span style=color:#f92672>&amp;</span> java_net_spi_InetAddressResolver_LookupPolicy_IPV4;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> ipv6 <span style=color:#f92672>=</span> characteristics <span style=color:#f92672>&amp;</span> java_net_spi_InetAddressResolver_LookupPolicy_IPV6;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ipv4 <span style=color:#f92672>!=</span> 0 <span style=color:#f92672>&amp;&amp;</span> ipv6 <span style=color:#f92672>==</span> 0) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> AF_INET;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (ipv4 <span style=color:#f92672>==</span> 0 <span style=color:#f92672>&amp;&amp;</span> ipv6 <span style=color:#f92672>!=</span> 0) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> AF_INET6;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> AF_UNSPEC;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We can make some conclusions now:</p><ul><li>By default preference is given to IPv4 addresses, they are returned first.</li><li>You can reverse the logic by setting <code>preferIPv6Addresses</code> to <code>true</code>.</li><li>If you know that you are not going to use IPv6 at all, you can set <code>preferIPv4Stack</code> to <code>true</code> and the resolver stops querying for IPv6 <code>AAAA</code> records.</li><li>If you want to be dual stack ready and fully address agnostic with some drawback of the lack of Happy Eyeballs in Java, set <code>preferIPv6Addresses</code> to <code>system</code> to delegate all responsibility to <code>getaddrinfo()</code>.</li></ul><p>However, networking services are typically written using the <a href=https://netty.io/ target=_blank rel=noopener>Netty</a> asynchronous event-driven network framework. Netty provides its own asynchronous non-blocking resolver to work natively with its event loop-based model.</p><p>Let’s review its features in version 4.1.</p><p>The resolver’s documentation is <a href=https://netty.io/4.1/api/io/netty/resolver/dns/package-summary.html target=_blank rel=noopener>here</a> and to resolve an address you need to call <code><a href=https://netty.io/4.1/api/io/netty/resolver/SimpleNameResolver.html#resolveAll-java.lang.String- target=_blank rel=noopener>resolveAll(String inetHost)</a></code> of <code>SimpleNameResolver</code>.</p><p>For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#f92672>package</span> com.example;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.netty.bootstrap.Bootstrap;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.netty.channel.ChannelFactory;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.netty.channel.ChannelInitializer;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.netty.channel.nio.NioEventLoopGroup;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.netty.channel.socket.DatagramChannel;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.netty.channel.socket.nio.NioDatagramChannel;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.netty.resolver.ResolvedAddressTypes;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.netty.resolver.dns.DnsNameResolver;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.netty.resolver.dns.DnsNameResolverBuilder;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.netty.resolver.dns.DnsServerAddresses;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> io.netty.util.concurrent.Future;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.net.InetAddress;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> java.util.List;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>App</span> 
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>( String<span style=color:#f92672>[]</span> args ) <span style=color:#66d9ef>throws</span> java.<span style=color:#a6e22e>lang</span>.<span style=color:#a6e22e>InterruptedException</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Create an event loop group for handling DNS resolution</span>
</span></span><span style=display:flex><span>        NioEventLoopGroup group <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NioEventLoopGroup();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Create a DnsNameResolver</span>
</span></span><span style=display:flex><span>            DnsNameResolver resolver <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DnsNameResolverBuilder(group.<span style=color:#a6e22e>next</span>())
</span></span><span style=display:flex><span>                    .<span style=color:#a6e22e>channelFactory</span>(<span style=color:#66d9ef>new</span> ChannelFactory<span style=color:#f92672>&lt;</span>DatagramChannel<span style=color:#f92672>&gt;</span>() {
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>public</span> DatagramChannel <span style=color:#a6e22e>newChannel</span>() {
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> NioDatagramChannel();
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    })
</span></span><span style=display:flex><span>                    .<span style=color:#a6e22e>build</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Resolve the domain name asynchronously</span>
</span></span><span style=display:flex><span>            String domainName <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;microsoft.com&#34;</span>;
</span></span><span style=display:flex><span>            Future<span style=color:#f92672>&lt;</span>List<span style=color:#f92672>&lt;</span>InetAddress<span style=color:#f92672>&gt;&gt;</span> resolveFuture <span style=color:#f92672>=</span> resolver.<span style=color:#a6e22e>resolveAll</span>(domainName);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Wait for the resolution to complete</span>
</span></span><span style=display:flex><span>            List<span style=color:#f92672>&lt;</span>InetAddress<span style=color:#f92672>&gt;</span> inetAddresses <span style=color:#f92672>=</span> resolveFuture.<span style=color:#a6e22e>sync</span>().<span style=color:#a6e22e>getNow</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Print the resolved IP addresses</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> (InetAddress inetAddress : inetAddresses) {
</span></span><span style=display:flex><span>                System.<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>println</span>(<span style=color:#e6db74>&#34;Resolved IP address: &#34;</span> <span style=color:#f92672>+</span> inetAddress);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Shut down the event loop group to release resources</span>
</span></span><span style=display:flex><span>            group.<span style=color:#a6e22e>shutdownGracefully</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Resolved IP address: microsoft.com/20.70.246.20
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/20.231.239.246
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/20.236.44.162
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/20.112.250.133
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/20.76.201.171
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/2603:1010:3:3:0:0:0:5b
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/2603:1030:20e:3:0:0:0:23c
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/2603:1030:c02:8:0:0:0:14
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/2603:1020:201:10:0:0:0:10f
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/2603:1030:b:3:0:0:0:152
</span></span></code></pre></div><p>We can check that the resolver reads <code>/etc/hosts</code> in <code><a href=https://github.com/netty/netty/blob/c944afe7aeeb68ff8d2c586aba5e6ceebb5a06b8/resolver-dns/src/main/java/io/netty/resolver/dns/DnsNameResolver.java#L729 target=_blank rel=noopener>resolveHostsFileEntries()</a></code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> List<span style=color:#f92672>&lt;</span>InetAddress<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>resolveHostsFileEntries</span>(String hostname) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (hostsFileEntriesResolver <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        List<span style=color:#f92672>&lt;</span>InetAddress<span style=color:#f92672>&gt;</span> addresses;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (hostsFileEntriesResolver <span style=color:#66d9ef>instanceof</span> DefaultHostsFileEntriesResolver) {
</span></span><span style=display:flex><span>            addresses <span style=color:#f92672>=</span> ((DefaultHostsFileEntriesResolver) hostsFileEntriesResolver)
</span></span><span style=display:flex><span>                    .<span style=color:#a6e22e>addresses</span>(hostname, resolvedAddressTypes);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            InetAddress address <span style=color:#f92672>=</span> hostsFileEntriesResolver.<span style=color:#a6e22e>address</span>(hostname, resolvedAddressTypes);
</span></span><span style=display:flex><span>            addresses <span style=color:#f92672>=</span> address <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>?</span> Collections.<span style=color:#a6e22e>singletonList</span>(address) : <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> addresses <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> isLocalWindowsHost(hostname) <span style=color:#f92672>?</span>
</span></span><span style=display:flex><span>                Collections.<span style=color:#a6e22e>singletonList</span>(LOCALHOST_ADDRESS) : addresses;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>We can also specify the preference to resolve by settings <code>DnsNameResolverBuilder()</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>DnsNameResolver resolver <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> DnsNameResolverBuilder(group.<span style=color:#a6e22e>next</span>())
</span></span><span style=display:flex><span>                    .<span style=color:#a6e22e>channelFactory</span>(<span style=color:#66d9ef>new</span> ChannelFactory<span style=color:#f92672>&lt;</span>DatagramChannel<span style=color:#f92672>&gt;</span>() {
</span></span><span style=display:flex><span>                        <span style=color:#a6e22e>@Override</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>public</span> DatagramChannel <span style=color:#a6e22e>newChannel</span>() {
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> NioDatagramChannel();
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }).<span style=color:#a6e22e>resolvedAddressTypes</span>(ResolvedAddressTypes.<span style=color:#a6e22e>IPV6_PREFERRED</span>)
</span></span><span style=display:flex><span>                    .<span style=color:#a6e22e>build</span>();
</span></span></code></pre></div><p>Where <code><a href=https://github.com/netty/netty/blob/c944afe7aeeb68ff8d2c586aba5e6ceebb5a06b8/resolver/src/main/java/io/netty/resolver/ResolvedAddressTypes.java#L21 target=_blank rel=noopener>ResolvedAddressTypes</a></code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e> * Defined resolved address types.
</span></span></span><span style=display:flex><span><span style=color:#75715e> */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>enum</span> ResolvedAddressTypes {
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Only resolve IPv4 addresses
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    IPV4_ONLY,
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Only resolve IPv6 addresses
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    IPV6_ONLY,
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Prefer IPv4 addresses over IPv6 ones
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    IPV4_PREFERRED,
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * Prefer IPv6 addresses over IPv4 ones
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>    IPV6_PREFERRED
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Unfortunately, Netty does not support the <code>system</code> options for IPv6 preference like the standard socket resolver does. The decision what to prefer happens in <a href=https://github.com/netty/netty/blob/c944afe7aeeb68ff8d2c586aba5e6ceebb5a06b8/common/src/main/java/io/netty/util/NetUtil.java#L140-L149 target=_blank rel=noopener>NetUtil</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> <span style=color:#66d9ef>boolean</span> IPV4_PREFERRED <span style=color:#f92672>=</span> SystemPropertyUtil.<span style=color:#a6e22e>getBoolean</span>(<span style=color:#e6db74>&#34;java.net.preferIPv4Stack&#34;</span>, <span style=color:#66d9ef>false</span>);
</span></span><span style=display:flex><span>... 
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> {
</span></span><span style=display:flex><span>        String prefer <span style=color:#f92672>=</span> SystemPropertyUtil.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;java.net.preferIPv6Addresses&#34;</span>, <span style=color:#e6db74>&#34;false&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#e6db74>&#34;true&#34;</span>.<span style=color:#a6e22e>equalsIgnoreCase</span>(prefer.<span style=color:#a6e22e>trim</span>())) {
</span></span><span style=display:flex><span>            IPV6_ADDRESSES_PREFERRED <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Let&#39;s just use false in this case as only true is &#34;forcing&#34; ipv6.</span>
</span></span><span style=display:flex><span>            IPV6_ADDRESSES_PREFERRED <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;-Djava.net.preferIPv4Stack: {}&#34;</span>, IPV4_PREFERRED);
</span></span><span style=display:flex><span>        logger.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;-Djava.net.preferIPv6Addresses: {}&#34;</span>, prefer);
</span></span><span style=display:flex><span>       ... 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If we set the properties:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>-Djava.net.preferIPv6Addresses<span style=color:#f92672>=</span>true 
</span></span></code></pre></div><p>And get the return:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Resolved IP address: microsoft.com/2603:1030:20e:3:0:0:0:23c
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/2603:1030:b:3:0:0:0:152
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/2603:1030:c02:8:0:0:0:14
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/2603:1010:3:3:0:0:0:5b
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/2603:1020:201:10:0:0:0:10f
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/20.231.239.246
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/20.236.44.162
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/20.112.250.133
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/20.70.246.20
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/20.76.201.171
</span></span></code></pre></div><p>If we force to return only IPv4 with <code>preferIPv4Stack</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>-Djava.net.preferIPv4Stack<span style=color:#f92672>=</span>true
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Resolved IP address: microsoft.com/20.70.246.20
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/20.231.239.246
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/20.112.250.133
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/20.76.201.171
</span></span><span style=display:flex><span>Resolved IP address: microsoft.com/20.236.44.162
</span></span></code></pre></div><p>One more time there is no support of the <code>system</code> argument for <code>-Djava.net.preferIPv6Addresses=system</code> nor <a href=https://datatracker.ietf.org/doc/html/rfc6724#section-6 target=_blank rel=noopener>RFC 6724 with its section 6 Destination selection algorithm</a> and Happy Eyeballs, so it’s completely on you to control you address preferences and the order in which they will appear in the result list from the resolver. This unfortunately could lead to a complexity with application configuration in the process of migration to IPv6 infrastructure.</p><p>The open issue <a href=https://github.com/netty/netty/issues/13400 target=_blank rel=noopener>https://github.com/netty/netty/issues/13400</a> has more info about the situation.</p><h3 id=842-java-securitymanager>8.4.2 Java SecurityManager
<a class=anchor href=#842-java-securitymanager>#</a></h3><p>There is a well-known issue with Java regarding the caching of DNS resolutions.</p><p>If you have <code>SecurityManager</code> enabled, the default caching TTL is infinite. To change it, edit the <code>$JAVA_HOME/jre/lib/security/java.security</code>.</p><p>The defaults:</p><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># The Java-level namelookup cache policy for successful lookups:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># any negative value: caching forever</span>
</span></span><span style=display:flex><span><span style=color:#75715e># any positive value: the number of seconds to cache an address for</span>
</span></span><span style=display:flex><span><span style=color:#75715e># zero: do not cache</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># default value is forever (FOREVER). For security reasons, this</span>
</span></span><span style=display:flex><span><span style=color:#75715e># caching is made forever when a security manager is set. When a security</span>
</span></span><span style=display:flex><span><span style=color:#75715e># manager is not set, the default behavior in this implementation</span>
</span></span><span style=display:flex><span><span style=color:#75715e># is to cache for 30 seconds.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># NOTE: setting this to anything other than the default value can have</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#       serious security implications. Do not set it unless</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#       you are sure you are not exposed to DNS spoofing attack.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#networkaddress.cache.ttl=-1</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># The Java-level namelookup cache stale policy:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># any positive value: the number of seconds to use the stale names</span>
</span></span><span style=display:flex><span><span style=color:#75715e># zero: do not use stale names</span>
</span></span><span style=display:flex><span><span style=color:#75715e># negative values are ignored</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># default value is 0 (NEVER).</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#networkaddress.cache.stale.ttl=0</span>
</span></span><span style=display:flex><span><span style=color:#75715e># The Java-level namelookup cache policy for failed lookups:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># any negative value: cache forever</span>
</span></span><span style=display:flex><span><span style=color:#75715e># any positive value: the number of seconds to cache negative lookup results</span>
</span></span><span style=display:flex><span><span style=color:#75715e># zero: do not cache</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># In some Microsoft Windows networking environments that employ</span>
</span></span><span style=display:flex><span><span style=color:#75715e># the WINS name service in addition to DNS, name service lookups</span>
</span></span><span style=display:flex><span><span style=color:#75715e># that fail may take a noticeably long time to return (approx. 5 seconds).</span>
</span></span><span style=display:flex><span><span style=color:#75715e># For this reason the default caching policy is to maintain these</span>
</span></span><span style=display:flex><span><span style=color:#75715e># results for 10 seconds.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span>networkaddress.cache.negative.ttl<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>
</span></span></code></pre></div></blockquote><h3 id=843-happy-eyeballs>8.4.3 Happy eyeballs
<a class=anchor href=#843-happy-eyeballs>#</a></h3><p>There is no support in standard libraries.</p><p>There is no support in 4.1 netty: <a href=https://github.com/netty/netty/issues/9540 target=_blank rel=noopener>https://github.com/netty/netty/issues/9540</a></p><p>The <code><a href=https://square.github.io/okhttp/features/connections/#fast-fallback target=_blank rel=noopener>okhttp</a></code> (doesn&rsquo;t use Netty internally and implemented its own event loop) supports it since the 5.0 version.</p><h2 id=85-nodejs>8.5 Node.js
<a class=anchor href=#85-nodejs>#</a></h2><h3 id=851-resoler>8.5.1 Resoler
<a class=anchor href=#851-resoler>#</a></h3><p>The <code>libuv</code> is a <code>C</code> library originally written for <code>Node.js</code> to abstract non-blocking I/O operations.</p><p>It uses <code>getaddrinfo()</code> <a href=https://github.com/libuv/libuv/blob/master/docs/src/guide/networking.rst#querying-dns target=_blank rel=noopener>internally</a>.</p><blockquote><p><code>libuv</code> provides asynchronous DNS resolution. For this it provides its own <code>getaddrinfo</code> replacement [3]. In the callback you can perform normal socket operations on the retrieved addresses. Let&rsquo;s connect to Libera.chat to see an example of DNS resolution.</p><p>[3] - <code>libuv</code> use the system <code>getaddrinfo</code> in the <code>libuv</code> threadpool.</p></blockquote><p><a href=https://github.com/libuv/libuv/blob/76f7fb26b9ac8ede4406fa786acb7480d9b48ff5/src/unix/getaddrinfo.c#L98-L105 target=_blank rel=noopener>Code</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>uv__getaddrinfo_work</span>(<span style=color:#66d9ef>struct</span> uv__work<span style=color:#f92672>*</span> w) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>uv_getaddrinfo_t</span><span style=color:#f92672>*</span> req;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> err;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  req <span style=color:#f92672>=</span> <span style=color:#a6e22e>container_of</span>(w, <span style=color:#66d9ef>uv_getaddrinfo_t</span>, work_req);
</span></span><span style=display:flex><span>  err <span style=color:#f92672>=</span> <span style=color:#a6e22e>getaddrinfo</span>(req<span style=color:#f92672>-&gt;</span>hostname, req<span style=color:#f92672>-&gt;</span>service, req<span style=color:#f92672>-&gt;</span>hints, <span style=color:#f92672>&amp;</span>req<span style=color:#f92672>-&gt;</span>addrinfo);
</span></span><span style=display:flex><span>  req<span style=color:#f92672>-&gt;</span>retcode <span style=color:#f92672>=</span> <span style=color:#a6e22e>uv__getaddrinfo_translate_error</span>(err);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=852-happy-eyeballs>8.5.2 Happy Eyeballs
<a class=anchor href=#852-happy-eyeballs>#</a></h3><p>There is ongoing discussion about adding a basic support in <a href=https://github.com/nodejs/node/issues/48145 target=_blank rel=noopener>https://github.com/nodejs/node/issues/48145</a>.</p><a href=/docs/resolver-dual-stack-application/9-dual-stack-software-examples/ class="book-btn right-button">Read next chapter →</a></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#8-stub-resolvers-in-languages>8. Stub resolvers in languages</a><ul><li><a href=#81-python>8.1 Python</a><ul><li><a href=#811--stub-resolvers>8.1.1 Stub resolvers</a></li><li><a href=#812-happy-eyeballs>8.1.2 Happy Eyeballs</a></li></ul></li><li><a href=#82-go-golang>8.2 Go (golang)</a><ul><li><a href=#821-resolver>8.2.1 Resolver</a></li><li><a href=#822-happy-eyeballs>8.2.2 Happy Eyeballs</a></li></ul></li><li><a href=#83-rust>8.3 Rust</a><ul><li><a href=#831-resolver>8.3.1 Resolver</a></li><li><a href=#832-happy-eyeballs>8.3.2 Happy Eyeballs</a></li></ul></li><li><a href=#84-java-and-netty>8.4 Java and Netty</a><ul><li><a href=#841-resolver>8.4.1 Resolver</a></li><li><a href=#842-java-securitymanager>8.4.2 Java SecurityManager</a></li><li><a href=#843-happy-eyeballs>8.4.3 Happy eyeballs</a></li></ul></li><li><a href=#85-nodejs>8.5 Node.js</a><ul><li><a href=#851-resoler>8.5.1 Resoler</a></li><li><a href=#852-happy-eyeballs>8.5.2 Happy Eyeballs</a></li></ul></li></ul></li></ul></nav></div></aside></main><div class=cookie-container><p>This website uses "<b>cookies</b>".
Using this website means you're OK with this.
If you are <b>NOT</b>, please close the site page.</p><button class=cookie-btn>
ACCEPT AND CLOSE</button></div><script src=/my_js/cookie.js></script></body></html>