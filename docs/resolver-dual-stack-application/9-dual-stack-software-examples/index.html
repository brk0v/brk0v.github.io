<!doctype html><html lang=en-us dir=ltr><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="9. Dual-stack software examples # 9.1 Nginx # Nginx treats the hostname as a set of distinct entries rather than multiple paths to the same host. From the upstream module doc:
A domain name that resolves to several IP addresses defines multiple servers at once.
On start Nginx resolves all hostnames using its static resolver with getaddrinfo() and the AF_UNSPEC and the AI_ADDRCONFIG flags.
ngx_int_t ngx_inet_resolve_host(ngx_pool_t *pool, ngx_url_t *u) { ."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="http://localhost:1313/docs/resolver-dual-stack-application/9-dual-stack-software-examples/"><meta property="og:site_name" content="Viacheslav Biriukov"><meta property="og:title" content="Dual-stack software examples"><meta property="og:description" content="9. Dual-stack software examples # 9.1 Nginx # Nginx treats the hostname as a set of distinct entries rather than multiple paths to the same host. From the upstream module doc:
A domain name that resolves to several IP addresses defines multiple servers at once.
On start Nginx resolves all hostnames using its static resolver with getaddrinfo() and the AF_UNSPEC and the AI_ADDRCONFIG flags.
ngx_int_t ngx_inet_resolve_host(ngx_pool_t *pool, ngx_url_t *u) { ."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><title>Dual-stack software examples | Viacheslav Biriukov</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png><link rel=stylesheet href=/book.min.33a48f5432973b8ff9a82679d9e45d67f2c15d4399bd2829269455cfe390b5e8.css integrity="sha256-M6SPVDKXO4/5qCZ52eRdZ/LBXUOZvSgpJpRVz+OQteg=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script><script defer src=/en.search.min.1d41906aaf37198c05e8bca85b15248be7d2a4850e770874fce9182253d6a51a.js integrity="sha256-HUGQaq83GYwF6LyoWxUki+fSpIUOdwh0/OkYIlPWpRo=" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-599VSLESJL"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-599VSLESJL")</script><link rel=stylesheet href=/my_css/cookie.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Viacheslav Biriukov</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li class=book-section-flat><span>DNS resolvers and Dual-Stack applications</span><ul><li><a href=/docs/resolver-dual-stack-application/0-sre-should-know-about-gnu-linux-resolvers-and-dual-stack-applications/>Resolvers and Dual-Stack applications for SRE</a></li><li><a href=/docs/resolver-dual-stack-application/1-what-is-a-stub-resolver/>1. What is a stub resolver?</a></li><li><a href=/docs/resolver-dual-stack-application/2-history-gethostbyname/>2. History: gethostbyname()</a></li><li><a href=/docs/resolver-dual-stack-application/3-getaddrinfo-and-posix-spec/>3. getaddrinfo() and POSIX spec</a></li><li><a href=/docs/resolver-dual-stack-application/4-getaddrinfo-from-glibc/>4. getaddrinfo() from glibc</a></li><li><a href=/docs/resolver-dual-stack-application/5-getaddrinfo-from-musl-libc/>5. getaddrinfo() from musl libc</a></li><li><a href=/docs/resolver-dual-stack-application/6-dual-stack-applications/>6. Dual-Stack applications</a></li><li><a href=/docs/resolver-dual-stack-application/7-async-non-blocking-resolvers-in-c/>7. C async non-blocking resolvers</a></li><li><a href=/docs/resolver-dual-stack-application/8-stub-resolvers-in-languages/>8. Stub resolvers in languages</a></li><li><a href=/docs/resolver-dual-stack-application/9-dual-stack-software-examples/ class=active>9. Dual-stack software examples</a></li><li><a href=/docs/resolver-dual-stack-application/10-systemd-resolved/>10. systemd-resolved</a></li><li><a href=/docs/resolver-dual-stack-application/11-querying-nameservers-on-dual-stack-hosts/>11. Querying Nameservers</a></li><li><a href=/docs/resolver-dual-stack-application/12-present-and-future-of-resolvers-and-dns-related-features/>12. Present and future</a></li><li><a href=/docs/resolver-dual-stack-application/troubleshooting-tools-for-resolvers-and-dns/>Troubleshooting tools</a></li></ul></li></ul><div style=margin-top:30px;margin-bottom:30px><b>More post series:</b><ul><li><a href=/docs/fd-pipe-session-terminal/0-sre-should-know-about-gnu-linux-shell-related-internals-file-descriptors-pipes-terminals-user-sessions-process-groups-and-daemons>1. File descriptors, pipes, terminals, user sessions, process groups and daemons</li><li><a href=/docs/page-cache/0-linux-page-cache-for-sre/>2. Linux Page Cache mini book</li><li><a href=/docs/resolver-dual-stack-application/0-sre-should-know-about-gnu-linux-resolvers-and-dual-stack-applications/>3. Resolvers and Dual-Stack applications <span style="padding:0 2px;border-radius:2px;background-color:#e84118;color:#f0f8ff">new</span></li></ul></div><ul><li><a href=https://twitter.com/brk0v/ target=_blank rel=noopener><i class="bi bi-twitter"></i>
Twitter</a></li><li><a href=https://www.linkedin.com/in/biriukov/ target=_blank rel=noopener><i class="bi bi-linkedin"></i>
Linkedin</a></li><li><a href=https://github.com/brk0v/ target=_blank rel=noopener><i class="bi bi-github"></i>
Github</a></li></ul><div style=margin-top:30px><p xmlns:cc=http://creativecommons.org/ns#>This content is licensed under
<a href="http://creativecommons.org/licenses/by-nc/4.0/?ref=chooser-v1" target=_blank rel="license noopener noreferrer" style=display:inline-block>CC BY-NC 4.0<img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1"><img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"><img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1"></a></p></div></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Dual-stack software examples</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#9-dual-stack-software-examples>9. Dual-stack software examples</a><ul><li><a href=#91-nginx>9.1 Nginx</a></li><li><a href=#92-envoy-proxy>9.2 Envoy proxy</a></li><li><a href=#93-haproxy>9.3 <code>HAProxy</code></a></li></ul></li></ul></nav></aside></header><article class="markdown book-article"><h1 id=9-dual-stack-software-examples>9. Dual-stack software examples
<a class=anchor href=#9-dual-stack-software-examples>#</a></h1><h2 id=91-nginx>9.1 Nginx
<a class=anchor href=#91-nginx>#</a></h2><p><code>Nginx</code> treats the hostname as a set of distinct entries rather than multiple paths to the same host. From the upstream module <a href=https://nginx.org/en/docs/http/ngx_http_upstream_module.html#server target=_blank rel=noopener>doc</a>:</p><blockquote><p>A domain name that resolves to several IP addresses defines multiple servers at once.</p></blockquote><p>On start <code>Nginx</code> resolves all hostnames using its <a href=https://github.com/nginx/nginx/blob/145b228530c364452c14d3184f1eee5e09b324aa/src/core/ngx_inet.c#L1117 target=_blank rel=noopener>static resolver</a> with <code>getaddrinfo()</code> and the <code>AF_UNSPEC</code> and the <code>AI_ADDRCONFIG</code> flags.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>ngx_int_t</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ngx_inet_resolve_host</span>(<span style=color:#66d9ef>ngx_pool_t</span> <span style=color:#f92672>*</span>pool, <span style=color:#66d9ef>ngx_url_t</span> <span style=color:#f92672>*</span>u)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>hints.ai_family <span style=color:#f92672>=</span> AF_UNSPEC;
</span></span><span style=display:flex><span>    hints.ai_socktype <span style=color:#f92672>=</span> SOCK_STREAM;
</span></span><span style=display:flex><span><span style=color:#75715e>#ifdef AI_ADDRCONFIG
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    hints.ai_flags <span style=color:#f92672>=</span> AI_ADDRCONFIG;
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>getaddrinfo</span>((<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>) host, NULL, <span style=color:#f92672>&amp;</span>hints, <span style=color:#f92672>&amp;</span>res) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        u<span style=color:#f92672>-&gt;</span>err <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;host not found&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ngx_free</span>(host);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> NGX_ERROR;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>   ...
</span></span></code></pre></div><p>If you have a paid Plus version of <code>Nginx</code> or use a <a href=https://docs.wallarm.com/admin-en/configure-dynamic-dns-resolution-nginx target=_blank rel=noopener>workaround with a variable</a> in <code>proxy_pass</code>, <code>Nginx </code>can periodically update in memory resolution cache. In order to enable it, you need to specify the <a href=https://nginx.org/en/docs/http/ngx_http_core_module.html#resolver target=_blank rel=noopener>global resolver</a> first:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>resolver address ... <span style=color:#f92672>[</span>valid<span style=color:#f92672>=</span>time<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>ipv4<span style=color:#f92672>=</span>on|off<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>ipv6<span style=color:#f92672>=</span>on|off<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>status_zone<span style=color:#f92672>=</span>zone<span style=color:#f92672>]</span>;
</span></span></code></pre></div><p>The name resolving happens in <code><a href=https://github.com/nginx/nginx/blob/145b228530c364452c14d3184f1eee5e09b324aa/src/core/ngx_resolver.c#L605C1-L608C2 target=_blank rel=noopener>ngx_resolver.c</a></code>, which support <code>A</code>, <code>AAAA</code>, <code>CNAME</code> and <code>SRV</code> records (only in paid version):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>ngx_int_t</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ngx_resolve_name_locked</span>(<span style=color:#66d9ef>ngx_resolver_t</span> <span style=color:#f92672>*</span>r, <span style=color:#66d9ef>ngx_resolver_ctx_t</span> <span style=color:#f92672>*</span>ctx,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ngx_str_t</span> <span style=color:#f92672>*</span>name)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>…</span> 
</span></span><span style=display:flex><span>   addrs <span style=color:#f92672>=</span> <span style=color:#a6e22e>ngx_resolver_export</span>(r, rn, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>…</span>
</span></span></code></pre></div><p>The resolver randomly <a href=https://github.com/nginx/nginx/blob/145b228530c364452c14d3184f1eee5e09b324aa/src/core/ngx_resolver.c#L4219C1-L4222C2 target=_blank rel=noopener>rotate</a> the addresses artificially implementing round-robin DNS:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>ngx_resolver_addr_t</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ngx_resolver_export</span>(<span style=color:#66d9ef>ngx_resolver_t</span> <span style=color:#f92672>*</span>r, <span style=color:#66d9ef>ngx_resolver_node_t</span> <span style=color:#f92672>*</span>rn,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ngx_uint_t</span> rotate)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>…</span>
</span></span><span style=display:flex><span>    d <span style=color:#f92672>=</span> rotate <span style=color:#f92672>?</span> <span style=color:#a6e22e>ngx_random</span>() <span style=color:#f92672>%</span> n : <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>…</span>
</span></span></code></pre></div><p>Because <code>Nginx</code> handles each address of a hostname as multiple servers, the returned IPv6 addresses are treated as completely independent servers rather than alternative ways to reach the same host. As a result, Nginx does not support the Happy Eyeballs algorithm or sorting by destination address selection rules.</p><p>The addresses in <a href=https://nginx.org/en/docs/http/ngx_http_upstream_module.html#upstream target=_blank rel=noopener>upstreams</a> are selected in a round-robin fashion.</p><blockquote><p>By default, requests are distributed between the servers using a weighted round-robin balancing method.</p></blockquote><p>The round-robin pear is created in <code><a href=https://github.com/nginx/nginx/blob/145b228530c364452c14d3184f1eee5e09b324aa/src/http/ngx_http_upstream_round_robin.c#L312 target=_blank rel=noopener>ngx_http_upstream_create_round_robin_peer</a>()</code> function from the resolver answer:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>ngx_int_t</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ngx_http_upstream_create_round_robin_peer</span>(<span style=color:#66d9ef>ngx_http_request_t</span> <span style=color:#f92672>*</span>r,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ngx_http_upstream_resolved_t</span> <span style=color:#f92672>*</span>ur)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>…</span>
</span></span></code></pre></div><p>The playground to play with the local <code>Nginx</code> and dynamic resolver via a <code>prorxy_pass</code> variable.</p><p>In order to control resolver we need to install our own DNS server. I suggest using <a href=https://coredns.io/ target=_blank rel=noopener>CoreDNS</a>, as it’s simple and powerful for our needs:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ wget https://github.com/coredns/coredns/releases/download/v1.11.1/coredns_1.11.1_linux_arm64.tgz
</span></span><span style=display:flex><span>$ tar -zxf coredns_1.11.1_linux_arm64.tgz
</span></span></code></pre></div><p>Its config file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat Corefile
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>test.example <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        bind 127.0.0.153
</span></span><span style=display:flex><span>        loadbalance round_robin
</span></span><span style=display:flex><span>        file test.example.db
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Zone file for <code>test.example</code> domain:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat test.example.db
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ORIGIN test.example.
</span></span><span style=display:flex><span>@       <span style=color:#ae81ff>3600</span> IN SOA sns.dns.icann.org. noc.dns.icann.org. <span style=color:#ae81ff>2017042745</span> <span style=color:#ae81ff>7200</span> <span style=color:#ae81ff>3600</span> <span style=color:#ae81ff>1209600</span> <span style=color:#ae81ff>3600</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>site    IN      A       192.168.5.15
</span></span><span style=display:flex><span>        IN      AAAA    ::1
</span></span><span style=display:flex><span>        IN      AAAA    fec0::5055:55ff:fe8e:3d07
</span></span></code></pre></div><p>where:</p><ul><li><code>192.168.5.15</code> – local container IPv4 address</li><li><code>fec0::5055:55ff:fe8e:3d07</code> – local container IPv6 unique local address (<a href=https://en.wikipedia.org/wiki/Unique_local_address target=_blank rel=noopener>ULA</a>).</li></ul><blockquote class="book-hint warning"><code>Nginx</code> doesn&rsquo;t have link-local IPv6 address support for backends, so please don’t use them.</blockquote><p>Run it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo ./coredns
</span></span></code></pre></div><p><code>Nginx</code> test config:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>worker_processes auto;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>events <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    worker_connections 1024;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pid /tmp/nginx.pid;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>http <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Use a DNS resolver to resolve the backend host</span>
</span></span><span style=display:flex><span>    resolver 127.0.0.153 valid<span style=color:#f92672>=</span>5s;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    access_log /tmp/access.log;
</span></span><span style=display:flex><span>    error_log /tmp/error.log debug;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    server <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        listen 80;
</span></span><span style=display:flex><span>        server_name site.test.example;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        location / <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>            set $backend_service <span style=color:#e6db74>&#34;site.test.example:8080&#34;</span>;
</span></span><span style=display:flex><span>            <span style=color:#75715e># Proxy to the dynamically resolved backend service</span>
</span></span><span style=display:flex><span>            proxy_pass http://$backend_service;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Pass host headers</span>
</span></span><span style=display:flex><span>            proxy_set_header Host $host;
</span></span><span style=display:flex><span>            proxy_set_header X-Real-IP $remote_addr;
</span></span><span style=display:flex><span>            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span></span><span style=display:flex><span>            proxy_set_header X-Forwarded-Proto $scheme;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Handle timeouts and retries</span>
</span></span><span style=display:flex><span>            proxy_connect_timeout 10s;
</span></span><span style=display:flex><span>            proxy_send_timeout 10s;
</span></span><span style=display:flex><span>            proxy_read_timeout 10s;
</span></span><span style=display:flex><span>            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e># Optional: Additional settings to improve proxy performance and security</span>
</span></span><span style=display:flex><span>            proxy_buffering on;
</span></span><span style=display:flex><span>            proxy_buffer_size 16k;
</span></span><span style=display:flex><span>            proxy_buffers <span style=color:#ae81ff>32</span> 16k;
</span></span><span style=display:flex><span>            proxy_busy_buffers_size 64k;
</span></span><span style=display:flex><span>            proxy_max_temp_file_size 64k;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>    default_type application/octet-stream;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Gzip settings</span>
</span></span><span style=display:flex><span>    gzip on;
</span></span><span style=display:flex><span>    gzip_vary on;
</span></span><span style=display:flex><span>    gzip_proxied any;
</span></span><span style=display:flex><span>    gzip_comp_level 6;
</span></span><span style=display:flex><span>    gzip_buffers <span style=color:#ae81ff>16</span> 8k;
</span></span><span style=display:flex><span>    gzip_http_version 1.1;
</span></span><span style=display:flex><span>    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Run a dummy backend with <code>python</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 -m http.server <span style=color:#ae81ff>8080</span> --bind ::
</span></span></code></pre></div><p>And make some requests in another terminal window:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#66d9ef>while</span> true; <span style=color:#66d9ef>do</span> curl 127.0.0.1; <span style=color:#66d9ef>done</span>
</span></span></code></pre></div><p>In the console with the <code>python</code> simple server you should see something similar, which shows the usage of round-robin algorithm:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>fec0::5055:55ff:fe8e:3d07 - - <span style=color:#f92672>[</span>01/Aug/2024 09:49:11<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET / HTTP/1.0&#34;</span> <span style=color:#ae81ff>200</span> -
</span></span><span style=display:flex><span>::ffff:192.168.5.15 - - <span style=color:#f92672>[</span>01/Aug/2024 09:49:11<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET / HTTP/1.0&#34;</span> <span style=color:#ae81ff>200</span> -
</span></span><span style=display:flex><span>::1 - - <span style=color:#f92672>[</span>01/Aug/2024 09:49:11<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET / HTTP/1.0&#34;</span> <span style=color:#ae81ff>200</span> -
</span></span><span style=display:flex><span>fec0::5055:55ff:fe8e:3d07 - - <span style=color:#f92672>[</span>01/Aug/2024 09:49:11<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET / HTTP/1.0&#34;</span> <span style=color:#ae81ff>200</span> -
</span></span><span style=display:flex><span>::1 - - <span style=color:#f92672>[</span>01/Aug/2024 09:49:11<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET / HTTP/1.0&#34;</span> <span style=color:#ae81ff>200</span> -
</span></span><span style=display:flex><span>fec0::5055:55ff:fe8e:3d07 - - <span style=color:#f92672>[</span>01/Aug/2024 09:49:11<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET / HTTP/1.0&#34;</span> <span style=color:#ae81ff>200</span> -
</span></span><span style=display:flex><span>::1 - - <span style=color:#f92672>[</span>01/Aug/2024 09:49:11<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET / HTTP/1.0&#34;</span> <span style=color:#ae81ff>200</span> -
</span></span><span style=display:flex><span>::1 - - <span style=color:#f92672>[</span>01/Aug/2024 09:49:11<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET / HTTP/1.0&#34;</span> <span style=color:#ae81ff>200</span> -
</span></span><span style=display:flex><span>::ffff:192.168.5.15 - - <span style=color:#f92672>[</span>01/Aug/2024 09:49:11<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET / HTTP/1.0&#34;</span> <span style=color:#ae81ff>200</span> -
</span></span><span style=display:flex><span>::1 - - <span style=color:#f92672>[</span>01/Aug/2024 09:49:11<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET / HTTP/1.0&#34;</span> <span style=color:#ae81ff>200</span> -
</span></span><span style=display:flex><span>::1 - - <span style=color:#f92672>[</span>01/Aug/2024 09:49:11<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET / HTTP/1.0&#34;</span> <span style=color:#ae81ff>200</span> -
</span></span><span style=display:flex><span>::ffff:192.168.5.15 - - <span style=color:#f92672>[</span>01/Aug/2024 09:49:11<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET / HTTP/1.0&#34;</span> <span style=color:#ae81ff>200</span> -
</span></span><span style=display:flex><span>::1 - - <span style=color:#f92672>[</span>01/Aug/2024 09:49:11<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET / HTTP/1.0&#34;</span> <span style=color:#ae81ff>200</span> -
</span></span></code></pre></div><p>In the <code>tcpdump</code> you can see periodic refresh of addresses:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo tcpdump -s0 -i any -n -A host 127.0.0.153
</span></span><span style=display:flex><span>09:53:16.002276 lo    In  IP 127.0.0.1.48587 &gt; 127.0.0.153.53: 21998+ A? site.test.example. <span style=color:#f92672>(</span>35<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>09:53:16.002288 lo    In  IP 127.0.0.1.48587 &gt; 127.0.0.153.53: 19029+ AAAA? site.test.example. <span style=color:#f92672>(</span>35<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>09:53:16.002394 lo    In  IP 127.0.0.153.53 &gt; 127.0.0.1.48587: 19029*- 2/0/0 AAAA ::1, AAAA fec0::5055:55ff:fe8e:3d07 <span style=color:#f92672>(</span>125<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>09:53:16.002422 lo    In  IP 127.0.0.153.53 &gt; 127.0.0.1.48587: 21998*- 1/0/0 A 192.168.5.15 <span style=color:#f92672>(</span>68<span style=color:#f92672>)</span>
</span></span></code></pre></div><h2 id=92-envoy-proxy>9.2 Envoy proxy
<a class=anchor href=#92-envoy-proxy>#</a></h2><p>The default resolver in <code>Envoy</code> for GNU/Linux is <code>c-ares</code>. <code>Envoy</code> is built statically, so the simplest way to determine the version of <code>c-ares</code>, is to check the <code>bazel</code> <code><a href=https://github.com/envoyproxy/envoy/blob/main/bazel/repository_locations.bzl target=_blank rel=noopener>repository_locations.bzl</a></code> file.</p><blockquote class="book-hint info">We will be reviewing Envoy with the <code><a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/service_discovery#arch-overview-service-discovery-types-logical-dns target=_blank rel=noopener>Logical DNS</a></code> option set for its <code>cluster</code> <code><a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#enum-config-cluster-v3-cluster-discoverytype target=_blank rel=noopener>config.cluster.v3.Cluster.DiscoveryType</a></code>, because it is the general case and the most used one.</blockquote><p>The best place to start learning and configuring the stub resolve is <code><a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto.html#envoy-v3-api-enum-config-cluster-v3-cluster-dnslookupfamily target=_blank rel=noopener>config.cluster.v3.Cluster.DnsLookupFamily</a></code> option:</p><blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Enum config.cluster.v3.Cluster.DnsLookupFamily
</span></span></code></pre></div><p>When <code>V4_ONLY</code> is selected, the DNS resolver will only perform a lookup for addresses in the IPv4 family. If <code>V6_ONLY</code> is selected, the DNS resolver will only perform a lookup for addresses in the IPv6 family. If <code>AUTO</code> is specified, the DNS resolver will first perform a lookup for addresses in the IPv6 family and fallback to a lookup for addresses in the IPv4 family. This is semantically equivalent to a non-existent <code>V6_PREFERRED</code> option. <code>AUTO</code> is a legacy name that is more opaque than necessary and will be deprecated in favor of <code>V6_PREFERRED</code> in a future major version of the API. If <code>V4_PREFERRED</code> is specified, the DNS resolver will first perform a lookup for addresses in the IPv4 family and fallback to a lookup for addresses in the IPv6 family. i.e., the callback target will only get v6 addresses if there were NO v4 addresses to return. If <code>ALL</code> is specified, the DNS resolver will perform a lookup for both IPv4 and IPv6 families, and return all resolved addresses. When this is used, Happy Eyeballs will be enabled for upstream connections.</p></blockquote><p>The translation into the <code>C</code> socket address family is happening in <code><a href=https://github.com/envoyproxy/envoy/blob/34bdb945cb8a77630363659c24baf21e9aaf891f/source/extensions/network/dns_resolver/cares/dns_impl.cc#L448C1-L460C4 target=_blank rel=noopener>cares/dns_impl.cc</a></code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>  <span style=color:#66d9ef>switch</span> (dns_lookup_family_) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> DnsLookupFamily<span style=color:#f92672>::</span>V4Only:
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> DnsLookupFamily<span style=color:#f92672>::</span>V4Preferred:
</span></span><span style=display:flex><span>    family_ <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> DnsLookupFamily<span style=color:#f92672>::</span>V6Only:
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> DnsLookupFamily<span style=color:#f92672>::</span>Auto:
</span></span><span style=display:flex><span>    family_ <span style=color:#f92672>=</span> AF_INET6;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> DnsLookupFamily<span style=color:#f92672>::</span>All:
</span></span><span style=display:flex><span>    family_ <span style=color:#f92672>=</span> AF_UNSPEC;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>An important clarification regarding the <code>DnsLookupFamily</code> configuration is that the second fallback resolver call occurs only if there is a resolver-related error or a ‘not found’ response. This means that if you have the default <code>DnsLookupFamily</code> setting (which prefers IPv6), and the resolver returns an <code>AAAA</code> record, but your network routing is broken, there will be no retry for an <code>A</code> address. The same behavior applies when <code>DnsLookupFamily</code> is set to <code>V4_PREFERRED</code>.</p><p>The retry code is in <code><a href=https://github.com/envoyproxy/envoy/blob/34bdb945cb8a77630363659c24baf21e9aaf891f/source/extensions/network/dns_resolver/cares/dns_impl.cc#L288C1-L297C6 target=_blank rel=noopener>dns_impl.cc</a></code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>   <span style=color:#75715e>// Perform a second lookup for DnsLookupFamily::Auto and DnsLookupFamily::V4Preferred, given
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// that the first lookup failed to return any addresses. Note that DnsLookupFamily::All issues
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// both lookups concurrently so there is no need to fire a second lookup here.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (dns_lookup_family_ <span style=color:#f92672>==</span> DnsLookupFamily<span style=color:#f92672>::</span>Auto) {
</span></span><span style=display:flex><span>      family_ <span style=color:#f92672>=</span> AF_INET;
</span></span><span style=display:flex><span>      startResolutionImpl(AF_INET);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (dns_lookup_family_ <span style=color:#f92672>==</span> DnsLookupFamily<span style=color:#f92672>::</span>V4Preferred) {
</span></span><span style=display:flex><span>      family_ <span style=color:#f92672>=</span> AF_INET6;
</span></span><span style=display:flex><span>      startResolutionImpl(AF_INET6);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>To help dealing with such errors you can think of using the <code><a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/extensions/network/dns_resolver/cares/v3/cares_dns_resolver.proto#envoy-v3-api-msg-extensions-network-dns-resolver-cares-v3-caresdnsresolverconfig target=_blank rel=noopener>filter_unroutable_families</a></code> option. But there is a trick.</p><blockquote><p><code>filter_unroutable_families</code></p><p>(<code>bool</code>) The resolver will query available network interfaces and determine if there are no available interfaces for a given IP family. It will then filter these addresses from the results it presents. e.g., if there are no available IPv4 network interfaces, the resolver will not provide IPv4 addresses.</p></blockquote><p>The trick is, it suffers from the same issue we identified earlier with the <code>AI_ADDRCONFIG</code> flag in <code>getaddrinfo()</code>: it considers any IPv6 address – except for localhost – as a cue to greenlight <code>AAAA</code> stub resolver queries. This means all link-local and unique local addresses are included and treated as votes for the IPv6 stack. Therefore, this option is really useful for IPv6-only hosts with a completely disabled IPv4 stack or IPv4-only with completely disabled IPv6.</p><p>The whole filtering is happening in <code><a href=https://github.com/envoyproxy/envoy/blob/34bdb945cb8a77630363659c24baf21e9aaf891f/source/extensions/network/dns_resolver/cares/dns_impl.cc#L221 target=_blank rel=noopener>DnsResolverImpl::AddrInfoPendingResolution::onAresGetAddrInfoCallback</a></code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (addrinfo <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nullptr</span> <span style=color:#f92672>&amp;&amp;</span> addrinfo<span style=color:#f92672>-&gt;</span>nodes <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nullptr</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>bool</span> can_process_v4 <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>          (<span style=color:#f92672>!</span>parent_.filter_unroutable_families_ <span style=color:#f92672>||</span> available_interfaces_.v4_available_);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>bool</span> can_process_v6 <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>          (<span style=color:#f92672>!</span>parent_.filter_unroutable_families_ <span style=color:#f92672>||</span> available_interfaces_.v6_available_);
</span></span></code></pre></div><p>The <code>v4_available_</code> and <code>v6_available_</code> are set in <code><a href=https://github.com/envoyproxy/envoy/blob/34bdb945cb8a77630363659c24baf21e9aaf891f/source/extensions/network/dns_resolver/cares/dns_impl.cc#L532-L557 target=_blank rel=noopener>dns_impl.cc</a></code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>auto</span><span style=color:#f92672>&amp;</span> interface_address : interface_addresses) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>interface_address.interface_addr_<span style=color:#f92672>-&gt;</span>ip()) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (Network<span style=color:#f92672>::</span>Utility<span style=color:#f92672>::</span>isLoopbackAddress(<span style=color:#f92672>*</span>interface_address.interface_addr_)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (interface_address.interface_addr_<span style=color:#f92672>-&gt;</span>ip()<span style=color:#f92672>-&gt;</span>version()) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> Network<span style=color:#f92672>::</span>Address<span style=color:#f92672>::</span>IpVersion<span style=color:#f92672>::</span>v4:
</span></span><span style=display:flex><span>      available_interfaces.v4_available_ <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (available_interfaces.v6_available_) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> available_interfaces;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> Network<span style=color:#f92672>::</span>Address<span style=color:#f92672>::</span>IpVersion<span style=color:#f92672>::</span>v6:
</span></span><span style=display:flex><span>      available_interfaces.v6_available_ <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (available_interfaces.v4_available_) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> available_interfaces;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> available_interfaces;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>where the only filtering happens for <code>localhost</code>s in <code><a href=https://github.com/envoyproxy/envoy/blob/f7e5b594cff7de14a4cbea3e66a4be3786660686/source/common/network/utility.cc#L303-L319 target=_blank rel=noopener>common/network/utility.cc</a></code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>bool</span> Utility<span style=color:#f92672>::</span>isLoopbackAddress(<span style=color:#66d9ef>const</span> Address<span style=color:#f92672>::</span>Instance<span style=color:#f92672>&amp;</span> address) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (address.type() <span style=color:#f92672>!=</span> Address<span style=color:#f92672>::</span>Type<span style=color:#f92672>::</span>Ip) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (address.ip()<span style=color:#f92672>-&gt;</span>version() <span style=color:#f92672>==</span> Address<span style=color:#f92672>::</span>IpVersion<span style=color:#f92672>::</span>v4) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Compare to the canonical v4 loopback address: 127.0.0.1.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> address.ip()<span style=color:#f92672>-&gt;</span>ipv4()<span style=color:#f92672>-&gt;</span>address() <span style=color:#f92672>==</span> htonl(INADDR_LOOPBACK);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (address.ip()<span style=color:#f92672>-&gt;</span>version() <span style=color:#f92672>==</span> Address<span style=color:#f92672>::</span>IpVersion<span style=color:#f92672>::</span>v6) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static_assert</span>(<span style=color:#66d9ef>sizeof</span>(absl<span style=color:#f92672>::</span>uint128) <span style=color:#f92672>==</span> <span style=color:#66d9ef>sizeof</span>(in6addr_loopback),
</span></span><span style=display:flex><span>                  <span style=color:#e6db74>&#34;sizeof(absl::uint128) != sizeof(in6addr_loopback)&#34;</span>);
</span></span><span style=display:flex><span>    absl<span style=color:#f92672>::</span>uint128 addr <span style=color:#f92672>=</span> address.ip()<span style=color:#f92672>-&gt;</span>ipv6()<span style=color:#f92672>-&gt;</span>address();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>==</span> memcmp(<span style=color:#f92672>&amp;</span>addr, <span style=color:#f92672>&amp;</span>in6addr_loopback, <span style=color:#66d9ef>sizeof</span>(in6addr_loopback));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  IS_ENVOY_BUG(<span style=color:#e6db74>&#34;unexpected address type&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>So the real solution for the dual stack upstreams or seamlessly migrating to IPv6 only backends is to enable the <a href=https://datatracker.ietf.org/doc/html/rfc8305 target=_blank rel=noopener>Happy Eyeballs algorithm</a> which is <a href=https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/upstream/connection_pooling#arch-overview-happy-eyeballs target=_blank rel=noopener>supported</a> by setting <code>DnsLookupFamily</code> to <code>ALL</code>.</p><p>The code is in <code><a href=https://github.com/envoyproxy/envoy/blob/main/source/common/network/happy_eyeballs_connection_impl.cc target=_blank rel=noopener>source/common/network/happy_eyeballs_connection_impl.cc</a></code>.</p><p>One interesting observation is that Envoy violates <a href=https://datatracker.ietf.org/doc/html/rfc8305#section-4 target=_blank rel=noopener>section 4</a> of the Happy Eyeballs RFC by not sorting addresses before initiating connections.</p><blockquote><p>First, the client MUST sort the addresses received up to this point using Destination Address Selection (<a href=https://datatracker.ietf.org/doc/html/rfc6724#section-6 target=_blank rel=noopener>[RFC6724], Section 6</a>).</p></blockquote><p>But in the <a href=https://github.com/envoyproxy/envoy/blob/7b8132ac125d9bd64089d65e3c5396e7aab2fde9/source/extensions/network/dns_resolver/cares/dns_impl.cc#L497C1-L509C13 target=_blank rel=noopener>source/extensions/network/dns_resolver/cares/dns_impl.cc</a> we can how <code>c-ares</code> is called with disabled sorting:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span>  <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * ARES_AI_NOSORT result addresses will not be sorted and no connections to resolved addresses
</span></span></span><span style=display:flex><span><span style=color:#75715e>   * will be attempted
</span></span></span><span style=display:flex><span><span style=color:#75715e>   */</span>
</span></span><span style=display:flex><span>  hints.ai_flags <span style=color:#f92672>=</span> ARES_AI_NOSORT;
</span></span></code></pre></div><p>The justification is to increase performance due to fewer system calls.</p><p>However Envoy has its own <a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-msg-config-cluster-v3-upstreamconnectionoptions-happyeyeballsconfig target=_blank rel=noopener>settings</a> to control its own sorting for Happy Eyeballs:</p><blockquote><p><code>first_address_family_version</code></p><p>(<a href=https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/cluster/v3/cluster.proto#envoy-v3-api-enum-config-cluster-v3-upstreamconnectionoptions-firstaddressfamilyversion target=_blank rel=noopener>config.cluster.v3.UpstreamConnectionOptions.FirstAddressFamilyVersion</a>) Specify the IP address family to attempt connection first in happy eyeballs algorithm according to RFC8305#section-4.</p><p><code>first_address_family_count</code></p><p>(<a href=https://developers.google.com/protocol-buffers/docs/reference/google.protobuf#uint32value target=_blank rel=noopener>UInt32Value</a>) Specify the number of addresses of the <code>first_address_family_version</code> being attempted for connection before the other address family.</p></blockquote><p>The full config to play with <code>Envoy</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>static_resources</span>:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>listeners</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>listener_0</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>address</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>socket_address</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>address</span>: <span style=color:#e6db74>&#34;::&#34;</span> 
</span></span><span style=display:flex><span>        <span style=color:#f92672>port_value</span>: <span style=color:#ae81ff>10000</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>ipv4_compat</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>filter_chains</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>filters</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>envoy.filters.network.http_connection_manager</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>typed_config</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>&#34;@type&#34;: </span><span style=color:#ae81ff>type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>stat_prefix</span>: <span style=color:#ae81ff>ingress_http</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>access_log</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>envoy.access_loggers.stdout</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>typed_config</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;@type&#34;: </span><span style=color:#ae81ff>type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>log_format</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>text_format</span>: <span style=color:#e6db74>&#34;%START_TIME% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% %REQ(:METHOD)% %REQ(X-FORWARDED-FOR?:REMOTE_ADDRESS)% %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %UPSTREAM_HOST%\n&#34;</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>http_filters</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>envoy.filters.http.router</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>typed_config</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>&#34;@type&#34;: </span><span style=color:#ae81ff>type.googleapis.com/envoy.extensions.filters.http.router.v3.Router</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>route_config</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>name</span>: <span style=color:#ae81ff>local_route</span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>virtual_hosts</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>local_service</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>domains</span>: [<span style=color:#e6db74>&#34;*&#34;</span>]
</span></span><span style=display:flex><span>              <span style=color:#f92672>routes</span>:
</span></span><span style=display:flex><span>              - <span style=color:#f92672>match</span>:
</span></span><span style=display:flex><span>                  <span style=color:#f92672>prefix</span>: <span style=color:#e6db74>&#34;/&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>route</span>:
</span></span><span style=display:flex><span>                  <span style=color:#f92672>host_rewrite_literal</span>: <span style=color:#ae81ff>www.envoyproxy.io</span>
</span></span><span style=display:flex><span>                  <span style=color:#f92672>cluster</span>: <span style=color:#ae81ff>service_envoyproxy_io</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>clusters</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>service_envoyproxy_io</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>type</span>: <span style=color:#ae81ff>LOGICAL_DNS</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Change to play with other resolver rules </span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>dns_lookup_family</span>: <span style=color:#ae81ff>AUTO</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>typed_dns_resolver_config</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>envoy.network.dns_resolver.cares</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>typed_config</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;@type&#34;: </span><span style=color:#ae81ff>type.googleapis.com/envoy.extensions.network.dns_resolver.cares.v3.CaresDnsResolverConfig</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>resolvers</span>:
</span></span><span style=display:flex><span>          - <span style=color:#f92672>socket_address</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>address</span>: <span style=color:#e6db74>&#34;8.8.8.8&#34;</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>port_value</span>: <span style=color:#ae81ff>53</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>filter_unroutable_families</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>dns_resolver_options</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>no_default_search_domain</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>load_assignment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>cluster_name</span>: <span style=color:#ae81ff>service_envoyproxy_io</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>endpoints</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>lb_endpoints</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>endpoint</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>address</span>:
</span></span><span style=display:flex><span>              <span style=color:#f92672>socket_address</span>:
</span></span><span style=display:flex><span>                <span style=color:#f92672>address</span>: <span style=color:#ae81ff>www.envoyproxy.io</span>
</span></span><span style=display:flex><span>                <span style=color:#f92672>port_value</span>: <span style=color:#ae81ff>443</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>transport_socket</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>envoy.transport_sockets.tls</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>typed_config</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;@type&#34;: </span><span style=color:#ae81ff>type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>sni</span>: <span style=color:#ae81ff>www.envoyproxy.io</span>
</span></span></code></pre></div><p>And run it with debug:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ envoy -l debug -c ./envoy.yaml
</span></span></code></pre></div><h2 id=93-haproxy>9.3 <code>HAProxy</code>
<a class=anchor href=#93-haproxy>#</a></h2><p><code>HAProxy</code> uses <code>getaddrinfo()</code> only for the initial name resolution when binding to listening addresses, similar to the approach we discussed in the dual-stack server section.</p><p>To connect to backend (upstream) servers, <code>HAProxy</code> employs its own resolver. It is possible to configure <code>HAProxy</code> with multiple name servers. If you set more than one, <code>HAProxy</code> will send queries to all of them in <a href=https://cbonte.github.io/haproxy-dconv/2.0/configuration.html#5.3.2 target=_blank rel=noopener>parallel</a>:</p><blockquote><p>When multiple name servers are configured in a resolvers section, then <code>HAProxy</code> uses the first valid response. In case of invalid responses, only the last one is treated. Purpose is to give the chance to a slow server to deliver a valid answer after a fast faulty or outdated server.</p></blockquote><p>The code is under <code><a href=https://github.com/haproxy/haproxy/blob/735e4aecfcf34ec46c3143bfad9a123466fd8296/src/resolvers.c#L434-L465 target=_blank rel=noopener>src/resolvers.c</a></code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>resolv_send_query</span>(<span style=color:#66d9ef>struct</span> resolv_resolution <span style=color:#f92672>*</span>resolution)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#960050;background-color:#1e0010>…</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>list_for_each_entry</span>(ns, <span style=color:#f92672>&amp;</span>resolvers<span style=color:#f92672>-&gt;</span>nameservers, list) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>dns_send_nameserver</span>(ns, trash.area, len) <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>			resolution<span style=color:#f92672>-&gt;</span>nb_queries<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>      <span style=color:#960050;background-color:#1e0010>…</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You can also control the <a href=https://cbonte.github.io/haproxy-dconv/2.0/configuration.html#5.2-resolve-prefer target=_blank rel=noopener>preference of address families</a>:</p><blockquote><p><code>resolve-prefer &lt;family></code></p><p>When DNS resolution is enabled for a server and multiple IP addresses from different families are returned, HAProxy will prefer using an IP address from the family mentioned in the &ldquo;resolve-prefer&rdquo; parameter. Available families: &ldquo;<code>ipv4</code>&rdquo; and &ldquo;<code>ipv6</code>&rdquo;</p><p>Default value: <code>ipv6</code></p></blockquote><p>According to the documentation, the parameter mentioned above is only a preference. In the event of a resolve timeout, error, or &ldquo;not found&rdquo; address, a retry will be issued with another resource record family type.</p><p><code>HAProxy</code> also does not follow the <a href=https://datatracker.ietf.org/doc/html/rfc6724 target=_blank rel=noopener>Default Address Selection for Internet Protocol Version 6 (IPv6)</a>. The logic is similar to what we discussed with the Java JDK, but without the <code>system</code> value for the IPv6 preference property, which can make migrating from IPv4 to IPv6 challenging.</p><p>Another resolver-related setting controls how the initial resolution of backends occurs at startup. Interestingly, you can use <code>getaddrinfo()</code> for this purpose.</p><p>Additionally, there is no support for the Happy Eyeballs algorithm, which could make migration to or using a dual-stack application more difficult.</p><a href=/docs/resolver-dual-stack-application/10-systemd-resolved/ class="book-btn right-button">Read next chapter →</a></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#9-dual-stack-software-examples>9. Dual-stack software examples</a><ul><li><a href=#91-nginx>9.1 Nginx</a></li><li><a href=#92-envoy-proxy>9.2 Envoy proxy</a></li><li><a href=#93-haproxy>9.3 <code>HAProxy</code></a></li></ul></li></ul></nav></div></aside></main><div class=cookie-container><p>This website uses "<b>cookies</b>".
Using this website means you're OK with this.
If you are <b>NOT</b>, please close the site page.</p><button class=cookie-btn>
ACCEPT AND CLOSE</button></div><script src=/my_js/cookie.js></script></body></html>