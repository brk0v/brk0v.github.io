<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="2. History: gethostbyname() and old good friends # Please do not use any of the code snippets from this chapter in your projects. They are provided solely for historical and educational purposes. Instead, you should use getaddrinfo(). The gethostbyname (man 3 gethostbyname) function first appeared in the 1980s and has been a part of the networking landscape ever since. Despite its obsoletion, some programs still use it. It was deprecated in POSIX."><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#343a40"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://biriukov.dev/docs/resolver-dual-stack-application/2-history-gethostbyname/"><meta property="og:site_name" content="Viacheslav Biriukov"><meta property="og:title" content="History: gethostbyname() and old good friends"><meta property="og:description" content="2. History: gethostbyname() and old good friends # Please do not use any of the code snippets from this chapter in your projects. They are provided solely for historical and educational purposes. Instead, you should use getaddrinfo(). The gethostbyname (man 3 gethostbyname) function first appeared in the 1980s and has been a part of the networking landscape ever since. Despite its obsoletion, some programs still use it. It was deprecated in POSIX."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><title>History: gethostbyname() and old good friends | Viacheslav Biriukov</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png><link rel=stylesheet href=/book.min.33a48f5432973b8ff9a82679d9e45d67f2c15d4399bd2829269455cfe390b5e8.css integrity="sha256-M6SPVDKXO4/5qCZ52eRdZ/LBXUOZvSgpJpRVz+OQteg=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script><script defer src=/en.search.min.68b3e77026321f328117d0fad4d435503090b0c39945f4d5420d45ae7897cd75.js integrity="sha256-aLPncCYyHzKBF9D61NQ1UDCQsMOZRfTVQg1FrniXzXU=" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-599VSLESJL"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-599VSLESJL")</script><link rel=stylesheet href=/my_css/cookie.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Viacheslav Biriukov</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li class=book-section-flat><span>DNS resolvers and Dual-Stack applications</span><ul><li><a href=/docs/resolver-dual-stack-application/0-sre-should-know-about-gnu-linux-resolvers-and-dual-stack-applications/>Resolvers and Dual-Stack applications for SRE</a></li><li><a href=/docs/resolver-dual-stack-application/1-what-is-a-stub-resolver/>1. What is a stub resolver?</a></li><li><a href=/docs/resolver-dual-stack-application/2-history-gethostbyname/ class=active>2. History: gethostbyname()</a></li><li><a href=/docs/resolver-dual-stack-application/3-getaddrinfo-and-posix-spec/>3. getaddrinfo() and POSIX spec</a></li><li><a href=/docs/resolver-dual-stack-application/4-getaddrinfo-from-glibc/>4. getaddrinfo() from glibc</a></li><li><a href=/docs/resolver-dual-stack-application/5-getaddrinfo-from-musl-libc/>5. getaddrinfo() from musl libc</a></li><li><a href=/docs/resolver-dual-stack-application/6-dual-stack-applications/>6. Dual-Stack applications</a></li><li><a href=/docs/resolver-dual-stack-application/7-async-non-blocking-resolvers-in-c/>7. C async non-blocking resolvers</a></li><li><a href=/docs/resolver-dual-stack-application/8-stub-resolvers-in-languages/>8. Stub resolvers in languages</a></li><li><a href=/docs/resolver-dual-stack-application/9-dual-stack-software-examples/>9. Dual-stack software examples</a></li><li><a href=/docs/resolver-dual-stack-application/10-systemd-resolved/>10. systemd-resolved</a></li><li><a href=/docs/resolver-dual-stack-application/11-querying-nameservers-on-dual-stack-hosts/>11. Querying Nameservers</a></li><li><a href=/docs/resolver-dual-stack-application/12-present-and-future-of-resolvers-and-dns-related-features/>12. Present and future</a></li><li><a href=/docs/resolver-dual-stack-application/troubleshooting-tools-for-resolvers-and-dns/>Troubleshooting tools</a></li></ul></li></ul><div style=margin-top:30px;margin-bottom:30px><b>More post series:</b><ul><li><a href=/docs/fd-pipe-session-terminal/0-sre-should-know-about-gnu-linux-shell-related-internals-file-descriptors-pipes-terminals-user-sessions-process-groups-and-daemons>1. File descriptors, pipes, terminals, user sessions, process groups and daemons</li><li><a href=/docs/page-cache/0-linux-page-cache-for-sre/>2. Linux Page Cache mini book</li><li><a href=/docs/resolver-dual-stack-application/0-sre-should-know-about-gnu-linux-resolvers-and-dual-stack-applications/>3. Resolvers and Dual-Stack applications <span style="padding:0 2px;border-radius:2px;background-color:#e84118;color:#f0f8ff">new</span></li></ul></div><ul><li><a href=https://twitter.com/brk0v/ target=_blank rel=noopener><i class="bi bi-twitter"></i>
Twitter</a></li><li><a href=https://www.linkedin.com/in/biriukov/ target=_blank rel=noopener><i class="bi bi-linkedin"></i>
Linkedin</a></li><li><a href=https://github.com/brk0v/ target=_blank rel=noopener><i class="bi bi-github"></i>
Github</a></li></ul><div style=margin-top:30px><p xmlns:cc=http://creativecommons.org/ns#>This content is licensed under
<a href="http://creativecommons.org/licenses/by-nc/4.0/?ref=chooser-v1" target=_blank rel="license noopener noreferrer" style=display:inline-block>CC BY-NC 4.0<img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1"><img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"><img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1"></a></p></div></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>History: gethostbyname() and old good friends</strong>
<label for=toc-control></label></div></header><article class="markdown book-article"><h1 id=2-history-gethostbyname-and-old-good-friends>2. History: <code>gethostbyname()</code> and old good friends
<a class=anchor href=#2-history-gethostbyname-and-old-good-friends>#</a></h1><blockquote class="book-hint warning">Please do not use any of the code snippets from this chapter in your projects. They are provided solely for historical and educational purposes. Instead, you should use <code>getaddrinfo()</code>.</blockquote><p>The <code>gethostbyname</code> (<code><a href=https://man7.org/linux/man-pages/man3/gethostbyname.3.html target=_blank rel=noopener>man 3 gethostbyname</a></code>) function first appeared in the 1980s and has been a part of the networking landscape ever since. Despite its obsoletion, some programs still use it. It was deprecated in POSIX.1-2001, over two decades ago, due to its internal design limitations and limited functionality. However, for a long time, it was the preferred and standardized helper function for resolving a domain name into a list of IP addresses.</p><p>The number of drawbacks and problems which made its usage obsolete:</p><ol><li>The lack of IPv6 support. Although there is a Linux-specific <code>gethostbyname2()</code>, which can resolve IPv6 addresses, the standard <code>gethostbyname()</code> function is limited to IPv4 only.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> hostent <span style=color:#f92672>*</span>host_info <span style=color:#f92672>=</span> <span style=color:#a6e22e>gethostbyname2</span>(hostname, address_family);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (host_info <span style=color:#f92672>==</span> NULL) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fprintf</span>(stderr, <span style=color:#e6db74>&#34;Error: Could not resolve hostname %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, hostname);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>exit</span>(EXIT_FAILURE);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>char</span> <span style=color:#f92672>**</span>addr_list <span style=color:#f92672>=</span> host_info<span style=color:#f92672>-&gt;</span>h_addr_list; <span style=color:#f92672>*</span>addr_list <span style=color:#f92672>!=</span> NULL; addr_list<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> ip[INET6_ADDRSTRLEN];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>address <span style=color:#f92672>=</span> (host_info<span style=color:#f92672>-&gt;</span>h_addrtype <span style=color:#f92672>==</span> AF_INET) 
</span></span><span style=display:flex><span>                    <span style=color:#f92672>?</span> (<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>) ((<span style=color:#66d9ef>struct</span> in_addr <span style=color:#f92672>*</span>) <span style=color:#f92672>*</span>addr_list)
</span></span><span style=display:flex><span>                    <span style=color:#f92672>:</span> (<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>) ((<span style=color:#66d9ef>struct</span> in6_addr <span style=color:#f92672>*</span>) <span style=color:#f92672>*</span>addr_list);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>result <span style=color:#f92672>=</span> <span style=color:#a6e22e>inet_ntop</span>(host_info<span style=color:#f92672>-&gt;</span>h_addrtype, address, ip, <span style=color:#66d9ef>sizeof</span>(ip));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (result <span style=color:#f92672>==</span> NULL) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>perror</span>(<span style=color:#e6db74>&#34;inet_ntop&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exit</span>(EXIT_FAILURE);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;  %s</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, ip);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In theory, you could use <code>gethostbyname2()</code>, but it still lacks the capability to combine IPv4 and IPv6 results, properly sort them according to the standard <a href=https://datatracker.ietf.org/doc/html/rfc6724 target=_blank rel=noopener>RFC 6724</a> (which we will discuss later), and suffers from a legacy internal design.</p><ol><li>Non-Reentrant: <code>gethostbyname()</code> is not thread-safe. It uses internal static data structures, meaning that subsequent calls to <code>gethostbyname()</code> overwrite the data returned by previous calls.</li><li>Limited Information: The <code>hostent</code> structure returned by <code>gethostbyname()</code> provides limited information, primarily focusing on the IP address and not on other details like the service or protocol. This often leads to additional string concatenations and the creation of new data structures, which result in more boilerplate code for subsequent socket API calls.</li></ol><p>It’s worth mentioning that <code>gethostbyname()</code> has a unique feature: it returns a list of IP addresses in a semi-random order with each call, essentially providing a <a href=https://en.wikipedia.org/wiki/Round-robin_DNS target=_blank rel=noopener>round-robin DNS</a>. This allows for the simple implementation of a client-side load balancer among the returned <code>A</code> records.</p><p>Another UNIX <code>libc</code> function, <code>getipnodebyname</code> (<code><a href=https://man7.org/linux/man-pages/man3/getipnodebyname.3.html target=_blank rel=noopener>man 3 getipnodebyname</a></code>), has been removed from GNU/Linux but may still exist on other platforms. Here is how it appears in Python 3.12 (<code>cpython</code>) for some other platforms. File <code><a href=https://github.com/python/cpython/blob/bc93923a2dee00751e44da58b6967c63e3f5c392/Modules/getaddrinfo.c#L557 target=_blank rel=noopener>Modules/getaddrinfo.c</a></code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#ifdef ENABLE_IPV6
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (af <span style=color:#f92672>==</span> AF_UNSPEC) {
</span></span><span style=display:flex><span>        hp <span style=color:#f92672>=</span> <span style=color:#a6e22e>getipnodebyname</span>(hostname, AF_INET6,
</span></span><span style=display:flex><span>                        AI_ADDRCONFIG<span style=color:#f92672>|</span>AI_ALL<span style=color:#f92672>|</span>AI_V4MAPPED, <span style=color:#f92672>&amp;</span>h_error);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        hp <span style=color:#f92672>=</span> <span style=color:#a6e22e>getipnodebyname</span>(hostname, af, AI_ADDRCONFIG, <span style=color:#f92672>&amp;</span>h_error);
</span></span><span style=display:flex><span><span style=color:#75715e>#else
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    hp <span style=color:#f92672>=</span> <span style=color:#a6e22e>gethostbyname</span>(hostname);
</span></span><span style=display:flex><span>    h_error <span style=color:#f92672>=</span> h_errno;
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span></code></pre></div><a href=/docs/resolver-dual-stack-application/3-getaddrinfo-and-posix-spec/ class="book-btn right-button">Read next chapter →</a></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div></main><div class=cookie-container><p>This website uses "<b>cookies</b>".
Using this website means you're OK with this.
If you are <b>NOT</b>, please close the site page.</p><button class=cookie-btn>
ACCEPT AND CLOSE</button></div><script src=/my_js/cookie.js></script></body></html>