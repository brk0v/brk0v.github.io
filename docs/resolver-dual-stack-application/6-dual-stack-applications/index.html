<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="
  6. Dual-Stack applications
  #


    
        Last updated: Oct 2025
    

Contents

6.1 Dual stack server

6.1.1 IPV6_V6ONLY socket option
6.1.2 Multiple listening sockets with systemd


6.2 Dual stack client

6.2.1 Sorting destination addresses (RFC 6724)
6.2.2 Happy Eyeballs: Success with Dual-Stack Hosts





Let’s now focus on dual-stack programs, which support both IPv4 and IPv6. Here are some critical questions to consider:
For server code:

How can we easily listen on all IPv4 and all IPv6 addresses? Do we need separate listeners for each?
Are there any tools or helpers available to manage multiple listeners?

For client code:">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="https://biriukov.dev/docs/resolver-dual-stack-application/6-dual-stack-applications/">
  <meta property="og:site_name" content="Viacheslav Biriukov">
  <meta property="og:title" content="Dual-Stack applications">
  <meta property="og:description" content="6. Dual-Stack applications # Last updated: Oct 2025 Contents
6.1 Dual stack server 6.1.1 IPV6_V6ONLY socket option 6.1.2 Multiple listening sockets with systemd 6.2 Dual stack client 6.2.1 Sorting destination addresses (RFC 6724) 6.2.2 Happy Eyeballs: Success with Dual-Stack Hosts Let’s now focus on dual-stack programs, which support both IPv4 and IPv6. Here are some critical questions to consider:
For server code:
How can we easily listen on all IPv4 and all IPv6 addresses? Do we need separate listeners for each? Are there any tools or helpers available to manage multiple listeners? For client code:">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
<title>Dual-Stack applications | Viacheslav Biriukov</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" >
<link rel="stylesheet" href="/book.min.1e13c2d8521416f2409b2e0e47b515c4ee90f2718cddd31ea96d2f739bc9d7e1.css" integrity="sha256-HhPC2FIUFvJAmy4OR7UVxO6Q8nGM3dMeqW0vc5vJ1&#43;E=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.dcb69b7f72cf406432b553b1dca142c9cc7ac0f7ea624f296af7cfa987b92fe5.js" integrity="sha256-3Labf3LPQGQytVOx3KFCycx6wPfqYk8pavfPqYe5L&#43;U=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
<script
    async
    src="https://www.googletagmanager.com/gtag/js?id=G-599VSLESJL"
></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }
    gtag("js", new Date());

    gtag("config", "G-599VSLESJL");
</script>

<link rel="stylesheet" href="/my_css/cookie.css" />
<link rel="stylesheet" href="/my_css/copy-code.css" />
<link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"
/>

</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>Viacheslav Biriukov</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    

      
        

      

      
        <li class="book-section-flat" >
          
  
  

  
    <span>DNS resolvers and Dual-Stack applications</span>
  

          
  <ul>
    

      

      
        <li>
          
  
  

  
    <a href="/docs/resolver-dual-stack-application/0-sre-should-know-about-gnu-linux-resolvers-and-dual-stack-applications/" class="">
      
        Resolvers and Dual-Stack applications for SRE
      
    </a>
  

        </li>
      
    

      

      
        <li>
          
  
  

  
    <a href="/docs/resolver-dual-stack-application/1-what-is-a-stub-resolver/" class="">
      
        1. What is a stub resolver?
      
    </a>
  

        </li>
      
    

      

      
        <li>
          
  
  

  
    <a href="/docs/resolver-dual-stack-application/2-history-gethostbyname/" class="">
      
        2. History: gethostbyname()
      
    </a>
  

        </li>
      
    

      

      
        <li>
          
  
  

  
    <a href="/docs/resolver-dual-stack-application/3-getaddrinfo-and-posix-spec/" class="">
      
        3. getaddrinfo() and POSIX spec
      
    </a>
  

        </li>
      
    

      

      
        <li>
          
  
  

  
    <a href="/docs/resolver-dual-stack-application/4-getaddrinfo-from-glibc/" class="">
      
        4. getaddrinfo() from glibc
      
    </a>
  

        </li>
      
    

      

      
        <li>
          
  
  

  
    <a href="/docs/resolver-dual-stack-application/5-getaddrinfo-from-musl-libc/" class="">
      
        5. getaddrinfo() from musl libc
      
    </a>
  

        </li>
      
    

      

      
        <li>
          
  
  

  
    <a href="/docs/resolver-dual-stack-application/6-dual-stack-applications/" class="active">
      
        6. Dual-Stack applications
      
    </a>
  

        </li>
      
    

      

      
        <li>
          
  
  

  
    <a href="/docs/resolver-dual-stack-application/7-async-non-blocking-resolvers-in-c/" class="">
      
        7. C async non-blocking resolvers
      
    </a>
  

        </li>
      
    

      

      
        <li>
          
  
  

  
    <a href="/docs/resolver-dual-stack-application/8-stub-resolvers-in-languages/" class="">
      
        8. Stub resolvers in languages
      
    </a>
  

        </li>
      
    

      

      
        <li>
          
  
  

  
    <a href="/docs/resolver-dual-stack-application/9-dual-stack-software-examples/" class="">
      
        9. Dual-stack software examples
      
    </a>
  

        </li>
      
    

      

      
        <li>
          
  
  

  
    <a href="/docs/resolver-dual-stack-application/10-systemd-resolved/" class="">
      
        10. systemd-resolved
      
    </a>
  

        </li>
      
    

      

      
        <li>
          
  
  

  
    <a href="/docs/resolver-dual-stack-application/11-querying-nameservers-on-dual-stack-hosts/" class="">
      
        11. Querying Nameservers
      
    </a>
  

        </li>
      
    

      

      
        <li>
          
  
  

  
    <a href="/docs/resolver-dual-stack-application/12-present-and-future-of-resolvers-and-dns-related-features/" class="">
      
        12. Present and future
      
    </a>
  

        </li>
      
    

      

      
        <li>
          
  
  

  
    <a href="/docs/resolver-dual-stack-application/troubleshooting-tools-for-resolvers-and-dns/" class="">
      
        Troubleshooting tools
      
    </a>
  

        </li>
      
    
  </ul>

        </li>
      
    

      
        

      
        
  </ul>








<div style="margin-top: 30px; margin-bottom: 30px">
  <b>More recent series:</b>
  <ul>
    <li><a href="/rust-tokio-io/">1. Async Rust & Tokio I/O Streams: Backpressure, Concurrency, and Ergonomics&nbsp;<span style="padding:0 2px;border-radius:2px ;background-color:#e84118;color: aliceblue;">new</span></li>
    <li><a href="/docs/resolver-dual-stack-application/0-sre-should-know-about-gnu-linux-resolvers-and-dual-stack-applications/">2. Resolvers and Dual-Stack applications</li>
    <li><a href="/docs/page-cache/0-linux-page-cache-for-sre/">3. Linux Page Cache mini book</li>
    <li><a href="/docs/fd-pipe-session-terminal/0-sre-should-know-about-gnu-linux-shell-related-internals-file-descriptors-pipes-terminals-user-sessions-process-groups-and-daemons">4. File descriptors, pipes, terminals, user sessions, process groups and daemons</li>
  </ul>
</div>

<div style="margin-top: 30px; margin-bottom: 30px">
  <b>Open Source Projects</b>
  <ul>
      <li>
          <a href="/posts/trixter-chaos-proxy/"> • trixter chaos proxy</a>
      </li>
      <li><a href="https://crates.io/crates/tokio-netem"> • tokio-netem</a></li>
  </ul>
</div>





  
<ul>
  
  <li>
    <a href="https://twitter.com/brk0v/"  target="_blank" rel="noopener"><i class="bi bi-twitter"></i>
        Twitter
      </a>
  </li>
  
  <li>
    <a href="https://www.linkedin.com/in/biriukov/"  target="_blank" rel="noopener"><i class="bi bi-linkedin"></i>
        Linkedin
      </a>
  </li>
  
  <li>
    <a href="https://github.com/brk0v/"  target="_blank" rel="noopener"><i class="bi bi-github"></i>
        Github
      </a>
  </li>
  
</ul>





<div style="margin-top: 30px;">
  <p xmlns:cc="http://creativecommons.org/ns#">
    This content is licensed under 
    <a
      href="http://creativecommons.org/licenses/by-nc/4.0/?ref=chooser-v1" target="_blank"
      rel="license noopener noreferrer" style="display:inline-block; ">CC BY-NC 4.0<img
      style="height:22px!important;margin-left:3px;vertical-align:text-bottom;"
      src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1"><img
      style="height:22px!important;margin-left:3px;vertical-align:text-bottom;"
      src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"><img
      style="height:22px!important;margin-left:3px;vertical-align:text-bottom;"
      src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1">
    </a>
  </p>
</div>
</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Dual-Stack applications</strong>

  <label for="toc-control">
    
  </label>
</div>


  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="6-dual-stack-applications">
  6. Dual-Stack applications
  <a class="anchor" href="#6-dual-stack-applications">#</a>
</h1>
<p class="updated-right">
    <i>
        <time datetime="2025-10">Last updated: Oct 2025</time>
    </i>
</p>
<p><strong>Contents</strong></p>
<ul>
<li><a href="/docs/resolver-dual-stack-application/6-dual-stack-applications/#61-dual-stack-server">6.1 Dual stack server</a>
<ul>
<li><a href="/docs/resolver-dual-stack-application/6-dual-stack-applications/#611--ipv6_v6only-socket-option">6.1.1 <code>IPV6_V6ONLY</code> socket option</a></li>
<li><a href="/docs/resolver-dual-stack-application/6-dual-stack-applications/#612-multiple-listening-sockets-with-systemd">6.1.2 Multiple listening sockets with <code>systemd</code></a></li>
</ul>
</li>
<li><a href="/docs/resolver-dual-stack-application/6-dual-stack-applications/#62-dual-stack-client">6.2 Dual stack client</a>
<ul>
<li><a href="/docs/resolver-dual-stack-application/6-dual-stack-applications/#621-sorting-destination-addresses-rfc-6724">6.2.1 Sorting destination addresses (RFC 6724)</a></li>
<li><a href="/docs/resolver-dual-stack-application/6-dual-stack-applications/#622-happy-eyeballs-success-with-dual-stack-hosts">6.2.2 Happy Eyeballs: Success with Dual-Stack Hosts</a></li>
</ul>
</li>
</ul>
<hr/>
<img alt="IPv4 or IPv6" src="../images/dns_two_buttons.png" width="40%" class="img-center">
<p>Let’s now focus on dual-stack programs, which support both IPv4 and IPv6. Here are some critical questions to consider:</p>
<p>For server code:</p>
<ul>
<li>How can we easily listen on all IPv4 and all IPv6 addresses? Do we need separate listeners for each?</li>
<li>Are there any tools or helpers available to manage multiple listeners?</li>
</ul>
<p>For client code:</p>
<ul>
<li>Which address family should our client program resolve and use: <code>A</code>, <code>AAAA</code>, or both?</li>
<li>What to do if the resolver returns multiple addresses for each family?</li>
<li>Does a machine have active IPv4 and IPv6 connectivity? Is the IPv6 routing configured correctly to the destination?</li>
<li>In case of connection errors, which address should be used to reconnect?</li>
</ul>
<p>Ideally, we want to abstract away from these technical details to focus more on developing our core business logic, such as converting <code>JSON</code>s to <code>protobuf</code>s and vice versa. 🙃</p>
<p>To address these questions effectively, we need to take a closer look at <code>getaddrinfo()</code>, its arguments, and its implementation details. Let’s dive in, starting with the server side.</p>
<h2 id="61-dual-stack-server">
  6.1 Dual stack server
  <a class="anchor" href="#61-dual-stack-server">#</a>
</h2>
<p>Common sense suggests that to support both IPv4 and IPv6, we would need at least two listening sockets: one for each address family. However, just as we use the special IPv4 address <code>0.0.0.0</code> (also known as wildcard IPv4 or <code>INADDR_ANY</code>) to bind to all available IPv4 interfaces, there is a similar solution for IPv6. The IPv6 wildcard address, represented as <code>::</code> or <code>IN6ADDR_ANY_INIT</code>, functions similarly by allowing binding to all interfaces and all IPv6 addresses. But it has one more feature that the IPv4 wildcard address is missing. The listener on <code>::</code> address can handle IPv4 connections too, thanks to a special block of IPv6 addresses known as IPv4-mapped addresses.</p>
<p>Good explanation of what are these IPv4-mapped addresses can be found in <a href="https://datatracker.ietf.org/doc/html/rfc3493#section-3.7" target="_blank" rel="noopener">RFC 3493 Basic Socket Interface Extensions for IPv6</a>:</p>
<blockquote>
<p>3.7 Compatibility with IPv4 Nodes</p>
<p>The API also provides a different type of compatibility: the ability  for IPv6 applications to interoperate with IPv4 applications.  This feature uses the IPv4-mapped IPv6 address format defined in the IPv6 addressing architecture specification [2].  This address format allows the IPv4 address of an IPv4 node to be represented as an IPv6 address.  The IPv4 address is encoded into the low-order 32 bits of the IPv6 address, and the high-order 96 bits hold the fixed prefix <code>0:0:0:0:0:FFFF</code>. IPv4-mapped addresses are written as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span> ::FFFF:&lt;IPv4-address&gt;
</span></span></code></pre></div><p>These addresses can be generated automatically by the <code>getaddrinfo()</code> function, as described in Section 6.1. Applications may use <code>AF_INET6</code> sockets to open TCP connections to IPv4 nodes, or send UDP packets to IPv4 nodes, by simply encoding the destination&rsquo;s IPv4 address as an IPv4-mapped IPv6 address, and passing that address, within a <code>sockaddr_in6</code> structure, in the <code>connect()</code> or <code>sendto()</code> call.  When applications use <code>AF_INET6</code> sockets to accept TCP connections from IPv4 nodes, or receive UDP packets from IPv4 nodes, the system returns the peer&rsquo;s address to the application in the <code>accept()</code>, <code>recvfrom()</code>, or <code>getpeername()</code> call using a <code>sockaddr_in6</code> structure encoded this way.</p></blockquote>
<p><code>getaddrinfo()</code> in server code plays several roles:</p>
<ul>
<li>It allows the use of hostnames to bind a socket if the node parameter of <code>getaddrinfo()</code> is set.</li>
<li>It prepares the necessary data structures for use in socket API calls.</li>
<li>It makes it possible to bind to all available and future addresses with minimal changes to the code.</li>
</ul>
<p>By leveraging these functionalities, getaddrinfo() simplifies the process of setting up network connections in server applications.</p>
<p>By leveraging these functionalities,  <code>getaddrinfo()</code> simplifies the process of setting up network connections in server applications.</p>
<p>Server code example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define _POSIX_C_SOURCE 200112L
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;arpa/inet.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;netdb.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/socket.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define PORT &#34;80&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define BACKLOG 10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handle_client</span>(<span style="color:#66d9ef">int</span> client_fd) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>response <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;HTTP/1.0 200 OK</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>                         <span style="color:#e6db74">&#34;Content-Type: text/html</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>                         <span style="color:#e6db74">&#34;Connection: close</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>                         <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>                         <span style="color:#e6db74">&#34;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello, World!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">send</span>(client_fd, response, <span style="color:#a6e22e">strlen</span>(response), <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">shutdown</span>(client_fd, SHUT_WR);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">close</span>(client_fd);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> addrinfo hints, <span style="color:#f92672">*</span>servinfo, <span style="color:#f92672">*</span>p;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> sockfd;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> yes <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> rv;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>hints, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span> hints);
</span></span><span style="display:flex;"><span>  hints.ai_family <span style="color:#f92672">=</span> AF_INET6; <span style="color:#75715e">// &lt;--- ①
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  hints.ai_socktype <span style="color:#f92672">=</span> SOCK_STREAM;
</span></span><span style="display:flex;"><span>  hints.ai_flags <span style="color:#f92672">=</span> AI_PASSIVE; <span style="color:#75715e">// &lt;--- ②
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((rv <span style="color:#f92672">=</span> <span style="color:#a6e22e">getaddrinfo</span>(NULL <span style="color:#75715e">/* ---&gt; ③ &lt;---*/</span>, PORT, <span style="color:#f92672">&amp;</span>hints, <span style="color:#f92672">&amp;</span>servinfo)) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;getaddrinfo: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#a6e22e">gai_strerror</span>(rv));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ---&gt; ④ &lt;---
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (p <span style="color:#f92672">=</span> servinfo; p <span style="color:#f92672">!=</span> NULL; p <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>ai_next) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((sockfd <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(p<span style="color:#f92672">-&gt;</span>ai_family, p<span style="color:#f92672">-&gt;</span>ai_socktype, p<span style="color:#f92672">-&gt;</span>ai_protocol)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;server: socket&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">setsockopt</span>(sockfd, SOL_SOCKET, SO_REUSEADDR, <span style="color:#f92672">&amp;</span>yes, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;setsockopt&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">close</span>(sockfd);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">bind</span>(sockfd, p<span style="color:#f92672">-&gt;</span>ai_addr, p<span style="color:#f92672">-&gt;</span>ai_addrlen) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">close</span>(sockfd);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;server: bind&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (p <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fprintf</span>(stderr, <span style="color:#e6db74">&#34;server: failed to bind</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">freeaddrinfo</span>(servinfo); <span style="color:#75715e">// all done with this structure
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">listen</span>(sockfd, BACKLOG) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;listen&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(sockfd);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;server: waiting for connections...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sockaddr_storage client_addr;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">socklen_t</span> addr_size <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span> client_addr;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> client_fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">accept</span>(sockfd, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>client_addr, <span style="color:#f92672">&amp;</span>addr_size);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (client_fd <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;accept&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> name[INET6_ADDRSTRLEN];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> port[<span style="color:#ae81ff">10</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">getnameinfo</span>((<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>client_addr, addr_size, name, <span style="color:#66d9ef">sizeof</span>(name), <span style="color:#75715e">// &lt;--- ⑤
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                port, <span style="color:#66d9ef">sizeof</span>(port), NI_NUMERICHOST <span style="color:#f92672">|</span> NI_NUMERICSERV);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;client %s:%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, name, port);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">handle_client</span>(client_fd);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">close</span>(sockfd);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>① – Set  <code>AF_INET6</code> family to allow handle IPv4 and IPv6 addresses.</p>
<p>② – <code>AI_PASSIVE</code> flag asks <code>getaddrinfo()</code> to return a socket suitable for binding the socket that will accept connections.</p>
<p>③ – <code>NULL</code> for node with the <code>AI_PASSIVE</code> flag uses either <code>INADDR_ANY</code> for IPv4 address, or <code>IN6ADDR_ANY_INIT</code> for IPv6 address.</p>
<p>④ – The <a href="https://www.rfc-editor.org/rfc/rfc6724" target="_blank" rel="noopener">RFC 6724</a> (Default Address Selection for Internet Protocol Version 6 (IPv6)) clearly explains how to use the returned list of addresses in the applications:</p>
<blockquote>
<p>Well-behaved applications SHOULD NOT simply use the first address returned from an API such as <code>getaddrinfo()</code> and then give up if it fails. For many applications, it is appropriate to iterate through the list of addresses returned from <code>getaddrinfo()</code> until a working address is found. For other applications, it might be appropriate to try multiple addresses in parallel (e.g., with some small delay in between) and use the first one to succeed.</p></blockquote>
<p>The last sentence concerns the client programs and will be discussed later.</p>
<blockquote class="book-hint info">
  In our example, we <code>bind()</code> and <code>listen()</code> only to the first successful address, but if you’re writing a real server, it may be necessary to listen to multiple addresses due to security concerns. Therefore, your code should create multiple listeners and accept connections on all of them simultaneously.
</blockquote>

<p>⑤ – using <code>getnameinfo</code> (<code><a href="https://man7.org/linux/man-pages/man3/getnameinfo.3.html" target="_blank" rel="noopener">man 3 getnameinfo</a></code>) to convert the client address to human readable format.</p>
<p>Compile and run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ gcc ./server.c -o server <span style="color:#f92672">&amp;&amp;</span> ./server
</span></span></code></pre></div><p>Check that the server listens on proper address family and port:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo netstat -ntlp | grep <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>tcp6       <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> :::80         :::*       LISTEN   423492/./server
</span></span></code></pre></div><p>Let’s run some requests in the new terminal:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl localhost                                <span style="color:#75715e"># &lt;--- ①</span>
</span></span><span style="display:flex;"><span>&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello, World!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl 192.168.5.15                             <span style="color:#75715e"># &lt;--- ②</span>
</span></span><span style="display:flex;"><span>&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello, World!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#34;[2001:db8:123:456:6af2:68fe:ff7c:e25c]&#34;</span> <span style="color:#75715e"># &lt;--- ③</span>
</span></span><span style="display:flex;"><span>&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello, World!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl --interface 127.0.0.1 localhost          <span style="color:#75715e"># &lt;--- ④</span>
</span></span><span style="display:flex;"><span>&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello, World!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#34;[fe80::5055:55ff:fe8e:3d07%eth0]&#34;</span>       <span style="color:#75715e"># &lt;--- ⑤</span>
</span></span><span style="display:flex;"><span>&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello, World!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</span></span></code></pre></div><p>and collect the output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>server: waiting <span style="color:#66d9ef">for</span> connections…
</span></span><span style="display:flex;"><span>client ::1:41646                                  <span style="color:#75715e"># &lt;--- ①</span>
</span></span><span style="display:flex;"><span>client ::ffff:192.168.5.15:52236                  <span style="color:#75715e"># &lt;--- ②</span>
</span></span><span style="display:flex;"><span>client 2001:db8:123:456:6af2:68fe:ff7c:e25c:41098 <span style="color:#75715e"># &lt;--- ③</span>
</span></span><span style="display:flex;"><span>client ::ffff:127.0.0.1:35800                     <span style="color:#75715e"># &lt;--- ④</span>
</span></span><span style="display:flex;"><span>client fe80::5055:55ff:fe8e:3d07%eth0:34328       <span style="color:#75715e"># &lt;--- ⑤</span>
</span></span></code></pre></div><p>① – connection to <code>localhost</code> transforms to <code>::1</code> client address.</p>
<p>② – <code>192.168.5.15</code> is container local address, the log shows IPv4-mapped address.</p>
<p>③ – <code>2001:db8:123:456:6af2:68fe:ff7c:e25</code> is a local container address with global scope.</p>
<p>④ – using <code>--interface</code> we can force <code>curl</code> to use IPv4 source address for <code>localhost</code>.</p>
<blockquote class="book-hint info">
  <p>Internally curl uses <code>bind()</code> before <code>connect()</code> to set the source address:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ strace -e trace<span style="color:#f92672">=</span>network curl --interface 127.0.0.1 localhost
</span></span><span style="display:flex;"><span>…
</span></span><span style="display:flex;"><span>setsockopt<span style="color:#f92672">(</span>5, SOL_SOCKET, SO_BINDTODEVICE, <span style="color:#e6db74">&#34;127.0.0.1\0&#34;</span>, 10<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> -1 ENODEV <span style="color:#f92672">(</span>No such device<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>setsockopt<span style="color:#f92672">(</span>5, SOL_IP, IP_BIND_ADDRESS_NO_PORT, <span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>, 4<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>bind<span style="color:#f92672">(</span>5, <span style="color:#f92672">{</span>sa_family<span style="color:#f92672">=</span>AF_INET, sin_port<span style="color:#f92672">=</span>htons<span style="color:#f92672">(</span>0<span style="color:#f92672">)</span>, sin_addr<span style="color:#f92672">=</span>inet_addr<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;127.0.0.1&#34;</span><span style="color:#f92672">)}</span>, 16<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>getsockname<span style="color:#f92672">(</span>5, <span style="color:#f92672">{</span>sa_family<span style="color:#f92672">=</span>AF_INET, sin_port<span style="color:#f92672">=</span>htons<span style="color:#f92672">(</span>0<span style="color:#f92672">)</span>, sin_addr<span style="color:#f92672">=</span>inet_addr<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;127.0.0.1&#34;</span><span style="color:#f92672">)}</span>, <span style="color:#f92672">[</span>128 <span style="color:#f92672">=</span>&gt; 16<span style="color:#f92672">])</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>connect<span style="color:#f92672">(</span>5, <span style="color:#f92672">{</span>sa_family<span style="color:#f92672">=</span>AF_INET, sin_port<span style="color:#f92672">=</span>htons<span style="color:#f92672">(</span>80<span style="color:#f92672">)</span>, sin_addr<span style="color:#f92672">=</span>inet_addr<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;127.0.0.1&#34;</span><span style="color:#f92672">)}</span>, 16<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> -1 EINPROGRESS <span style="color:#f92672">(</span>Operation now in progress<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>…
</span></span></code></pre></div>
</blockquote>

<p>⑤ – if we’d like to use a link-local IPv6 address we need to use zone id and specify interface with <code>%</code> character.</p>
<h3 id="611--ipv6_v6only-socket-option">
  6.1.1  <code>IPV6_V6ONLY</code> socket option
  <a class="anchor" href="#611--ipv6_v6only-socket-option">#</a>
</h3>
<p>You always can opt out of handling IPv4 addresses with IPv6. To do so you need to set the socket option  <code><a href="https://man7.org/linux/man-pages/man7/ipv6.7.html" target="_blank" rel="noopener">IPV6_V6ONLY</a></code>:</p>
<blockquote>
<p>If this flag is set to true (nonzero), then the socket is restricted to sending and receiving IPv6 packets only. In this case, an IPv4 and an IPv6 application can bind to a single port at the same time.</p>
<p>If this flag is set to false (zero), then the socket can be used to send and receive packets to and from an IPv6 address or an IPv4-mapped IPv6 address. The argument is a pointer to a boolean value in an integer.</p>
<p>The default value for this flag is defined by the contents of the file <code>/proc/sys/net/ipv6/bindv6only</code>.  The default value for that file is 0 (false).</p></blockquote>
<h4 id="6111-nginx-and-envoy-envoyproxy-and-ipv6_v6only">
  6.1.1.1 Nginx and Envoy (Envoyproxy) and <code>IPV6_V6ONLY</code>
  <a class="anchor" href="#6111-nginx-and-envoy-envoyproxy-and-ipv6_v6only">#</a>
</h4>
<p>For example, <code>Nginx</code> and <code>Envoy</code> (<code>Envoyproxy</code>) set this option by default on all IPv6 listeners. The justification is to be explicit and to avoid hiding the IPv4-mapped addresses. Additionally, creating a socket with <code>IPV6_V6ONLY</code> is the default for Windows.</p>
<p>Therefore, for <code>Nginx</code>, if you need to listen on all interfaces, the default suggestion is to use two wildcard addresses:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>listen <span style="color:#f92672">[</span>::<span style="color:#f92672">]</span>:80;
</span></span><span style="display:flex;"><span>listen 80;
</span></span></code></pre></div><p>Request in logs:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1 - - <span style="color:#f92672">[</span>07/Jul/2024:08:41:34 +0100<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET / HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> <span style="color:#ae81ff">615</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;curl/8.5.0&#34;</span>
</span></span><span style="display:flex;"><span>::1 - - <span style="color:#f92672">[</span>07/Jul/2024:08:41:45 +0100<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET / HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> <span style="color:#ae81ff">615</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;curl/8.5.0&#34;</span>
</span></span></code></pre></div><p>However you can change it back to Linux defaults:</p>
<p>For <code>nginx</code> by setting <code>ipv6only=off</code> for <code><a href="https://nginx.org/en/docs/http/ngx_http_core_module.html#listen" target="_blank" rel="noopener">listen</a></code> directive:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>listen <span style="color:#f92672">[</span>::<span style="color:#f92672">]</span>:80 ipv6only<span style="color:#f92672">=</span>off;
</span></span></code></pre></div><p>In logs now:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>::1 - - <span style="color:#f92672">[</span>07/Jul/2024:08:40:40 +0100<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET / HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> <span style="color:#ae81ff">615</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;curl/8.5.0&#34;</span>
</span></span><span style="display:flex;"><span>::ffff:127.0.0.1 - - <span style="color:#f92672">[</span>07/Jul/2024:08:40:48 +0100<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET / HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> <span style="color:#ae81ff">615</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;curl/8.5.0&#34;</span>
</span></span></code></pre></div><p>For <code>envoy</code> set the <code><a href="https://www.envoyproxy.io/docs/envoy/latest/api-v3/config/core/v3/address.proto.html#config-core-v3-socketaddress" target="_blank" rel="noopener">ipv4_compat</a></code> for a listener:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>  <span style="color:#f92672">listeners</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">listener_0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">address</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">socket_address</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">address</span>: <span style="color:#e6db74">&#34;::&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">port_value</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ipv4_compat</span>: <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><h4 id="6112-go-golang-and-ipv6_v6only">
  6.1.1.2 Go (Golang) and <code>IPV6_V6ONLY</code>
  <a class="anchor" href="#6112-go-golang-and-ipv6_v6only">#</a>
</h4>
<p><code>Go</code> (<code>golang</code>), on the other hand, decided to choose simplicity (as usual) and provide sane defaults. It doesn&rsquo;t reset the Linux default (<code><a href="https://man7.org/linux/man-pages/man7/ipv6.7.html" target="_blank" rel="noopener">IPV6_V6ONLY</a></code> is not set) and it silently transforms IPv4-mapped addresses to IPv4 addresses and treats them as equal.</p>
<p>Server example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">connStateHandler</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>, <span style="color:#a6e22e">state</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ConnState</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">state</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StateNew</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">RemoteAddr</span>().(<span style="color:#f92672">*</span><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">TCPAddr</span>); <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;connected: %#v, %s:%d&#34;</span>, <span style="color:#a6e22e">addr</span>.<span style="color:#a6e22e">IP</span>, <span style="color:#a6e22e">addr</span>.<span style="color:#a6e22e">IP</span>, <span style="color:#a6e22e">addr</span>.<span style="color:#a6e22e">Port</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">server</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Server</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Addr</span>:      <span style="color:#e6db74">&#34;:80&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ConnState</span>: <span style="color:#a6e22e">connStateHandler</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Handler</span>: <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintln</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;Hello, this is the hardcoded response!&#34;</span>)
</span></span><span style="display:flex;"><span>		}),
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Starting server at :80&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">ListenAndServe</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;Error starting server: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Run it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ go run ./main.go
</span></span></code></pre></div><p>Check listening sockets, the server listens to IPv6 wildcard only:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo netstat -ntlp | grep <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>tcp6       <span style="color:#ae81ff">0</span>      <span style="color:#ae81ff">0</span> :::80            :::*              LISTEN      426610/main
</span></span></code></pre></div><p>Repeat the same exercise with <code>curl</code> and addresses from both families:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl localhost
</span></span><span style="display:flex;"><span>Hello, this is the hardcoded response!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl --interface 127.0.0.1 localhost
</span></span><span style="display:flex;"><span>Hello, this is the hardcoded response!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl 192.168.5.15
</span></span><span style="display:flex;"><span>Hello, this is the hardcoded response!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#34;[2001:db8:123:456:6af2:68fe:ff7c:e25c]&#34;</span>
</span></span><span style="display:flex;"><span>Hello, this is the hardcoded response!
</span></span></code></pre></div><p>The result contains IPv6 and IPv4 address without IPv4-mapped addresses in string representation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Starting server at :80
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>connected: net.IP<span style="color:#f92672">{</span>0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1<span style="color:#f92672">}</span>, ::1:55540
</span></span><span style="display:flex;"><span>connected: net.IP<span style="color:#f92672">{</span>0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xff, 0xff, 0x7f, 0x0, 0x0, 0x1<span style="color:#f92672">}</span>, 127.0.0.1:58108
</span></span><span style="display:flex;"><span>connected: net.IP<span style="color:#f92672">{</span>0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xff, 0xff, 0xc0, 0xa8, 0x5, 0xf<span style="color:#f92672">}</span>, 192.168.5.15:41442
</span></span><span style="display:flex;"><span>connected: net.IP<span style="color:#f92672">{</span>0x20, 0x1, 0xd, 0xb8, 0x1, 0x23, 0x4, 0x56, 0x6a, 0xf2, 0x68, 0xfe, 0xff, 0x7c, 0xe2, 0x5c<span style="color:#f92672">}</span>, 2001:db8:123:456:6af2:68fe:ff7c:e25c:38752
</span></span></code></pre></div><p>But as you can see the binary representation of IP addresses are IPv4-mapped.</p>
<p>Internally the <code>To4()</code> converts IPv4-mapped and real IPv4 to the same <code>net.IP</code>:</p>
<p><a href="https://cs.opensource.google/go/go/&#43;/refs/tags/go1.22.5:src/net/ip.go;l=210-223" target="_blank" rel="noopener">https://cs.opensource.google/go/go/+/refs/tags/go1.22.5:src/net/ip.go;l=210-223</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// To4 converts the IPv4 address ip to a 4-byte representation.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// If ip is not an IPv4 address, To4 returns nil.</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">ip</span> <span style="color:#a6e22e">IP</span>) <span style="color:#a6e22e">To4</span>() <span style="color:#a6e22e">IP</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">ip</span>) <span style="color:#f92672">==</span> <span style="color:#a6e22e">IPv4len</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ip</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">ip</span>) <span style="color:#f92672">==</span> <span style="color:#a6e22e">IPv6len</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">isZeros</span>(<span style="color:#a6e22e">ip</span>[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">10</span>]) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ip</span>[<span style="color:#ae81ff">10</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xff</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ip</span>[<span style="color:#ae81ff">11</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xff</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ip</span>[<span style="color:#ae81ff">12</span>:<span style="color:#ae81ff">16</span>]
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Also <code>String()</code> method of <code>net.IP</code> does this transformation for us implicitly:</p>
<p><a href="https://cs.opensource.google/go/go/&#43;/refs/tags/go1.22.5:src/net/ip.go;l=289-308" target="_blank" rel="noopener">https://cs.opensource.google/go/go/+/refs/tags/go1.22.5:src/net/ip.go;l=289-308</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// String returns the string form of the IP address ip.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// It returns one of 4 forms:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// - &#34;&lt;nil&gt;&#34;, if ip has length 0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// - dotted decimal (&#34;192.0.2.1&#34;), if ip is an IPv4 or IP4-mapped IPv6 address</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// - IPv6 conforming to RFC 5952 (&#34;2001:db8::1&#34;), if ip is a valid IPv6 address</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// - the hexadecimal form of ip, without punctuation, if no other cases apply</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">ip</span> <span style="color:#a6e22e">IP</span>) <span style="color:#a6e22e">String</span>() <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">ip</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&lt;nil&gt;&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">ip</span>) <span style="color:#f92672">!=</span> <span style="color:#a6e22e">IPv4len</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">ip</span>) <span style="color:#f92672">!=</span> <span style="color:#a6e22e">IPv6len</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;?&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">hexString</span>(<span style="color:#a6e22e">ip</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// If IPv4, use dotted notation.</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p4</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ip</span>.<span style="color:#a6e22e">To4</span>(); len(<span style="color:#a6e22e">p4</span>) <span style="color:#f92672">==</span> <span style="color:#a6e22e">IPv4len</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">netip</span>.<span style="color:#a6e22e">AddrFrom4</span>([<span style="color:#ae81ff">4</span>]byte(<span style="color:#a6e22e">p4</span>)).<span style="color:#a6e22e">String</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">netip</span>.<span style="color:#a6e22e">AddrFrom16</span>([<span style="color:#ae81ff">16</span>]byte(<span style="color:#a6e22e">ip</span>)).<span style="color:#a6e22e">String</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="6113-rust">
  6.1.1.3 Rust
  <a class="anchor" href="#6113-rust">#</a>
</h4>
<p>If we make the same experiment with <code>Rust</code>, <code>hyper</code> and <code>tokio</code>:</p>
<p>Dependencies:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[dependencies]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">hyper</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">{ version = &#34;0.14&#34;, features = [&#34;full&#34;] }</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">tokio</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">{ version = &#34;1&#34;, features = [&#34;full&#34;] }</span>
</span></span></code></pre></div><p>Code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> hyper::service::{make_service_fn, service_fn};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> hyper::{Body, Request, Response, Server};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::convert::Infallible;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::net::SocketAddr;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> std::sync::Arc;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> tokio::sync::Mutex;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Shared state for logging
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Logger</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Here you can add additional shared state if needed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">impl</span> Logger {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">log</span>(<span style="color:#f92672">&amp;</span>self, addr: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">SocketAddr</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">println!</span>(<span style="color:#e6db74">&#34;Received request from </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">, is ipv4: </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, addr.ip(), addr.port(), addr.is_ipv4());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">handle_request</span>(
</span></span><span style="display:flex;"><span>    req: <span style="color:#a6e22e">Request</span><span style="color:#f92672">&lt;</span>Body<span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>    logger: <span style="color:#a6e22e">Arc</span><span style="color:#f92672">&lt;</span>Mutex<span style="color:#f92672">&lt;</span>Logger<span style="color:#f92672">&gt;&gt;</span>,
</span></span><span style="display:flex;"><span>    remote_addr: <span style="color:#a6e22e">SocketAddr</span>,
</span></span><span style="display:flex;"><span>) -&gt; Result<span style="color:#f92672">&lt;</span>Response<span style="color:#f92672">&lt;</span>Body<span style="color:#f92672">&gt;</span>, Infallible<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Log the remote address
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> logger <span style="color:#f92672">=</span> logger.lock().<span style="color:#66d9ef">await</span>;
</span></span><span style="display:flex;"><span>        logger.log(<span style="color:#f92672">&amp;</span>remote_addr);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(Response::new(Body::from(<span style="color:#e6db74">&#34;Hello, world!&#34;</span>)))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#[tokio::main]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Define the address to listen on (IPv6 address :: and port 3000)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> addr <span style="color:#f92672">=</span> ([<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>], <span style="color:#ae81ff">3000</span>).into();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create a logger instance
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> logger <span style="color:#f92672">=</span> Arc::new(Mutex::new(Logger {}));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create a service that handles requests
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> make_svc <span style="color:#f92672">=</span> make_service_fn(<span style="color:#66d9ef">move</span> <span style="color:#f92672">|</span>conn: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">hyper</span>::server::conn::AddrStream<span style="color:#f92672">|</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> logger <span style="color:#f92672">=</span> logger.clone();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> remote_addr <span style="color:#f92672">=</span> conn.remote_addr();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">move</span> {
</span></span><span style="display:flex;"><span>            Ok::<span style="color:#f92672">&lt;</span>_, Infallible<span style="color:#f92672">&gt;</span>(service_fn(<span style="color:#66d9ef">move</span> <span style="color:#f92672">|</span>req<span style="color:#f92672">|</span> {
</span></span><span style="display:flex;"><span>                handle_request(req, logger.clone(), remote_addr)
</span></span><span style="display:flex;"><span>            }))
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create the server with the specified address and service
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> server <span style="color:#f92672">=</span> Server::bind(<span style="color:#f92672">&amp;</span>addr).serve(make_svc);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Run the server
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">println!</span>(<span style="color:#e6db74">&#34;Listening on http://[::]:3000&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#66d9ef">let</span> Err(e) <span style="color:#f92672">=</span> server.<span style="color:#66d9ef">await</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">eprintln!</span>(<span style="color:#e6db74">&#34;Server error: </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>, e);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>And run it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cargo run
</span></span></code></pre></div><p>Send some requests with <code>curl</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#34;[fe80::5055:55ff:fe8e:3d07%eth0]:3000&#34;</span>
</span></span><span style="display:flex;"><span>$ curl 192.168.5.15:3000
</span></span><span style="display:flex;"><span>$ curl 127.0.0.1:3000
</span></span></code></pre></div><p>We get the following logs:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Received request from fe80::5055:55ff:fe8e:3d07:44388, is ipv4: false
</span></span><span style="display:flex;"><span>Received request from ::ffff:192.168.5.15:49918, is ipv4: false
</span></span><span style="display:flex;"><span>Received request from ::ffff:127.0.0.1:42254, is ipv4: false
</span></span></code></pre></div><p>where you can see that IPv4-mapped addresses are shown as is, and the <code>is_ipv4()</code> method returns <code>false</code> for them.</p>
<h3 id="612-multiple-listening-sockets-with-systemd">
  6.1.2 Multiple listening sockets with <code>systemd</code>
  <a class="anchor" href="#612-multiple-listening-sockets-with-systemd">#</a>
</h3>
<p>One more side note about multiple listener sockets.</p>
<p>There are many cases when an application can’t use a wildcard address due to security concerns and should bind to a number of specific addresses, regardless of the address family. In such cases, you don’t have many options other than creating and managing multiple accept sockets. If you have such a task, consider looking into the <code>systemd</code> socket activation feature, which can simplify socket creation and provide all the benefits of <code>systemd</code>.</p>
<p><code>Go</code> server example which gets listeners directly from <code>systemd</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/coreos/go-systemd/v22/activation&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">handleConnection</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">buf</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Error reading from connection:&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Received: %s\n&#34;</span>, string(<span style="color:#a6e22e">buf</span>[:<span style="color:#a6e22e">n</span>]))
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">&#34;Hello from Go!\n&#34;</span>))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Retrieve sockets from systemd</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">listeners</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">activation</span>.<span style="color:#a6e22e">Listeners</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintf</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stderr</span>, <span style="color:#e6db74">&#34;Error retrieving listeners: %v\n&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">listeners</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintln</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stderr</span>, <span style="color:#e6db74">&#34;No sockets to listen on.&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Exit</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Listen for connections on each socket</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">listener</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">listeners</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">l</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listener</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">l</span>.<span style="color:#a6e22e">Accept</span>()
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Error accepting connection:&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">go</span> <span style="color:#a6e22e">handleConnection</span>(<span style="color:#a6e22e">conn</span>)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }(<span style="color:#a6e22e">listener</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Block the main goroutine to keep the program running</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">select</span> {}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Socket file <code>/etc/systemd/system/go-service.socket</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[Unit]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">Sockets for Go service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Socket]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ListenStream</span><span style="color:#f92672">=</span><span style="color:#e6db74">127:0.0.1:12345</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ListenStream</span><span style="color:#f92672">=</span><span style="color:#e6db74">192.168.1.1:23456</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ListenStream</span><span style="color:#f92672">=</span><span style="color:#e6db74">[fe80::5055:55ff:fe8e:3d07]:34567</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Install]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">sockets.target</span>
</span></span></code></pre></div><p><code>systemd</code> service unit file <code>/etc/systemd/system/go-service.service</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[Unit]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Description</span><span style="color:#f92672">=</span><span style="color:#e6db74">Your Go service</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">After</span><span style="color:#f92672">=</span><span style="color:#e6db74">network.target</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Service]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ExecStart</span><span style="color:#f92672">=</span><span style="color:#e6db74">/path/to/your/go/program</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NonBlocking</span><span style="color:#f92672">=</span><span style="color:#e6db74">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">[Install]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">WantedBy</span><span style="color:#f92672">=</span><span style="color:#e6db74">multi-user.target</span>
</span></span></code></pre></div><blockquote class="book-hint warning">
  Both above files should have the same name before the dot!
</blockquote>

<p>Reload and start the service and the socket:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo systemctl daemon-reload
</span></span><span style="display:flex;"><span>$ sudo systemctl enable go-service.socket
</span></span><span style="display:flex;"><span>$ sudo systemctl start go-service.socket
</span></span></code></pre></div><h2 id="62-dual-stack-client">
  6.2 Dual stack client
  <a class="anchor" href="#62-dual-stack-client">#</a>
</h2>
<p>Dual stack client applications are usually more complex than the server side in terms of address agnosticism. In server code <code>getaddrinfo()</code> calls can be reasonably slow or even omitted, with sockets created manually (which is not a good practice). But, client code often needs to re-resolve hostnames periodically. For instance, a load balancer needs to understand if there are new backend updates from a service discovery. One of the issues arising from this is the overhead of performing an additional DNS request for an unconfigured network stack (unfortunately, this is often still IPv6), which might add unnecessary delays and increase DNS traffic without any benefits.</p>
<p>Another complexity lies behind <code>getaddrinfo()</code>. Its calls are blocking (we will look at asynchronous alternatives in the next chapter). The blocking nature leads to the following issues:</p>
<ul>
<li>If you set the <code>AF_UNSPEC</code> family, which you probably should in order to be dual stack and IPv6 ready, you could wait longer if your resolver is periodically slow. This issue arises from the design of <code>getaddrinfo()</code>, which always waits for two answers for <code>A</code> and <code>AAAA</code> queries in this case. Even if one answer has already arrived, it will wait until the arrival of the second one or until a timeout form <code>/etc/resolv.conf</code>.</li>
<li>Avoid setting <code>AF_UNSPEC</code> and instead make two asynchronous calls with some logic and timeouts on top, though this can be cumbersome and difficult to do properly.</li>
</ul>
<p>The <code>AI_ADDRCONFIG</code> <code>hints</code> flag is intended to help mitigate such issues and reduce traffic and latency. However, there is an important caveat with its heuristics. First, let’s read the section of man page for <code>getaddrinfo()</code>:</p>
<blockquote>
<p>If <code>hints.ai_flags</code> includes the <code>AI_ADDRCONFIG</code> flag, then IPv4 addresses are returned in the list pointed to by res only if the local system has at least one IPv4 address configured, and IPv6 addresses are returned only if the local system has at least one IPv6 address configured.  The loopback address is not considered for this case as valid as a configured address.</p></blockquote>
<p>The exception is made only for loopback addresses. Any other IPv6 addresses are considered valid, even for link-local scoped addresses, which are configured automatically when a link is up.</p>
<p>The conclusion is not favorable; the <code>AI_ADDRCONFIG</code> flag could potentially be useful only with IPv6-only hosts with a fully disabled IPv4 stack (because autoconfigured IPv4 addresses are also valid addresses) or IPv4 only.</p>
<p>But thanks to <a href="https://datatracker.ietf.org/doc/html/rfc6724" target="_blank" rel="noopener">RFC 6724</a>’s sorting algorithm (discussed in the next chapter) – which includes Rule 2: Prefer matching scope in Section 6 – the return order will prefer IPv4 over IPv6 if there are no global scope IPv6 source addresses on the device. Which we already saw with our getaddrinfo() experiments in Chapter 3.</p>
<p>The <code>AI_ADDRCONFIG</code> is enabled by default (<code><a href="https://man7.org/linux/man-pages/man3/getaddrinfo.3.html" target="_blank" rel="noopener">man 3 getaddrinfo</a></code>):</p>
<blockquote>
<p>Specifying hints as <code>NULL</code> is equivalent to setting <code>ai_socktype</code> and <code>ai_protocol</code> to 0; <code>ai_family</code> to <code>AF_UNSPEC</code>; and ai_flags to (<code>AI_V4MAPPED | AI_ADDRCONFIG</code>).</p></blockquote>
<p>which violates POSIX, but helps to improve user experience:</p>
<blockquote>
<p>According to POSIX.1, specifying hints as NULL should cause <code>ai_flags</code> to be assumed as 0. The GNU C library instead assumes a value of (<code>AI_V4MAPPED | AI_ADDRCONFIG</code>) for this case, since this value is considered an improvement on the specification.</p></blockquote>
<p>If we look under the hood, how <code>getaddrinfo()</code> manages to figure out existing addresses, we will see the<code><a href="https://codebrowser.dev/glibc/glibc/sysdeps/unix/sysv/linux/check_pf.c.html#__check_pf" target="_blank" rel="noopener">__check_pf()</a></code> function. It has a cache for the responses, and in case of a cache miss or a stale entry,  it connects to  <code>NETLINK</code> socket and queries routing information, which is parsed in the <code><a href="https://codebrowser.dev/glibc/glibc/sysdeps/unix/sysv/linux/check_pf.c.html#make_request" target="_blank" rel="noopener">make_request()</a></code> function afterwords to find an answer:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span>attribute_hidden
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">__check_pf</span> (<span style="color:#66d9ef">bool</span> <span style="color:#f92672">*</span>seen_ipv4, <span style="color:#66d9ef">bool</span> <span style="color:#f92672">*</span>seen_ipv6,
</span></span><span style="display:flex;"><span>	    <span style="color:#66d9ef">struct</span> in6addrinfo <span style="color:#f92672">**</span>in6ai, <span style="color:#66d9ef">size_t</span> <span style="color:#f92672">*</span>in6ailen)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">…</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">cache_valid_p</span> ())
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      data <span style="color:#f92672">=</span> cache;
</span></span><span style="display:flex;"><span>      <span style="color:#960050;background-color:#1e0010">…</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">int</span> fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">__socket</span> (PF_NETLINK, SOCK_RAW <span style="color:#f92672">|</span> SOCK_CLOEXEC, NETLINK_ROUTE);
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">…</span>
</span></span><span style="display:flex;"><span>     data <span style="color:#f92672">=</span> <span style="color:#a6e22e">make_request</span> (fd, nladdr.nl_pid);
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">…</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">…</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (data <span style="color:#f92672">!=</span> NULL)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">/* It worked.  */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>seen_ipv4 <span style="color:#f92672">=</span> data<span style="color:#f92672">-&gt;</span>seen_ipv4;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>seen_ipv6 <span style="color:#f92672">=</span> data<span style="color:#f92672">-&gt;</span>seen_ipv6;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>in6ailen <span style="color:#f92672">=</span> data<span style="color:#f92672">-&gt;</span>in6ailen;
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">*</span>in6ai <span style="color:#f92672">=</span> data<span style="color:#f92672">-&gt;</span>in6ai;
</span></span><span style="display:flex;"><span>      <span style="color:#960050;background-color:#1e0010">…</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* We cannot determine what interfaces are available.  Be
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     pessimistic.  */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>seen_ipv4 <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>seen_ipv6 <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Another somewhat confusing <code>getaddrinfo()</code> <code>hints</code> flags is <code>AI_V4MAPPED</code>. <a href="https://datatracker.ietf.org/doc/html/rfc3493#section-3.7" target="_blank" rel="noopener">RFC 3493 Basic Socket Interface Extensions for IPv6</a> where <code>getaddrinfo()</code> was introduced explains it a bit:</p>
<blockquote>
<p>If the <code>AI_V4MAPPED</code> flag is specified along with an ai_family of <code>AF_INET6</code>, then <code>getaddrinfo()</code> shall return IPv4-mapped IPv6 addresses on finding no matching IPv6 addresses (<code>ai_addrlen</code> shall be 16).</p>
<p>For example, when using the DNS, if no <code>AAAA</code> records are found then a query is made for <code>A</code> records and any found are returned as IPv4-mapped IPv6 addresses.</p>
<p>The <code>AI_V4MAPPED</code> flag shall be ignored unless ai_family equals <code>AF_INET6</code>.</p>
<p>If the <code>AI_ALL</code> flag is used with the <code>AI_V4MAPPED</code> flag, then <code>getaddrinfo()</code> shall return all matching IPv6 and IPv4 addresses.</p>
<p>For example, when using the DNS, queries are made for both <code>AAAA</code> records and <code>A</code> records, and <code>getaddrinfo()</code> returns the combined results of both queries.  Any IPv4 addresses found are returned as IPv4-mapped IPv6 addresses.</p></blockquote>
<p>Thus the <code>AI_V4MAPPED</code> could help write a tool which wants to deal only with addresses in IPv6 format.</p>
<blockquote class="book-hint info">
  For IPv6-only hosts with no IPv4 connectivity, there is no routing for IPv4-mapped addresses because they are a special case in the IPv6 address space. If you need to route such addresses, you can, for instance, set up <code><a href="https://en.wikipedia.org/wiki/NAT64" target="_blank" rel="noopener">NAT64</a></code>.
</blockquote>

<p>So, we have addresses now, but in what order should we try to connect to them? As usual, there is no silver bullet (we will take a look at <code>Nginx</code> and <code>Envoy</code>, which address this issue from different angles). However, there are two main views on this problem:</p>
<ol>
<li>
<p>Consider all addresses returned for a hostname as different ways to communicate with the same entity (it could be a multi-address host, service, website, etc.). Sometimes it’s also called a multihomed host:</p>
<blockquote class="book-hint info">
  A multihomed host is a computer or device that is connected to two or more networks and can be identified by multiple IP addresses, typically associated with different network interfaces. This configuration is common in scenarios requiring redundancy, load balancing, or enhanced security.
</blockquote>

<p>Connecting to any of the returned addresses ends up at the same entity.
For example, if a host has both an IPv4 and an IPv6 address and our client is dual-stack, it doesn’t matter via which protocol a connection is established from the user’s point of view.</p>
</li>
<li>
<p>Consider addresses returned as different entities under one domain name. This is now a Service Discovery via DNS rather than exploring different paths.
For example <code><a href="https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/#discovery-for-specific-pods-in-a-statefulset" target="_blank" rel="noopener">StatefulSet pod names in Kubernetes in DNS</a></code>.</p>
</li>
</ol>
<p>The second option is kind of straightforward, and we will not talk about it much in this series. The client side code should implement a load balancer algorithm, use all the records as its backends, periodically refresh the records, and filter out some suspicious addresses (for example, link-local scope addresses).</p>
<p>But the first option has more subtle details that we need to discuss. Let’s start with the sorting problem.</p>
<h3 id="621-sorting-destination-addresses-rfc-6724">
  6.2.1 Sorting destination addresses (RFC 6724)
  <a class="anchor" href="#621-sorting-destination-addresses-rfc-6724">#</a>
</h3>
<p>As we already saw and know, a hostname could be resolved into multiple <code>A</code> and/or <code>AAAA</code> addresses.</p>
<p>The issue is in which order to iterate through all of them (basically in which order <code>getaddrinfo()</code> or its alternatives return the result).</p>
<p>Let’s not forget that the original goal of introducing IPv6 addresses was to migrate to them as soon as possible. Over time, this has evolved to a goal of eventually migrating. With this in mind, it makes sense to prioritize returning IPv6 addresses first, if they exist, and IPv4 addresses next. This approach was standardized in <a href="https://datatracker.ietf.org/doc/html/rfc3484" target="_blank" rel="noopener">RFC 3484</a> and later updated in <a href="https://datatracker.ietf.org/doc/html/rfc6724" target="_blank" rel="noopener">RFC  6724: Default Address Selection for Internet Protocol Version 6 (IPv6)</a>. These RFCs provide two algorithms for address selection: one for source address selection (which occurs inside the Linux kernel and won’t be covered in detail here) and the destination address selection algorithm described in <a href="https://datatracker.ietf.org/doc/html/rfc6724#section-6" target="_blank" rel="noopener">Section 6</a> of the document.</p>
<p>Thus, in order to seamlessly and smoothly migrate a dual-stack application from IPv4 to IPv6, it should follow <a href="https://datatracker.ietf.org/doc/html/rfc6724" target="_blank" rel="noopener">RFC 6724</a> and behave well, where:</p>
<blockquote>
<p>Well-behaved applications SHOULD NOT simply use the first address returned from an API such as getaddrinfo() and then give up if it fails.  For many applications, it is appropriate to iterate through the list of addresses returned from <code>getaddrinfo()</code> until a working address is found.  For other applications, it might be appropriate to try multiple addresses in parallel (e.g., with some small delay in between) and use the first one to succeed.</p></blockquote>
<p>So the algorithm is the following:</p>
<div class="text-center">


<script src="/mermaid.min.js"></script>

  <script>mermaid.initialize({
  "flowchart": {
    "useMaxWidth":true
  },
  "theme": "default"
}
)</script>




<p class="mermaid optional">

flowchart TD

   Rule1[Rule 1: Avoid unusable destinations]

   Rule2[Rule 2: Prefer matching scope]

   Rule3[Rule 3: Avoid deprecated addresses]

   Rule4[Rule 4: Prefer home addresses]

   Rule5[Rule 5: Prefer matching label]

   Rule6[Rule 6: Prefer higher precedence]

   Rule7[Rule 7: Prefer native transport]

   Rule8[Rule 8: Prefer smaller scope]

   Rule9[Rule 9: Use longest matching prefix]

   Rule10[Rule 10: Otherwise, leave the order unchanged]

   Rule1 --> Rule2 --> Rule3 --> Rule4 --> Rule5

   Rule5 --> Rule6 --> Rule7 --> Rule8 --> Rule9 --> Rule10

</p>

<p>Figure 3. – Destination address selection algorithm RFC  6724</p>
</div>
<p>Let me provide a quick explanation with examples. To sort addresses, a comparator function is used. This function takes two addresses and determines which one wins based on a series of rules. If the first rule results in a tie, the next rule is applied, and so on.</p>
<p>The algorithm employs terms introduced in various RFCs, including:</p>
<ul>
<li>address scopes;</li>
<li>IPv6 address types;</li>
<li>policy table with a configuration file.</li>
</ul>
<p>But before we start, let’s take a closer look at each of these components.</p>
<blockquote>
<p>The IPv6 addressing architecture [RFC4291] allows multiple unicast addresses to be assigned to interfaces. These addresses might have different reachability scopes (link-local, site-local, or global).</p></blockquote>
<p>Here we need to quickly remind ourselves what scopes are there:</p>
<ul>
<li>host scope – <code>::1</code> and <code>127.0.0.1</code></li>
<li>link-local scope –  <code>fe80::/10</code> and <code>169.254.0.0/16 </code></li>
<li>unique Local Address (ULA) scope – <code>fc00::/7</code></li>
<li>global scope – all other addresses (for IPv6 usually starts with <code>2000::/3</code>), including IPv4 private networks such as <code>192.168.0.0/16</code>, <code>172.16.0.0/12</code> and <code>10.0.0.0/8</code>.</li>
</ul>
<blockquote>
<p>These addresses might also be &ldquo;preferred&rdquo; or &ldquo;deprecated&rdquo; [<a href="https://datatracker.ietf.org/doc/html/rfc4862" target="_blank" rel="noopener">RFC4862</a>]. Privacy considerations have introduced the concepts of &ldquo;public addresses&rdquo; and &ldquo;temporary addresses&rdquo; [<a href="https://datatracker.ietf.org/doc/html/rfc4941" target="_blank" rel="noopener">RFC4941</a>].  The mobility architecture introduces &ldquo;home addresses&rdquo; and &ldquo;care-of addresses&rdquo;  [<a href="https://datatracker.ietf.org/doc/html/rfc6275" target="_blank" rel="noopener">RFC6275</a>].</p></blockquote>
<p>Policy table is an auxiliary data structure to help sort source and destination addresses. It has a default value:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Prefix        Precedence Label
</span></span><span style="display:flex;"><span>::1/128               <span style="color:#ae81ff">50</span>     <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>::/0                  <span style="color:#ae81ff">40</span>     <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>::ffff:0:0/96         <span style="color:#ae81ff">35</span>     <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>2002::/16             <span style="color:#ae81ff">30</span>     <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>2001::/32              <span style="color:#ae81ff">5</span>     <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>fc00::/7               <span style="color:#ae81ff">3</span>    <span style="color:#ae81ff">13</span>
</span></span><span style="display:flex;"><span>::/96                  <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>fec0::/10              <span style="color:#ae81ff">1</span>    <span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span>3ffe::/16              <span style="color:#ae81ff">1</span>    <span style="color:#ae81ff">12</span>
</span></span></code></pre></div><p>and could be tuned by changing <code>/etc/gai.conf</code> (<code><a href="https://man7.org/linux/man-pages/man5/gai.conf.5.html" target="_blank" rel="noopener">man 5 gai.conf</a></code>).</p>
<blockquote>
<p>2.1.  Policy Table</p>
<p>The policy table is a longest-matching-prefix lookup table, much like a routing table.  Given an address A, a lookup in the policy table produces two values: a precedence value denoted Precedence(A) and a classification or label denoted Label(A).</p>
<p>The precedence value Precedence(A) is used for sorting destination addresses.  If Precedence(A) &gt; Precedence(B), we say that address A has higher precedence than address B, meaning that our algorithm will prefer to sort destination address A before destination address B.</p>
<p>The label value Label(A) allows for policies that prefer a particular source address prefix for use with a destination address prefix.  The algorithms prefer to use a source address S with a destination address D if Label(S) = Label(D).</p></blockquote>
<p>Also the destination address selection algorithm  needs to know a source address for the destination address. We will review how a stub resolver can obtain thin information later in this chapter.</p>
<blockquote>
<ol start="5">
<li>Source Address Selection</li>
</ol>
<p>The source address selection algorithm produces as output a single source address for use with a given destination address.  This algorithm only applies to IPv6 destination addresses, not IPv4 addresses.</p></blockquote>
<p>Now we can review the rules with examples.</p>
<p><strong>Rule 1  Avoid unusable destinations.</strong></p>
<p>If a stub resolver knows that a destination address is unreachable, it should deprioritize (pessimize) it.</p>
<p>Example: if a stub resolver has a cache and/or health checks mechanism, or history of connections, it can immediately pessimize an address.</p>
<p><strong>Rule 2: Prefer matching scope.</strong></p>
<p>Retrieve source addresses for the destination addresses under consideration and compare the scopes of each pair. If the scopes match for a pair, prioritize that destination address.</p>
<p>Example: DNS returned <code>203.0.113.1</code> and <code>2001:0db8:0:1::1</code>. The system has <code>192.168.0.2</code> and a link-local IPv6 address. The result will be <code>[203.0.113.1, 2001:0db8:0:1::1]</code> because <code>192.168.0.2</code> and <code>203.0.113.1</code> are both global scoped addresses.</p>
<p><strong>Rule 3: Avoid deprecated addresses.</strong></p>
<p>Retrieve source addresses for the destination addresses under consideration. If a source address is marked as deprecated for a pair, deprioritize (pessimize) the corresponding destination address.</p>
<p><strong>Rule 4: Prefer home addresses.</strong></p>
<p>It’s related to mobile home and care-of addresses. A home address should win.</p>
<p><strong>Rule 5: Prefer matching label.</strong></p>
<p>Retrieve source addresses for the destination addresses under consideration. If a pair has equal labels in the policy table, prioritize (bump) the related destination address.</p>
<p>Example: DNS returned <code>2002:c633:6401::1</code> or <code>2001:db8:1::1</code>. The source address for the first is <code>2002:c633:6401::2</code> and for the second is <code>fe80::2</code>. The result is <code>[2002:c633:6401::1, 2001:db8:1::1]</code> because label is the same for a pair <code>2002:c633:6401::1</code> and <code>2002:c633:6401::2</code> and is <code>1</code>.</p>
<p><strong>Rule 6: Prefer higher precedence.</strong></p>
<p>Perform the same steps as above, but compare the Precedence values of the two destination addresses only.</p>
<p>Example: DNS returned <code>203.0.113.1</code> and <code>2001:0db8:0:1::1</code>. The result is <code>[</code> <code>2001:0db8:0:1::1, 203.0.113.1]</code>. The precedence for  <code>2001:0db8:0:1::1</code> is <code>40</code>, and for <code>203.0.113.1</code> is <code>35</code>.</p>
<p><strong>Rule 7: Prefer native transport.</strong></p>
<p>Always prefer a non-encapsulated destination address.</p>
<p><strong>Rule 8: Prefer smaller scope.</strong></p>
<p>Compare the scopes of the destination addresses under consideration and select the one with the smallest scope.</p>
<p>Example: DNS returned <code>2001:0db8:0:1::1</code> and  <code>fe80::2</code>. The result is <code>[fe80::2, 2001:0db8:0:1::1]</code>. The link local scope is smaller.</p>
<p><strong>Rule 9: Use longest matching prefix.</strong></p>
<p>Retrieve source addresses for the destination addresses under consideration and compare the longest matching prefixes between each pair.</p>
<p>Example:  DNS returned <code>2001:db8:1::1</code> and  <code>2001:db8:3ffe::1</code>. Sources are <code>2001:db8:1::2</code> and  <code>2001:db8:3f44::2</code>. The result is <code>[2001:db8:1::1,  2001:db8:3ffe::1]</code>. The longest matching prefix wins for the pair of <code>2001:db8:1::1</code> and <code>2001:db8:1::2</code>.</p>
<p><strong>Rule 10: Otherwise, leave the order unchanged.</strong></p>
<p>Preserve the order provided by the DNS server, allowing for possible <a href="https://en.wikipedia.org/wiki/Round-robin_DNS" target="_blank" rel="noopener">Round-robin DNS</a>.</p>
<p>One important implication from the above is that IPv6 usually takes precedence over IPv4 due to the higher default precedence in the policy table (<code><a href="https://man7.org/linux/man-pages/man5/gai.conf.5.html" target="_blank" rel="noopener">man 5 gai.conf</a></code>). If you do not want this behavior, you can change it by adding the following line to <code>/etc/gai.conf</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>precedence ::ffff:0:0/96  <span style="color:#ae81ff">100</span>
</span></span></code></pre></div><p>This line sets a precedence of 100 for the IPv4-mapped range. This adjustment is likely the only practical use of <code>/etc/gai.conf</code> since distributing changes across multiple machines is difficult and unreliable. However, be aware that not all stub resolvers read this configuration file.</p>
<h4 id="6211-retrieve-source-address-for-destination-address">
  6.2.1.1 Retrieve Source address for Destination address
  <a class="anchor" href="#6211-retrieve-source-address-for-destination-address">#</a>
</h4>
<p>Let’s now explore the details of how to obtain a source address for a given destination.</p>
<p>The algorithm is using a feature of <code>connect</code> (<code><a href="https://man7.org/linux/man-pages/man2/connect.2.html" target="_blank" rel="noopener">man 2 connect</a></code>) syscall for <code>SOCK_DGRAM</code> (<code>UDP</code>) sockets:</p>
<blockquote>
<p>If the socket <code>sockfd</code> is of type <code>SOCK_DGRAM</code>, then <code>addr</code> is the address to which datagrams are sent by default, and the only address from which datagrams are received.</p></blockquote>
<p>But what  is more interesting for us is that we can run <code>getsockname</code> (<code><a href="https://man7.org/linux/man-pages/man2/getsockname.2.html" target="_blank" rel="noopener">man 2 getsockname</a></code>) afterwards for the file descriptor and get the source address for the destination:</p>
<blockquote>
<p><code>getsockname()</code> returns the current address to which the socket <code>sockfd</code> is bound, in the buffer pointed to by <code>addr</code>.</p></blockquote>
<p>All code lives for <code>getaddrinfo()</code> of <code>glibc</code> <a href="https://codebrowser.dev/glibc/glibc/nss/getaddrinfo.c.html#2471" target="_blank" rel="noopener">here</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* We overwrite the type with SOCK_DGRAM since we do not
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> want connect() to connect to the other side.  If we
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> cannot determine the source address remember this
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> fact. */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (fd <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">||</span> (af <span style="color:#f92672">==</span> AF_INET <span style="color:#f92672">&amp;&amp;</span> q<span style="color:#f92672">-&gt;</span>ai_family <span style="color:#f92672">==</span> AF_INET6))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (fd <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__close_nocancel_nostatus</span> (fd);
</span></span><span style="display:flex;"><span>  af <span style="color:#f92672">=</span> q<span style="color:#f92672">-&gt;</span>ai_family;
</span></span><span style="display:flex;"><span>  fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">__socket</span> (af, SOCK_DGRAM <span style="color:#f92672">|</span> SOCK_CLOEXEC, IPPROTO_IP);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/* Reset the connection.  */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> sockaddr sa <span style="color:#f92672">=</span> { .sa_family <span style="color:#f92672">=</span> AF_UNSPEC };
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">__connect</span> (fd, <span style="color:#f92672">&amp;</span>sa, <span style="color:#66d9ef">sizeof</span> (sa));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">try_connect</span> (<span style="color:#f92672">&amp;</span>fd, <span style="color:#f92672">&amp;</span>af, <span style="color:#f92672">&amp;</span>results[i].source_addr, q<span style="color:#f92672">-&gt;</span>ai_addr,
</span></span><span style="display:flex;"><span>	       q<span style="color:#f92672">-&gt;</span>ai_addrlen, q<span style="color:#f92672">-&gt;</span>ai_family))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  results[i].source_addr_len <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span> (results[i].source_addr);
</span></span><span style="display:flex;"><span>  results[i].got_source_addr <span style="color:#f92672">=</span> true;
</span></span></code></pre></div><p>The results array is used next to sort:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* We got all the source addresses we can get, now sort using
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 the information.  */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sort_result_combo src
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">=</span> { .results <span style="color:#f92672">=</span> results, .nresults <span style="color:#f92672">=</span> nresults };
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">__glibc_unlikely</span> (gaiconf_reload_flag_ever_set))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>	  <span style="color:#a6e22e">__libc_lock_define_initialized</span> (<span style="color:#66d9ef">static</span>, lock);
</span></span><span style="display:flex;"><span>	  <span style="color:#a6e22e">__libc_lock_lock</span> (lock);
</span></span><span style="display:flex;"><span>	  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">__libc_once_get</span> (old_once) <span style="color:#f92672">&amp;&amp;</span> gaiconf_reload_flag)
</span></span><span style="display:flex;"><span>	    <span style="color:#a6e22e">gaiconf_reload</span> ();
</span></span><span style="display:flex;"><span>	  <span style="color:#a6e22e">__qsort_r</span> (order, nresults, <span style="color:#66d9ef">sizeof</span> (order[<span style="color:#ae81ff">0</span>]), rfc3484_sort, <span style="color:#f92672">&amp;</span>src);
</span></span><span style="display:flex;"><span>	  <span style="color:#a6e22e">__libc_lock_unlock</span> (lock);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">__qsort_r</span> (order, nresults, <span style="color:#66d9ef">sizeof</span> (order[<span style="color:#ae81ff">0</span>]), rfc3484_sort, <span style="color:#f92672">&amp;</span>src);
</span></span></code></pre></div><p>Where <code><a href="https://codebrowser.dev/glibc/glibc/nss/getaddrinfo.c.html#rfc3484_sort" target="_blank" rel="noopener">rfc3484_sort</a></code> contains all 10 rules from the RFC.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">rfc3484_sort</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>p1, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>p2, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>arg)
</span></span></code></pre></div><p>The retrieval of source addresses involves at least two syscalls for each destination address. This overhead should be considered if performance is crucial. For example, the alternative stub resolver <code>c-ares</code> (which we will review later) allows the option to disable sorting by RFC 6724.</p>
<p>If we run the above program under <code>strace</code> we will see all the calls:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ strace -f -s0 -e trace<span style="color:#f92672">=</span>network ./getaddrinfo microsoft.com
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>…
</span></span><span style="display:flex;"><span>① socket<span style="color:#f92672">(</span>AF_INET6, SOCK_DGRAM|SOCK_CLOEXEC, IPPROTO_IP<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>② connect<span style="color:#f92672">(</span>3, <span style="color:#f92672">{</span>sa_family<span style="color:#f92672">=</span>AF_INET6, sin6_port<span style="color:#f92672">=</span>htons<span style="color:#f92672">(</span>53<span style="color:#f92672">)</span>, sin6_flowinfo<span style="color:#f92672">=</span>htonl<span style="color:#f92672">(</span>0<span style="color:#f92672">)</span>, inet_pton<span style="color:#f92672">(</span>AF_INET6, <span style="color:#e6db74">&#34;2603:1030:b:3::152&#34;</span>, &amp;sin6_addr<span style="color:#f92672">)</span>, sin6_scope_id<span style="color:#f92672">=</span>0<span style="color:#f92672">}</span>, 28<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>③ getsockname<span style="color:#f92672">(</span>3, <span style="color:#f92672">{</span>sa_family<span style="color:#f92672">=</span>AF_INET6, sin6_port<span style="color:#f92672">=</span>htons<span style="color:#f92672">(</span>47754<span style="color:#f92672">)</span>, sin6_flowinfo<span style="color:#f92672">=</span>htonl<span style="color:#f92672">(</span>0<span style="color:#f92672">)</span>, inet_pton<span style="color:#f92672">(</span>AF_INET6, <span style="color:#e6db74">&#34;2001:db8:123:456:6af2:68fe:ff7c:e25c&#34;</span>, &amp;sin6_addr<span style="color:#f92672">)</span>, sin6_scope_id<span style="color:#f92672">=</span>0<span style="color:#f92672">}</span>, <span style="color:#f92672">[</span>28<span style="color:#f92672">])</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>④ connect<span style="color:#f92672">(</span>3, <span style="color:#f92672">{</span>sa_family<span style="color:#f92672">=</span>AF_UNSPEC, sa_data<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;\0\0\0\0\0\0\0\0\0\0\0\0\0\0&#34;</span><span style="color:#f92672">}</span>, 16<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>…
</span></span></code></pre></div><p>① – create a UDP socket to connect to the destination;</p>
<p>② – connect to it;</p>
<p>③ – obtaining the source address;</p>
<p>④ – reset socket by using <code>connect()</code> to <code>AF_UNSPEC</code>.</p>
<h3 id="622-happy-eyeballs-success-with-dual-stack-hosts">
  6.2.2 Happy Eyeballs: Success with Dual-Stack Hosts
  <a class="anchor" href="#622-happy-eyeballs-success-with-dual-stack-hosts">#</a>
</h3>
<p>We have yet to address a very crucial issue: the reliability of IPv6 network routing in the real world. This problem is so significant that it has been a major obstacle to migration, leading to the development of new RFCs to promote IPv6 adoption.</p>
<p>From the <a href="https://datatracker.ietf.org/doc/html/rfc6555" target="_blank" rel="noopener">RFC 6555 Happy Eyeballs: Success with Dual-Stack Hosts</a>:</p>
<blockquote>
<p>In order to use applications over IPv6, it is necessary that users enjoy nearly identical performance as compared to IPv4.  A combination of today&rsquo;s applications, IPv6 tunneling, IPv6 service  providers, and some of today&rsquo;s content providers all cause the user experience to suffer.  For IPv6, a content provider may  ensure a positive user experience by using a DNS white list of IPv6  service providers who peer directly with them. However, this does not scale well (to the number of DNS servers worldwide or the number of content providers worldwide) and does  react to intermittent network path outages.</p></blockquote>
<p>To addresses this issue, let’s revisit the following quote from  <a href="https://datatracker.ietf.org/doc/html/rfc6724" target="_blank" rel="noopener">RFC  6724: Default Address Selection for Internet Protocol Version 6 (IPv6)</a> first:</p>
<blockquote>
<p>Well-behaved applications SHOULD NOT simply use the first address returned from an API such as getaddrinfo() and then give up if it fails.  For many applications, it is appropriate to iterate through the list of addresses returned from <code>getaddrinfo()</code> until a working address is found.  <strong>For other applications, it might be appropriate to try multiple addresses in parallel (e.g., with some small delay in between) and use the first one to succeed.</strong></p></blockquote>
<p>The last sentence essentially captures the gist of the Happy Eyeballs algorithm: when it is impossible to determine the state of the network in advance, but the system is configured correctly with both global scope IP families, the only option is to use both families concurrently, with some preference given to IPv6.</p>
<p>There are two RFCs about Happy Eyeballs algorithm:</p>
<ol>
<li><a href="https://datatracker.ietf.org/doc/html/rfc6555" target="_blank" rel="noopener">RFC 6555 Happy Eyeballs: Success with Dual-Stack Hosts</a> (obsoleted by RFC 8305 ↓).</li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc8305" target="_blank" rel="noopener">RFC 8305 Happy Eyeballs Version 2: Better Connectivity Using Concurrency</a></li>
</ol>
<p>The motivation for the emergence of the above RFCs was the desire to create a standardized algorithm that prioritizes IPv6 addresses. This was necessary to combat the variety of existing algorithms that did not prioritize IPv6, thereby failing to encourage infrastructure upgrades and reduce reliance on outdated IPv4 hardware. Additionally, making numerous concurrent connections simultaneously can harm the network by overloading network equipment, routers, and servers. As stated in <a href="https://datatracker.ietf.org/doc/html/rfc6555" target="_blank" rel="noopener">RFC 6555</a>:</p>
<blockquote>
<p>Instead, applications reduce connection setup delays themselves, by more aggressively making connections on IPv6 and IPv4.  There are a variety of algorithms that can be envisioned.  This document specifies requirements for any such algorithm, with the goals that the network and servers not be inordinately harmed with a simple doubling of traffic on IPv6 and IPv4 and the host&rsquo;s address preference be honored.</p></blockquote>
<blockquote>
<ol start="4">
<li>Algorithm Requirements</li>
</ol>
<p>A &ldquo;Happy Eyeballs&rdquo; algorithm has two primary goals:</p>
<ol>
<li>
<p>Provides fast connection for users, by quickly attempting to  connect using IPv6 and (if that connection attempt is not quickly successful) to connect using IPv4.</p>
</li>
<li>
<p>Avoids thrashing the network, by not (always) making simultaneous connection attempts on both IPv6 and IPv4</p>
</li>
</ol></blockquote>
<p>By following these not-always-simple rules, you can create a client application that is reliable, flexible, and predictable.</p>
<p>It’s time to look at alternative stub resolvers and examples of real high load software.</p>
<img alt="IPv4 and IPv6" src="../images/dns_two_buttons_pressed.png" width="40%" class="img-center">




  

<a  href="/docs/resolver-dual-stack-application/7-async-non-blocking-resolvers-in-c/"   class="book-btn right-button">
  Read next chapter →
</a>

</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>




 
        <script defer src="/my_js/copy-code.js"></script>

      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
  </main>

  
<div class="cookie-container">
    <p>
        This website uses "<b>cookies</b>".
        Using this website means you're OK with this.
        If you are <b>NOT</b>, please close the site page.
    </p>
    <button class="cookie-btn">
        ACCEPT AND CLOSE
    </button>
</div>
<script src="/my_js/cookie.js"></script>
</body>
</html>












