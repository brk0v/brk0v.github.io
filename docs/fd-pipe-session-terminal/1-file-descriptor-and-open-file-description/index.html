<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="File descriptor and open file description # First of all, I want to touch on the two fundamental concepts of working with files:
file descriptor; open file description. These two abstractions are crucial for understanding the internals of a process creation, communication, and data transition.
The first concept is a file descriptor or fd. It’s a positive integer number used by file system calls instead of a file path in order to make a variety of operations."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="File descriptor and open file description"><meta property="og:description" content="File descriptor and open file description # First of all, I want to touch on the two fundamental concepts of working with files:
file descriptor; open file description. These two abstractions are crucial for understanding the internals of a process creation, communication, and data transition.
The first concept is a file descriptor or fd. It’s a positive integer number used by file system calls instead of a file path in order to make a variety of operations."><meta property="og:type" content="article"><meta property="og:url" content="https://biriukov.dev/docs/fd-pipe-session-terminal/1-file-descriptor-and-open-file-description/"><meta property="article:section" content="docs"><title>File descriptor and open file description | Viacheslav Biriukov</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css integrity="sha256-gsXb0jRHzuC0wqo+0Izglh+qQOH6Nw7uT4yfAuDUa18=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script>
<script defer src=/en.search.min.a3e48feb8fae036a82ad7c002380831ef5636cc24f24a8f2f7716756bcd996a3.js integrity="sha256-o+SP64+uA2qCrXwAI4CDHvVjbMJPJKjy93FnVrzZlqM=" crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-599VSLESJL"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-599VSLESJL")</script><link rel=stylesheet href=/my_css/cookie.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Viacheslav Biriukov</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li class=book-section-flat><span>GNU/Linux shell related internals</span><ul><li><a href=/docs/fd-pipe-session-terminal/0-sre-should-know-about-gnu-linux-shell-related-internals-file-descriptors-pipes-terminals-user-sessions-process-groups-and-daemons/>0. GNU/Linux shell related internals for SRE</a></li><li><a href=/docs/fd-pipe-session-terminal/1-file-descriptor-and-open-file-description/ class=active>1. File descriptor and open file description</a></li><li><a href=/docs/fd-pipe-session-terminal/2-pipes/>2. Pipes</a></li><li><a href=/docs/fd-pipe-session-terminal/3-process-groups-jobs-and-sessions/>3. Process groups, jobs and sessions</a></li><li><a href=/docs/fd-pipe-session-terminal/4-terminals-and-pseudoterminals/>4. Terminals and pseudoterminals</a></li></ul></li></ul><div style=margin-top:30px;margin-bottom:30px><b>More post series:</b><ul><li><a href=/docs/fd-pipe-session-terminal/0-sre-should-know-about-gnu-linux-shell-related-internals-file-descriptors-pipes-terminals-user-sessions-process-groups-and-daemons>1. File descriptors, pipes, terminals, user sessions, process groups and daemons <span style="padding:0 2px;border-radius:2px;background-color:#e84118;color:#f0f8ff">new</span></li><li><a href=/docs/page-cache/0-linux-page-cache-for-sre/>2. Linux Page Cache mini book</li></ul></div><ul><li><a href=https://twitter.com/brk0v/ target=_blank rel=noopener><i class="bi bi-twitter"></i>
Twitter</a></li><li><a href=https://github.com/brk0v/ target=_blank rel=noopener><i class="bi bi-github"></i>
Github</a></li><li><a href=https://www.linkedin.com/in/biriukov/ target=_blank rel=noopener><i class="bi bi-linkedin"></i>
Linkedin</a></li></ul><div style=margin-top:30px><p xmlns:cc=http://creativecommons.org/ns#>This content is licensed under
<a href="http://creativecommons.org/licenses/by-nc/4.0/?ref=chooser-v1" target=_blank rel="license noopener noreferrer" style=display:inline-block>CC BY-NC 4.0<img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1"><img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"><img style=height:22px!important;margin-left:3px;vertical-align:text-bottom src="https://mirrors.creativecommons.org/presskit/icons/nc.svg?ref=chooser-v1"></a></p></div></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>File descriptor and open file description</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#file-descriptor-and-open-file-description>File descriptor and open file description</a><ul><li><a href=#stdin-stdout-and-stderr><code>stdin</code>, <code>stdout</code> and <code>stderr</code></a></li><li><a href=#procfs-and-file-descriptors>Procfs and file descriptors</a></li><li><a href=#sharing-file-descriptors-between-parent-and-child-after-fork>Sharing file descriptors between parent and child after <code>fork()</code></a></li><li><a href=#duplication-of-file-descriptors>Duplication of file descriptors</a></li><li><a href=#execve-and-file-descriptors><code>Execve()</code> and file descriptors</a><ul><li><a href=#o_cloexec><code>O_CLOEXEC</code></a></li></ul></li><li><a href=#check-if-2-file-descriptors-share-the-same-open-file-description-with-kcmp>Check if 2 file descriptors share the same open file description with <code>kcmp()</code></a></li><li><a href=#more-ways-to-transfer-file-descriptors-between-processes-pidfd_getfd-and-unix-datagrams>More ways to transfer file descriptors between processes: <code>pidfd_getfd()</code> and Unix datagrams.</a></li><li><a href=#shell-redirections-and-file-descriptors>Shell redirections and file descriptors</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=file-descriptor-and-open-file-description>File descriptor and open file description
<a class=anchor href=#file-descriptor-and-open-file-description>#</a></h1><p>First of all, I want to touch on the two fundamental concepts of working with files:</p><ul><li><strong>file descriptor;</strong></li><li><strong>open file description</strong>.</li></ul><p>These two abstractions are crucial for understanding the internals of a process creation, communication, and data transition.</p><p>The first concept is a <strong>file descriptor</strong> or <strong><code>fd</code></strong>. It’s a positive integer number used by file system calls instead of a file path in order to make a variety of operations. Every process has its own <strong>file descriptor table</strong> (see Image 1 below). The main idea of a file descriptor is to decouple a file path (or, more correctly, an inode with minor and major device numbers) from a file object inside a process and the Linux kernel. This allows software developers to open the same file an arbitrary number of times for different purposes, with various flags (for instance: <code>O_DIRECT</code>, <code>O_SYNC</code>, <code>O_APPEND</code>, etc.), and at different offsets.</p><p>For example, a program wants to read from and write to one file in two separate places. In this case, it needs to open the file twice. Thus, two new <strong>file descriptors</strong> will refer to 2 different entries in the system-wide <strong>open file description table</strong>.</p><p>In its turn, the <strong>open file description table</strong> is a system-wide kernel abstraction. It stores the file open status flags (<code><a href=https://man7.org/linux/man-pages/man2/open.2.html target=_blank rel=noopener>man 2 open</a></code>) and the file positions (we can use <code><a href=https://man7.org/linux/man-pages/man2/lseek.2.html target=_blank rel=noopener>man 2 lseek</a></code> to change this position).</p><p>Frankly speaking, there is no such thing inside the Linux kernel where we can find the open file description table. To be more accurate, every created process in the kernel has a per-thread struct <code><a href=https://elixir.bootlin.com/linux/v5.18.10/source/include/linux/sched.h#L728 target=_blank rel=noopener>task_struct</a></code>. This struct has a pointer to another structure called the <code><a href=https://elixir.bootlin.com/linux/v5.18.10/source/include/linux/fdtable.h#L49 target=_blank rel=noopener>files_struct</a></code>, and that contains an array of pointers to a <code><a href=https://elixir.bootlin.com/linux/v5.18.10/source/include/linux/fs.h#L932 target=_blank rel=noopener>file</a></code> struct. This final struct is actually what holds all file flags, a current position, and a lot of other information about the open file: such as its type, inode, device, etc. All such entries among all running threads are what we call the <strong>open file descriptor table</strong>.</p><p>So, now let’s see how we can create entities in these two tables. In order to create a new entry in the <strong>open file description table</strong> we need to <strong>open</strong> a file with one of the following syscalls: <code>open</code>, <code>openat</code>, <code>create</code>, <code>open2</code> (<code><a href=https://man7.org/linux/man-pages/man2/open.2.html target=_blank rel=noopener>man 2 open</a></code>). These functions also add a corresponding entry in the <strong>file descriptor table of the calling process</strong>, build a reference between the open file description table entry and the file descriptor table, and return the <strong>lowest positive number not currently opened by the calling process</strong>. The latest statement is very important to remember and understand because it means that a <strong>fd</strong> number <strong>can</strong> <strong>be reused during the process life </strong>if it opens and closes files in an arbitrary order.</p><p>Linux kernel also provides an API to create copies of a <strong>file descriptor</strong> within a process. We will discuss why this technique can be helpful in a few minutes. For now, let’s just list them here: <code>dup</code>, <code>dup2</code>, <code>dup3</code> (<code><a href=https://man7.org/linux/man-pages/man2/dup.2.html target=_blank rel=noopener>man 2 dup</a></code>) and <code>fcntl</code> (<code><a href=https://man7.org/linux/man-pages/man2/fcntl.2.html target=_blank rel=noopener>man 2 fcntl</a></code>) with <code>F_DUPFD</code> flag. All these syscalls create a new reference in the fd table of the process to the existing entry in the system-wide open file description table.</p><p>Let’s take a closer look at an example in the image below with a snapshot of a system state. The image shows us possible relations among all the above components.</p><img alt="Relationship between process file descriptors, system-wide open file description table and files" src=../images/file-descriptor-open-file-description.png class=img-center><div class=text-center>Image 1. – Relations between process file descriptors, system-wide open file description table and files</div><p>❶ – The first three file descriptors (<code>stdin</code>, <code>stdout</code> and <code>stderr</code>) are special file descriptors. We will work with them later in this post. This example shows that all three point to a pseudoterminal (<code>/dev/pts/0</code>). These files don’t have positions due to their character device type. Thus process_1 and process_2 must be running under the terminal sessions. Please, note that the <code>stdout</code> of the process_2 (fd 1) points to the file on a disk <code>/tmp/out.log</code>. This is an example of shell redirection; we will discuss it later.</p><p>❷ – Some file descriptors can have per-process flags. Nowadays, there is only one such flag: close-on-exec (<code>O_CLOEXEC</code>). We will discuss it later in this section and answer why it’s so unique. But for now, you should understand that some file descriptors may have it for the same system-wide open file description table entries. For instance: process_1 and its fd 9 and process_2 and its fd 3.</p><p>❸ – Even though the file descriptor algorithm constantly reuses the file descriptors and allocates them sequentially from the lowest available, it doesn’t mean that there can be no gaps. For example, the fd 9 of the process_1 goes after fd 3. Some files, which used fd 4, 5, 6 and 7, could already be closed. Another way of achieving such a picture can be an explicit duplication of a file descriptor with <code>dup2</code>, <code>dup3</code> or <code>fcntl</code> with <code>F_DUPFD</code>. Using these syscalls, we can specify the wanted file descriptor number. We will see later how it works in the chapter about the duplication of fds.</p><p>❹ – A process can have more than one file descriptor that points to the same entry in the open file descriptions. System calls <code>dup</code>, <code>dup2</code>, <code>dup3</code> and <code>fcntl</code> with <code>F_DUPFD</code> help with that. The fd 0 and fd 2 of the process_2 refer to the same pseudo terminal entry.</p><p>❺ – Sometimes, one of the standard file descriptors might be pointed to a regular file (or pipe) and not a terminal. In this example, the <code>stdout</code> of the process_2 refers to a file on disk <code>/tmp/out.txt</code>.</p><p>❻ – It’s possible to point file descriptors from various processes to the same entry in the system-wide open file description table. This is usually achieved by a <code>fork</code> call and inheriting file descriptors from the parent to its child. But there are other ways, which we’ll see later in this chapter. These descriptors could also have different int fd numbers inside processes and different process flags (<code>O_CLOEXEC</code>). For instance, fd 9 of process_1 and fd 3 of process_2.</p><p>❼ – I put the file path here for simplicity. Instead, Linux kernel uses inode numbers, minor and major numbers of a device.</p><p>❽ – Often, for a shell, the 0,1 and 2 file descriptors are pointed to a pseudo-terminal.</p><p>❾ – Multiple open file descriptor entries can be linked with the same file on disk. The kernel allows us to open a file with different flags and at various offset positions.</p><h2 id=stdin-stdout-and-stderr><code>stdin</code>, <code>stdout</code> and <code>stderr</code>
<a class=anchor href=#stdin-stdout-and-stderr>#</a></h2><p>The first three file descriptors of processes are treated differently by shells and other programs. These fds also have well-known aliases:</p><ul><li>0 – <code>stdin</code></li><li>1 – <code>stdout</code></li><li>2 – <code>stderr</code></li></ul><p>For a process started and running within a terminal session, these fds can be pointed to a pseudoterminal, a terminal, a file, a pipe, etc. For classical-UNIX-style daemons, they usually refer to a <code>/dev/null</code> device.</p><p>Later in this series, I&rsquo;ll show how this works in shells and why we must be careful with these three fds when working with long-running background processes.</p><h2 id=procfs-and-file-descriptors>Procfs and file descriptors
<a class=anchor href=#procfs-and-file-descriptors>#</a></h2><p>The kernel exposes all open file descriptors of a process with the virtual <code>procfs</code> file system. So in order to get information about the open files for the current shell process, we can use a shell variable <code>$$</code> with its PID. For instance:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls -l /proc/$$/fd/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:15 <span style=color:#ae81ff>0</span> -&gt; /dev/pts/0
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:15 <span style=color:#ae81ff>1</span> -&gt; /dev/pts/0
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:15 <span style=color:#ae81ff>2</span> -&gt; /dev/pts/0
</span></span></code></pre></div><p>We can see only pseudoterminal <code>/dev/pts/0</code> here. We will talk more about them a bit later.</p><p>Another useful directory in the <code>procfs</code> is the <code>fdinfo</code> folder under the process directory. It contains per file descriptor info. For example, for the <code>stdin</code> of the current shell process:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat /proc/$$/fdinfo/0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pos:	<span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>flags:  <span style=color:#ae81ff>02</span>
</span></span><span style=display:flex><span>mnt_id: <span style=color:#ae81ff>28</span>
</span></span></code></pre></div><p>Keep in mind that the flags section here contains only the status flags (<code><a href=https://man7.org/linux/man-pages/man2/open.2.html target=_blank rel=noopener>man 2 open</a></code>). Let’s use it to write a tool to decode this flag mask to human-readable flags:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pid <span style=color:#f92672>=</span> sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>fd <span style=color:#f92672>=</span> sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>2</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;/proc/</span><span style=color:#e6db74>{</span>pid<span style=color:#e6db74>}</span><span style=color:#e6db74>/fdinfo/</span><span style=color:#e6db74>{</span>fd<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;r&#34;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>   flags <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>readlines()[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\t</span><span style=color:#e6db74>&#34;</span>)[<span style=color:#ae81ff>1</span>]<span style=color:#f92672>.</span>strip()
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>   print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;Flags mask: </span><span style=color:#e6db74>{</span>flags<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>   flags <span style=color:#f92672>=</span> int(flags, <span style=color:#ae81ff>8</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#75715e># check status flags</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> flags <span style=color:#f92672>&amp;</span> os<span style=color:#f92672>.</span>O_RDONLY:
</span></span><span style=display:flex><span>       print(<span style=color:#e6db74>&#34;os.O_RDONLY is set&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> flags <span style=color:#f92672>&amp;</span> os<span style=color:#f92672>.</span>O_WRONLY:
</span></span><span style=display:flex><span>       print(<span style=color:#e6db74>&#34;os.O_WRONLY is set&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> flags <span style=color:#f92672>&amp;</span> os<span style=color:#f92672>.</span>O_RDWR:
</span></span><span style=display:flex><span>       print(<span style=color:#e6db74>&#34;os.O_RDWR is set&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> flags <span style=color:#f92672>&amp;</span> os<span style=color:#f92672>.</span>O_APPEND:
</span></span><span style=display:flex><span>       print(<span style=color:#e6db74>&#34;os.O_APPEND is set&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> flags <span style=color:#f92672>&amp;</span> os<span style=color:#f92672>.</span>O_DSYNC:
</span></span><span style=display:flex><span>       print(<span style=color:#e6db74>&#34;os.O_DSYNC is set&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> flags <span style=color:#f92672>&amp;</span> os<span style=color:#f92672>.</span>O_RSYNC:
</span></span><span style=display:flex><span>       print(<span style=color:#e6db74>&#34;os.O_RSYNC is set&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> flags <span style=color:#f92672>&amp;</span> os<span style=color:#f92672>.</span>O_SYNC:
</span></span><span style=display:flex><span>       print(<span style=color:#e6db74>&#34;os.O_SYNC is set&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> flags <span style=color:#f92672>&amp;</span> os<span style=color:#f92672>.</span>O_NDELAY:
</span></span><span style=display:flex><span>       print(<span style=color:#e6db74>&#34;os.O_NDELAY is set&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> flags <span style=color:#f92672>&amp;</span> os<span style=color:#f92672>.</span>O_NONBLOCK:
</span></span><span style=display:flex><span>       print(<span style=color:#e6db74>&#34;os.O_NONBLOCK is set&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> flags <span style=color:#f92672>&amp;</span> os<span style=color:#f92672>.</span>O_ASYNC:
</span></span><span style=display:flex><span>       print(<span style=color:#e6db74>&#34;os.O_ASYNC is set&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> flags <span style=color:#f92672>&amp;</span> os<span style=color:#f92672>.</span>O_DIRECT:
</span></span><span style=display:flex><span>       print(<span style=color:#e6db74>&#34;os.O_DIRECT is set&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> flags <span style=color:#f92672>&amp;</span> os<span style=color:#f92672>.</span>O_NOATIME:
</span></span><span style=display:flex><span>       print(<span style=color:#e6db74>&#34;os.O_NOATIME is set&#34;</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> flags <span style=color:#f92672>&amp;</span> os<span style=color:#f92672>.</span>O_PATH:
</span></span><span style=display:flex><span>       print(<span style=color:#e6db74>&#34;os.O_PATH is set&#34;</span>)
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>   <span style=color:#75715e># check close on exec</span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> flags <span style=color:#f92672>&amp;</span> os<span style=color:#f92672>.</span>O_CLOEXEC:
</span></span><span style=display:flex><span>       print(<span style=color:#e6db74>&#34;os.O_CLOEXEC is set&#34;</span>)
</span></span></code></pre></div><p>Out test program, which opens a file with some status flags:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>file_path <span style=color:#f92672>=</span> sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(os<span style=color:#f92672>.</span>getpid())
</span></span><span style=display:flex><span>fd <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>open(file_path,  os<span style=color:#f92672>.</span>O_APPEND <span style=color:#f92672>|</span> os<span style=color:#f92672>.</span>O_RSYNC <span style=color:#f92672>|</span> os<span style=color:#f92672>.</span>O_NOATIME )
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> os<span style=color:#f92672>.</span>fdopen(fd, <span style=color:#e6db74>&#34;r+&#34;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>   print(f<span style=color:#f92672>.</span>fileno())
</span></span><span style=display:flex><span>   time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>9999</span>)
</span></span></code></pre></div><p>Let’s run it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 ./open.py /tmp/123.txt
</span></span><span style=display:flex><span><span style=color:#ae81ff>925</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>
</span></span></code></pre></div><p>And run our tool:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 ./flags.py <span style=color:#ae81ff>925</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Flags mask: <span style=color:#ae81ff>07112000</span>
</span></span><span style=display:flex><span>os.O_APPEND is set
</span></span><span style=display:flex><span>os.O_DSYNC is set
</span></span><span style=display:flex><span>os.O_RSYNC is set
</span></span><span style=display:flex><span>os.O_SYNC is set
</span></span><span style=display:flex><span>os.O_NOATIME is set
</span></span><span style=display:flex><span>os.O_CLOEXEC is set
</span></span></code></pre></div><p>Some flags in the kernel are aliases to other flags. That’s why we see more flags here.</p><p>Another example is if we run our tool with a socket fd (I used <code>nginx</code> process):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo python3 ./flags.py <span style=color:#ae81ff>943</span> <span style=color:#ae81ff>6</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Flags mask: <span style=color:#ae81ff>02004002</span>
</span></span><span style=display:flex><span>os.O_RDWR is set
</span></span><span style=display:flex><span>os.O_NDELAY is set
</span></span><span style=display:flex><span>os.O_NONBLOCK is set
</span></span><span style=display:flex><span>os.O_CLOEXEC is set
</span></span></code></pre></div><p>We can see that the socket is in nonblocking mode: <code>O_NONBLOCK</code> is set.</p><h2 id=sharing-file-descriptors-between-parent-and-child-after-fork>Sharing file descriptors between parent and child after <code>fork()</code>
<a class=anchor href=#sharing-file-descriptors-between-parent-and-child-after-fork>#</a></h2><p>Another important concept of file descriptors is how they behave with <code>fork()</code> (<code><a href=https://man7.org/linux/man-pages/man2/fork.2.html target=_blank rel=noopener>man 2 fork</a></code>) and <code>clone()</code> (<a href=https://man7.org/linux/man-pages/man2/clone.2.html target=_blank rel=noopener>man 2 clone</a>) system calls.</p><p>After a <code>fork()</code> or a <code>clone()</code> (without <code>CLONE_FILES</code> set) call, a child and a parent have an equal set of file descriptors, which refer to the same entries in the system-wide open file description table. It means they share identical file positions, status flags and process fd flags (<code>O_CLOEXEC</code>)</p><p>Let’s start with an example where 2 processes are not relatives. Both open the same file and get the same integer number for their fd. But because they both call <code>open()</code> independently, these two references to the open file description table will differ. After the file opening, the first example process makes a <code>lseek()</code> (<code>man 2 lseek</code>) at one position, and another program makes a <code>lseek()</code> call for the same file but at a different place. These actions don’t affect each other.</p><p>Code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;pid: </span><span style=color:#e6db74>{</span>os<span style=color:#f92672>.</span>getpid()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#34;/var/tmp/file1.db&#34;</span>, <span style=color:#e6db74>&#34;r&#34;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>   print(f<span style=color:#f92672>.</span>fileno())
</span></span><span style=display:flex><span>   f<span style=color:#f92672>.</span>seek(int(sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>]))
</span></span><span style=display:flex><span>   time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>99999</span>)
</span></span></code></pre></div><p>Run them in 2 different terminals:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 ./file1.py <span style=color:#ae81ff>100</span> <span style=color:#75715e># &lt;----------- lseek() to 100 bytes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pid: <span style=color:#ae81ff>826</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 ./file1.py <span style=color:#ae81ff>200</span> <span style=color:#75715e># &lt;----------- lseek() to 200 bytes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pid: <span style=color:#ae81ff>827</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>
</span></span></code></pre></div><p>Now check <code>procfs</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls -l /proc/826/fd
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:18 <span style=color:#ae81ff>0</span> -&gt; /dev/pts/0
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:18 <span style=color:#ae81ff>1</span> -&gt; /dev/pts/0
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:18 <span style=color:#ae81ff>2</span> -&gt; /dev/pts/0
</span></span><span style=display:flex><span>lr-x------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:18 <span style=color:#ae81ff>3</span> -&gt; /var/tmp/file1.db    &lt;---------
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls -l /proc/827/fd
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:18 <span style=color:#ae81ff>0</span> -&gt; /dev/pts/1
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:18 <span style=color:#ae81ff>1</span> -&gt; /dev/pts/1
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:18 <span style=color:#ae81ff>2</span> -&gt; /dev/pts/1
</span></span><span style=display:flex><span>lr-x------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:18 <span style=color:#ae81ff>3</span> -&gt; /var/tmp/file1.db    &lt;---------
</span></span></code></pre></div><p>We have the same file path and the same file descriptor number. Now verify that the positions are different because we have unrelated open file descriptions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat /proc/826/fdinfo/3
</span></span><span style=display:flex><span>pos:	<span style=color:#ae81ff>100</span>                  &lt;------------------------
</span></span><span style=display:flex><span>flags:  <span style=color:#ae81ff>02100000</span>
</span></span><span style=display:flex><span>mnt_id: <span style=color:#ae81ff>26</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cat /proc/827/fdinfo/3
</span></span><span style=display:flex><span>pos:	<span style=color:#ae81ff>200</span>                  &lt;------------------------
</span></span><span style=display:flex><span>flags:  <span style=color:#ae81ff>02100000</span>
</span></span><span style=display:flex><span>mnt_id: <span style=color:#ae81ff>26</span>
</span></span></code></pre></div><p>Let’s now see how the file positions will behave after a <code>fork()</code> call between a parent process and its child. We open a file in a parent process, <code>fork()</code>, make <code>lseek()</code> in the child, and check whether the positions are the same or not.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#34;/var/tmp/file1.db&#34;</span>, <span style=color:#e6db74>&#34;r&#34;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>   print(f<span style=color:#f92672>.</span>fileno())
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span>   print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;parent pid: </span><span style=color:#e6db74>{</span>os<span style=color:#f92672>.</span>getpid()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>   pid <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>fork()
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> pid:
</span></span><span style=display:flex><span>       <span style=color:#75715e># child</span>
</span></span><span style=display:flex><span>       print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;child pid: </span><span style=color:#e6db74>{</span>os<span style=color:#f92672>.</span>getpid()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>       f<span style=color:#f92672>.</span>seek(int(sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>]))
</span></span><span style=display:flex><span>       time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>99999</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   os<span style=color:#f92672>.</span>waitpid(pid, <span style=color:#ae81ff>0</span>)
</span></span></code></pre></div><p>Run it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 ./file2.py <span style=color:#ae81ff>100</span> <span style=color:#75715e># &lt;----------- lseek() to 100 bytes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>parent pid: <span style=color:#ae81ff>839</span>
</span></span><span style=display:flex><span>child pid: <span style=color:#ae81ff>840</span>
</span></span></code></pre></div><p>Our <code>procfs</code> picture:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls -l /proc/839/fd/
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:23 <span style=color:#ae81ff>0</span> -&gt; /dev/pts/0
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:23 <span style=color:#ae81ff>1</span> -&gt; /dev/pts/0
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:23 <span style=color:#ae81ff>2</span> -&gt; /dev/pts/0
</span></span><span style=display:flex><span>lr-x------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:23 <span style=color:#ae81ff>3</span> -&gt; /var/tmp/file1.db    &lt;---------
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls -l /proc/840/fd/
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:23 <span style=color:#ae81ff>0</span> -&gt; /dev/pts/0
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:23 <span style=color:#ae81ff>1</span> -&gt; /dev/pts/0
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:23 <span style=color:#ae81ff>2</span> -&gt; /dev/pts/0
</span></span><span style=display:flex><span>lr-x------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:23 <span style=color:#ae81ff>3</span> -&gt; /var/tmp/file1.db    &lt;---------
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat /proc/839/fdinfo/3
</span></span><span style=display:flex><span>pos:	<span style=color:#ae81ff>100</span>                   &lt;--------- <span style=color:#ae81ff>100</span> bytes
</span></span><span style=display:flex><span>flags:  <span style=color:#ae81ff>02100000</span>
</span></span><span style=display:flex><span>mnt_id: <span style=color:#ae81ff>26</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat /proc/840/fdinfo/3
</span></span><span style=display:flex><span>pos:	<span style=color:#ae81ff>100</span>                   &lt;--------- <span style=color:#ae81ff>100</span> bytes
</span></span><span style=display:flex><span>flags:  <span style=color:#ae81ff>02100000</span>
</span></span><span style=display:flex><span>mnt_id: <span style=color:#ae81ff>26</span>
</span></span></code></pre></div><p>The primary purpose of such sharing is to protect files from being overwritten by children and its parent process. If all relatives start writing to a file simultaneously, the Linux kernel will sort this out and won’t lose any data because it’ll hold the lock and update the offset after each write. It’s worth mentioning that the data can appear in the file in a mixed way due to the CPU scheduler, arbitrary sizes of write buffers, and the amount of data to write.</p><p>If it’s not what you want, you should close all file descriptors after a successful <code>fork()</code>, including the three standard ones. This is basically how the classical daemons usually start. We will talk about them later in this series of posts.</p><h2 id=duplication-of-file-descriptors>Duplication of file descriptors
<a class=anchor href=#duplication-of-file-descriptors>#</a></h2><p>We already know that we can open a new file in order to create a new file descriptor within the process. But it’s not always needed. Usually it’s handy to copy the existing fd to another one.</p><p>Let’s start with the existing kernel API. We have a bunch of syscalls to duplicate fd:</p><ul><li><code>dup()</code> – creates a new fd using the lowest unused int number. It usually follows the <code>close()</code> syscall for the one of standard fd (<code>stdin</code>, <code>stdout</code>, <code>stderr</code>) in order to replace it.</li><li><code>dup2()</code> – does the same as above but has a second argument. Here we can specify the target fd. If the target fd already exists, the <code>dup2()</code> closes it first. All <code>dup2()</code> operations are atomic.</li><li><code>dup3()</code> – does the same as the <code>dup2()</code> but has a third parameter, where the <code>O_CLOEXEC</code> flag can be set.</li><li><code>fcntl()</code> with <code>F_DUPFD</code> flag behaves as <code>dup2()</code> with one exception: if the target fd exists, it uses the next one instead of closing it.</li></ul><p>When <code>dup()</code>, <code>dup2()</code>, or <code>fcntl()</code> are used to create a duplicate of a file descriptor, the close-on-exec (<code>O_CLOEXEC</code>) flag is always reset for the duplicate fd.</p><p>We can in theory open the file twice with the <code>O_APPEND</code> flag and don’t use the duplication syscalls at all. In the following example <code>O_APPEND</code> flag preserves the <code>strace</code> tool from overwriting data in the <code>results.log</code> file by its concurrent writes from the <code>stdout</code> and <code>stderr</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ strace 1&gt;&gt;results.log 2&gt;&gt;results.log
</span></span></code></pre></div><p>     where <code>1>></code> and <code>2>></code> are append shell redirections for <code>stdout</code> and <code>stderr</code>.</p><p>But if we use a shell pipe, the following example will only work with fd duplication logic. Pipes don’t have <code>O_APPEND</code> open flag, and they are much convenient for the redirection task (I’m covering the power of pipes later in the chapter 2 where you can find more justifications for the below technique):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ strace 2&gt;&amp;<span style=color:#ae81ff>1</span> | less 		 	 	 		
</span></span></code></pre></div><p>Let’s write an example that shows all the power of fd duplication:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>os<span style=color:#f92672>.</span>getpid()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fd1 <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>open(<span style=color:#e6db74>&#34;/var/tmp/file1.db&#34;</span>, os<span style=color:#f92672>.</span>O_RDONLY, <span style=color:#ae81ff>777</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>fd2 <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>dup(fd1)
</span></span><span style=display:flex><span>fd3 <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>dup2(fd1, <span style=color:#ae81ff>999</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>os<span style=color:#f92672>.</span>lseek(fd3, <span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>9999</span>)
</span></span></code></pre></div><p>We opened one file, duplicate it several times, change the file position and it’s changed for all of the fs:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls -la /proc/2129/fd
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Aug  <span style=color:#ae81ff>6</span> 19:52 <span style=color:#ae81ff>0</span> -&gt; /dev/pts/0
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Aug  <span style=color:#ae81ff>6</span> 19:52 <span style=color:#ae81ff>1</span> -&gt; /dev/pts/0
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Aug  <span style=color:#ae81ff>6</span> 19:52 <span style=color:#ae81ff>2</span> -&gt; /dev/pts/0
</span></span><span style=display:flex><span>lr-x------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Aug  <span style=color:#ae81ff>6</span> 19:52 <span style=color:#ae81ff>3</span> -&gt; /var/tmp/file1.db
</span></span><span style=display:flex><span>lr-x------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Aug  <span style=color:#ae81ff>6</span> 19:52 <span style=color:#ae81ff>4</span> -&gt; /var/tmp/file1.db
</span></span><span style=display:flex><span>lr-x------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Aug  <span style=color:#ae81ff>6</span> 19:52 <span style=color:#ae81ff>999</span> -&gt; /var/tmp/file1.db
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat /proc/2129/fdinfo/999
</span></span><span style=display:flex><span>pos:	<span style=color:#ae81ff>100</span>                    &lt;------------ position
</span></span><span style=display:flex><span>flags:  <span style=color:#ae81ff>0100000</span>
</span></span><span style=display:flex><span>mnt_id: <span style=color:#ae81ff>26</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cat /proc/2129/fdinfo/3
</span></span><span style=display:flex><span>pos:	<span style=color:#ae81ff>100</span>                    &lt;------------ position
</span></span><span style=display:flex><span>flags:  <span style=color:#ae81ff>02100000</span>
</span></span><span style=display:flex><span>mnt_id: <span style=color:#ae81ff>26</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cat /proc/2129/fdinfo/4
</span></span><span style=display:flex><span>pos:	<span style=color:#ae81ff>100</span>                   &lt;------------ position
</span></span><span style=display:flex><span>flags:  <span style=color:#ae81ff>02100000</span>
</span></span><span style=display:flex><span>mnt_id: <span style=color:#ae81ff>26</span>
</span></span></code></pre></div><h2 id=execve-and-file-descriptors><code>Execve()</code> and file descriptors
<a class=anchor href=#execve-and-file-descriptors>#</a></h2><p>Now let’s talk what may happen with file descriptors during the <code>execve()</code> system call (<a href=https://man7.org/linux/man-pages/man2/execve.2.html target=_blank rel=noopener>man 2 execve</a>).</p><p>Just to start, <code>execve()</code> is the only way the Linux kernel can start a new program. This syscall executes a binary file if the first argument is an <code>ELF</code> compiled file and has an executable bit set, or starts an interpreter with the content of the file if the argument has a hashbang (for example: <code>#!/usr/bin/python</code>) on the first line of the file and has an exec bit set.</p><p>After an <code>execve()</code> call a file offsets and flags are copied and shared if the close-on-exec (<code>O_CLOEXEC</code>) flag is not set.</p><p>Let’s prove it with an example. We need 2 files: <code>sleep.py</code> and <code>exec.py</code>. The second one will execute the first one.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/python3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;sleep&#34;</span>)
</span></span><span style=display:flex><span>time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>99999</span>)
</span></span></code></pre></div><p>Don’t forget to set an exec bit on it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ chmod +x ./sleep.py
</span></span></code></pre></div><p>The <code>exec.py</code> opens a file, duplicates it with <code>dup2()</code> syscall, clearing the close-on-exec (<code>O_CLOEXEC</code>) flag.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#34;/var/tmp/file1.db&#34;</span>, <span style=color:#e6db74>&#34;r&#34;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>   print(f<span style=color:#f92672>.</span>fileno())
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>   print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;parent </span><span style=color:#e6db74>{</span>os<span style=color:#f92672>.</span>getpid()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>   os<span style=color:#f92672>.</span>dup2(f<span style=color:#f92672>.</span>fileno(), <span style=color:#ae81ff>123</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   pid <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>fork()
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> pid:
</span></span><span style=display:flex><span>       <span style=color:#75715e># child</span>
</span></span><span style=display:flex><span>       print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;child </span><span style=color:#e6db74>{</span>os<span style=color:#f92672>.</span>getpid()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>       os<span style=color:#f92672>.</span>execve(<span style=color:#e6db74>&#34;./sleep.py&#34;</span>, [<span style=color:#e6db74>&#34;./sleep.py&#34;</span>], os<span style=color:#f92672>.</span>environ)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   f<span style=color:#f92672>.</span>seek(<span style=color:#ae81ff>234</span>)
</span></span><span style=display:flex><span>   os<span style=color:#f92672>.</span>waitpid(<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>)
</span></span></code></pre></div><p>If we run it in the console, the output should be something like the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 ./exec.py
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>parent <span style=color:#ae81ff>6851</span>
</span></span><span style=display:flex><span>child <span style=color:#ae81ff>6852</span>
</span></span><span style=display:flex><span>sleep
</span></span></code></pre></div><p>If we check the <code>procfs</code>. First, we will not be able to see the fd 3 for the child. This happens because python, by default, opens all files with the <code>O_CLOEXEC</code> flag (but <code>dup2</code> resets this flag for 123 fd) We can get this info by running out script under <code>strace</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ strace -s0 -f python3 ./exec.py
</span></span></code></pre></div><p>And in the output we can find the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/var/tmp/file1.db&#34;</span>, O_RDONLY|O_CLOEXEC<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span></code></pre></div><p>That’s why we used <code>dup2()</code>. It resets the <code>O_CLOEXEC</code> flag and allows us to check whether the fd sharing is established.</p><p>The parent process:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls -l /proc/6851/fd/
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul <span style=color:#ae81ff>11</span> 20:07 <span style=color:#ae81ff>0</span> -&gt; /dev/pts/1
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul <span style=color:#ae81ff>11</span> 20:07 <span style=color:#ae81ff>1</span> -&gt; /dev/pts/1
</span></span><span style=display:flex><span>lr-x------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul <span style=color:#ae81ff>11</span> 20:07 <span style=color:#ae81ff>123</span> -&gt; /var/tmp/file1.db &lt;---
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul <span style=color:#ae81ff>11</span> 20:07 <span style=color:#ae81ff>2</span> -&gt; /dev/pts/1
</span></span><span style=display:flex><span>lr-x------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul <span style=color:#ae81ff>11</span> 20:07 <span style=color:#ae81ff>3</span> -&gt; /var/tmp/file1.db   &lt;---
</span></span></code></pre></div><p>The child has only fd 123:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls -l /proc/6852/fd/
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul <span style=color:#ae81ff>11</span> 20:07 <span style=color:#ae81ff>0</span> -&gt; /dev/pts/1
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul <span style=color:#ae81ff>11</span> 20:07 <span style=color:#ae81ff>1</span> -&gt; /dev/pts/1
</span></span><span style=display:flex><span>lr-x------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul <span style=color:#ae81ff>11</span> 20:07 <span style=color:#ae81ff>123</span> -&gt; /var/tmp/file1.db &lt;----
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul <span style=color:#ae81ff>11</span> 20:07 <span style=color:#ae81ff>2</span> -&gt; /dev/pts/1
</span></span></code></pre></div><p>Check the positions in the parent’s fds:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat /proc/6851/fdinfo/3
</span></span><span style=display:flex><span>pos:	<span style=color:#ae81ff>234</span>                  &lt;-------------------
</span></span><span style=display:flex><span>flags:  <span style=color:#ae81ff>02100000</span>
</span></span><span style=display:flex><span>mnt_id: <span style=color:#ae81ff>26</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ cat /proc/6851/fdinfo/123
</span></span><span style=display:flex><span>pos:	<span style=color:#ae81ff>234</span>                  &lt;-------------------
</span></span><span style=display:flex><span>flags:  <span style=color:#ae81ff>0100000</span>
</span></span><span style=display:flex><span>mnt_id: <span style=color:#ae81ff>26</span>
</span></span></code></pre></div><p>And the child:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat /proc/6852/fdinfo/123
</span></span><span style=display:flex><span>pos:	<span style=color:#ae81ff>234</span>                  &lt;-------------------
</span></span><span style=display:flex><span>flags:  <span style=color:#ae81ff>0100000</span>
</span></span><span style=display:flex><span>mnt_id: <span style=color:#ae81ff>26</span>
</span></span></code></pre></div><p>The reasonable question you may ask now is how we can protect ourselves from leaking file descriptors from a parent to children, keeping in mind that we usually execute a binary that we didn’t write. For instance, a shell starts programs like <code>ls</code>, <code>ping</code>, <code>strace</code>, etc.</p><p>Back in the past (before Linux 5.9), people iterated over all possible file descriptors and tried to close them. In order to find out the upper boundary, the <code>ulimit</code> limit for open files was used (<code>RLIMIT_NOFILE</code>).</p><p>Some people open the <code>/proc/self/fd/</code> in their programs after <code>fork()</code> and close all fd from it.</p><p>But there is a more elegant way of doing this in the modern Linux kernels. It’s a <code>close_range()</code> syscall (<a href=https://man7.org/linux/man-pages/man2/close_range.2.html target=_blank rel=noopener>man 2 close_range</a>). It allows us to avoid heavy user space iterations and use a kernel help instead.</p><p>The fixed version:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>    pid <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>fork()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> pid:
</span></span><span style=display:flex><span>        <span style=color:#75715e># child</span>
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;child </span><span style=color:#e6db74>{</span>os<span style=color:#f92672>.</span>getpid()<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        max_fd <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>sysconf(<span style=color:#e6db74>&#34;SC_OPEN_MAX&#34;</span>) <span style=color:#75715e># &lt;---- added</span>
</span></span><span style=display:flex><span>        os<span style=color:#f92672>.</span>closerange(<span style=color:#ae81ff>3</span>, max_fd)           <span style=color:#75715e># &lt;---/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        os<span style=color:#f92672>.</span>execve(<span style=color:#e6db74>&#34;./sleep.py&#34;</span>, [<span style=color:#e6db74>&#34;./sleep.py&#34;</span>], os<span style=color:#f92672>.</span>environ)
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span></code></pre></div><h3 id=o_cloexec><code>O_CLOEXEC</code>
<a class=anchor href=#o_cloexec>#</a></h3><p>And finally 2 sentences about the <code>O_CLOEXEC</code> flag, and why we need it in the first place if we can close all unneeded file descriptors? The main issue is libraries. You should always open all files with it because it’s hard to track opened files from the main program.</p><p>Another crucial case is a situation when the <code>exec()</code> fails (due to permissiom issues, wrong path, etc), and we still need some previously opened files (for instance, to write logs). Usually, reopening them after such an error is quite hard.</p><p>As I showed earlier, for some modern programming language it&rsquo;s a default behavior for their <code>open</code> file functions.</p><h2 id=check-if-2-file-descriptors-share-the-same-open-file-description-with-kcmp>Check if 2 file descriptors share the same open file description with <code>kcmp()</code>
<a class=anchor href=#check-if-2-file-descriptors-share-the-same-open-file-description-with-kcmp>#</a></h2><p>Let’s continue our journey with more unusual and elegant system calls.</p><p>You can use the <code>kcmp()</code> syscall (<a href=https://man7.org/linux/man-pages/man2/kcmp.2.html target=_blank rel=noopener>man 2 kcmp</a>) to test whether 2 fds refer to the same open file description.</p><blockquote class="book-hint info"><p><strong>NOTE</strong></p><p>We have this syscall instead of a full view of the open file description table due to security reasons. The kernel developers don’t feel good about exporting all this information to the user space <a href=https://lwn.net/Articles/845448/ target=_blank rel=noopener>https://lwn.net/Articles/845448/</a>.</p></blockquote><p>Let’s write a tool that we can use to identifies identical file descriptors for two processes. This system call is not widely used, so many programming languages don’t have a wrapper in their standard libraries. But it’s not a problem for us. First of all, we need to find a number of this syscall. For example, we can find it in the Linux kernel sources <a href=https://github.com/torvalds/linux/blob/master/arch/x86/entry/syscalls/syscall_64.tbl target=_blank rel=noopener>syscall_64.tbl</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>...
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>311</span>	<span style=color:#ae81ff>64</span>	process_vm_writev	sys_process_vm_writev
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>312</span>	common	kcmp			sys_kcmp
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>313</span>	common	finit_module	sys_finit_module
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>The full code of our tool (if something is not clear, please read the <a href=https://man7.org/linux/man-pages/man2/kcmp.2.html target=_blank rel=noopener>man 2 kcmp</a>):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;strconv&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;syscall&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>SYS_KCMP</span>  = <span style=color:#ae81ff>312</span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>KCMP_FILE</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>kcmp_files</span>(<span style=color:#a6e22e>pid1</span>, <span style=color:#a6e22e>pid2</span>, <span style=color:#a6e22e>fd1</span>, <span style=color:#a6e22e>fd2</span> <span style=color:#66d9ef>int</span>) (<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>r1</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>Syscall6</span>(<span style=color:#a6e22e>SYS_KCMP</span>, uintptr(<span style=color:#a6e22e>pid1</span>), uintptr(<span style=color:#a6e22e>pid2</span>), <span style=color:#a6e22e>KCMP_FILE</span>, uintptr(<span style=color:#a6e22e>fd1</span>), uintptr(<span style=color:#a6e22e>fd2</span>), <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> int(<span style=color:#a6e22e>r1</span>), <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>pid1</span>, <span style=color:#a6e22e>pid2</span>, <span style=color:#a6e22e>fd1</span>, <span style=color:#a6e22e>fd2</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>err</span>                  <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>   )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>pid1</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>pid2</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>2</span>])
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>fd1</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>3</span>])
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>fd2</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>4</span>])
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>r1</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>kcmp_files</span>(<span style=color:#a6e22e>pid1</span>, <span style=color:#a6e22e>pid2</span>, <span style=color:#a6e22e>fd1</span>, <span style=color:#a6e22e>fd2</span>)
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>r1</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>For the targets, we will use the <code>exec.py</code> program from the previous chapter:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go run ./kcmp.go <span style=color:#ae81ff>1957</span> <span style=color:#ae81ff>1958</span> <span style=color:#ae81ff>123</span> <span style=color:#ae81ff>123</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span> errno <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ go run ./kcmp.go <span style=color:#ae81ff>1957</span> <span style=color:#ae81ff>1958</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>123</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span> errno <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ go run ./kcmp.go <span style=color:#ae81ff>1957</span> <span style=color:#ae81ff>1958</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span> errno <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ go run ./kcmp.go <span style=color:#ae81ff>1957</span> <span style=color:#ae81ff>1958</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>0</span> errno <span style=color:#ae81ff>0</span>
</span></span></code></pre></div><p>As we can see, the parent and the child shared the fd 123, and the fd 3 in the parent is the copy of the 123 in the child. Also both <code>stdout</code> refer to the same shell pseudoterminal.</p><h2 id=more-ways-to-transfer-file-descriptors-between-processes-pidfd_getfd-and-unix-datagrams>More ways to transfer file descriptors between processes: <code>pidfd_getfd()</code> and Unix datagrams.
<a class=anchor href=#more-ways-to-transfer-file-descriptors-between-processes-pidfd_getfd-and-unix-datagrams>#</a></h2><p>So far, we’ve seen file descriptors sharing only from the parent to the child with the <code>fork()</code> call.</p><p>On some occasions, we want to send an fd to a target process or processes. For example, for a zero downtime program upgrades, where we want to preserve the file descriptor of a listening socket and transfer it to the new process with a new binary.</p><p>We have two options to do that in modern Linux kernels.</p><p>The first one is pretty standard and old. It works over a <code>Unix</code> socket. With a special <code>UDP</code> message, one process can pass an fd to another process. This, of course, works only locally (that’s why it’s a UNIX domain socket). The code for such transferring is massive and if you’re wondering how to write such a tool, please check out this detailed blog <a href=https://blog.cloudflare.com/know-your-scm_rights/ target=_blank rel=noopener>post</a>.</p><p>The second option is quite new and allows a process to steal an fd from another process. I’m talking about the <code>pidfd_getfd()</code> system call (<a href=https://man7.org/linux/man-pages/man2/pidfd_getfd.2.html target=_blank rel=noopener>man 2 pidfd_getfd</a>).</p><p>In order to leverage it, we need to open a process with another syscall: <code>pidfd_open()</code> (<a href=https://man7.org/linux/man-pages/man2/pidfd_open.2.html target=_blank rel=noopener>man 2 pidfd_open</a>). Also, we would need a special set of <code>ptrace</code> permission: <code>PTRACE_MODE_ATTACH_REALCREDS</code>.</p><p>We can allow it system-wide in your test box, but please don’t do it in production. For production environments, please review the <a href=https://man7.org/linux/man-pages/man2/ptrace.2.html target=_blank rel=noopener>man 2 ptrace</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#ae81ff>0</span> | sudo tee /proc/sys/kernel/yama/ptrace_scope
</span></span></code></pre></div><p>Let’s run our old python example which opens a file with fd 3:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ python3 ./file2.py <span style=color:#ae81ff>123</span>
</span></span><span style=display:flex><span>parent pid: <span style=color:#ae81ff>3155</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>child pid: <span style=color:#ae81ff>3156</span>
</span></span></code></pre></div><p>And our stealing fd tool:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;strconv&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;syscall&#34;</span>
</span></span><span style=display:flex><span>   <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>sys_pidfd_open</span>  = <span style=color:#ae81ff>434</span>  <span style=color:#75715e>// from kernel table
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#a6e22e>sys_pidfd_getfd</span> = <span style=color:#ae81ff>438</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>pidfd_open</span>(<span style=color:#a6e22e>pid</span> <span style=color:#66d9ef>int</span>) (<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>r1</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>Syscall</span>(<span style=color:#a6e22e>sys_pidfd_open</span>, uintptr(<span style=color:#a6e22e>pid</span>), <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> int(<span style=color:#a6e22e>r1</span>), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>pidfd_getfd</span>(<span style=color:#a6e22e>pidfd</span>, <span style=color:#a6e22e>targetfd</span> <span style=color:#66d9ef>int</span>) (<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>r1</span>, <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>Syscall</span>(<span style=color:#a6e22e>sys_pidfd_getfd</span>, uintptr(<span style=color:#a6e22e>pidfd</span>), uintptr(<span style=color:#a6e22e>targetfd</span>), <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>return</span> int(<span style=color:#a6e22e>r1</span>), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>pid</span>, <span style=color:#a6e22e>fd</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>err</span>     <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>   )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>pid</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>])
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>fd</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>2</span>])
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;pid:&#34;</span>, <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Getpid</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>pidfd</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pidfd_open</span>(<span style=color:#a6e22e>pid</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>newFd</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pidfd_getfd</span>(<span style=color:#a6e22e>pidfd</span>, <span style=color:#a6e22e>fd</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>       panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>newFd</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Hour</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If we run it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ go run ./getfd.go <span style=color:#ae81ff>3155</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>pid: <span style=color:#ae81ff>4009</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span>
</span></span></code></pre></div><p>And check <code>procfs</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls -la /proc/4009/fd/
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul <span style=color:#ae81ff>10</span> 13:24 <span style=color:#ae81ff>0</span> -&gt; /dev/pts/2
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul <span style=color:#ae81ff>10</span> 13:24 <span style=color:#ae81ff>1</span> -&gt; /dev/pts/2
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul <span style=color:#ae81ff>10</span> 13:24 <span style=color:#ae81ff>2</span> -&gt; /dev/pts/2
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul <span style=color:#ae81ff>10</span> 13:24 <span style=color:#ae81ff>3</span> -&gt; <span style=color:#e6db74>&#39;anon_inode:[pidfd]&#39;</span>
</span></span><span style=display:flex><span>lr-x------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul <span style=color:#ae81ff>10</span> 13:24 <span style=color:#ae81ff>4</span> -&gt; /var/tmp/file1.db     &lt;--------------
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul <span style=color:#ae81ff>10</span> 13:24 <span style=color:#ae81ff>5</span> -&gt; <span style=color:#e6db74>&#39;anon_inode:[eventpoll]&#39;</span>
</span></span><span style=display:flex><span>lr-x------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul <span style=color:#ae81ff>10</span> 13:24 <span style=color:#ae81ff>6</span> -&gt; <span style=color:#e6db74>&#39;pipe:[43607]&#39;</span>
</span></span><span style=display:flex><span>l-wx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul <span style=color:#ae81ff>10</span> 13:24 <span style=color:#ae81ff>7</span> -&gt; <span style=color:#e6db74>&#39;pipe:[43607]&#39;</span>
</span></span></code></pre></div><p>File is with the same position:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat /proc/4009/fdinfo/4
</span></span><span style=display:flex><span>pos:	<span style=color:#ae81ff>123</span>                   &lt;--------------
</span></span><span style=display:flex><span>flags:  <span style=color:#ae81ff>02100000</span>
</span></span><span style=display:flex><span>mnt_id: <span style=color:#ae81ff>26</span>
</span></span></code></pre></div><p>By the way, if we check the file descriptor of the <code>pidfd</code> object, we can observe some additional info about the opened pid:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat /proc/4009/fdinfo/3
</span></span><span style=display:flex><span>pos:	<span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>flags:  <span style=color:#ae81ff>02000002</span>
</span></span><span style=display:flex><span>mnt_id: <span style=color:#ae81ff>15</span>
</span></span><span style=display:flex><span>Pid:	<span style=color:#ae81ff>3155</span> &lt;-------------------
</span></span><span style=display:flex><span>NSpid:  <span style=color:#ae81ff>3155</span>
</span></span></code></pre></div><h2 id=shell-redirections-and-file-descriptors>Shell redirections and file descriptors
<a class=anchor href=#shell-redirections-and-file-descriptors>#</a></h2><p>Now it’s time to talk about file descriptors and shells. We start with some basics, but later in this chapter you’ll find several really nit examples which could significantly improve your shell experience and performance.</p><p>For all examples, I’ll use GNU Bash 5.1. But I’m sure, the same concerts and techniques are available in your favorite shell.</p><p>Let’s start with simple and well-known redirections.</p><p>Instead of <code>stdin</code> read, we can use a file:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat &lt; /tmp/foo
</span></span><span style=display:flex><span>Some text
</span></span></code></pre></div><p>The same we can do for the <code>stdout</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;123&#34;</span> &gt; /tmp/foo <span style=color:#75715e># redirected stdout</span>
</span></span><span style=display:flex><span>$ cat /tmp/foo
</span></span><span style=display:flex><span><span style=color:#ae81ff>123</span>
</span></span></code></pre></div><p><code>>> </code>appends to a file instead of overwriting it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;123&#34;</span> &gt;&gt; /tmp/foo <span style=color:#75715e># append to a file</span>
</span></span><span style=display:flex><span>$ cat /tmp/foo
</span></span><span style=display:flex><span><span style=color:#ae81ff>123</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>123</span>
</span></span></code></pre></div><p>In order to write <code>stderr</code> to file, we need to specify the file descriptor number:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat <span style=color:#e6db74>&#34;123&#34;</span> 2&gt; /tmp/foo <span style=color:#75715e># write stderr to a file</span>
</span></span><span style=display:flex><span>$ cat  /tmp/foo
</span></span><span style=display:flex><span>cat: 123: No such file or directory
</span></span></code></pre></div><p>We can use the same file for both <code>stdout</code> and <code>stderr</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat <span style=color:#e6db74>&#34;123&#34;</span> &gt; /tmp/foo 2&gt;&amp;<span style=color:#ae81ff>1</span>
</span></span></code></pre></div><p>All of the above internally opens a target file with the <code>open()</code> syscall and uses <code>dup2()</code> calls to overwrite the standard file descriptors with the fd of the file. For the latest one, the shell runs <code>dup2()</code> twice for the <code>stdout()</code> and <code>stderr()</code></p><p>The general syntax for the redirection:</p><ul><li><code>></code> <code>fd > file_name</code></li><li><code>>&</code> <code>fd >& fd</code></li></ul><p>With bash we aren&rsquo;t restricted by the standard fds and can open new ones. For instance to open an fd 10:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ exec 10&lt;&gt; /tmp/foo
</span></span></code></pre></div><p>Check the <code>procfs</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls -la /proc/$$/fd
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:17 <span style=color:#ae81ff>0</span>   -&gt; /dev/pts/2
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:17 <span style=color:#ae81ff>1</span>   -&gt; /dev/pts/2
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul <span style=color:#ae81ff>10</span> 14:56 <span style=color:#ae81ff>10</span>  -&gt; /tmp/foo   &lt;---------
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul  <span style=color:#ae81ff>9</span> 21:17 <span style=color:#ae81ff>2</span>   -&gt; /dev/pts/2
</span></span><span style=display:flex><span>lrwx------ <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>64</span> Jul <span style=color:#ae81ff>10</span> 14:56 <span style=color:#ae81ff>255</span> -&gt; /dev/pts/2
</span></span></code></pre></div><p>If we run <code>strace</code> we can see how it works:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>...
</span></span><span style=display:flex><span>openat<span style=color:#f92672>(</span>T_FDCWD, <span style=color:#e6db74>&#34;/tmp/foo&#34;</span>, O_RDWR|O_CREAT, 0666<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>    <span style=color:#75715e># open</span>
</span></span><span style=display:flex><span>dup2<span style=color:#f92672>(</span>3, 10<span style=color:#f92672>)</span>                        	              <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>   <span style=color:#75715e># duplicate</span>
</span></span><span style=display:flex><span>close<span style=color:#f92672>(</span>3<span style=color:#f92672>)</span>                            	          <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>    <span style=color:#75715e># close unneded initial fd</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>Now we can write there:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;123&#34;</span> &gt;&amp;<span style=color:#ae81ff>10</span>
</span></span></code></pre></div><p>And read from it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ cat &lt;&amp;<span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>123</span>
</span></span></code></pre></div><p>And when we finish, we can close it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ exec 10&lt;&amp;-
</span></span></code></pre></div><p>Fun fact: if you close the <code>stdin</code>, you’ll lose your ssh connection:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ exec 0&lt;&amp;-
</span></span></code></pre></div><p>This happens because your bash is a session leader and a controlling terminal process. When the controlling terminal closes its terminal, the kernel sends a <code>SIGHUP</code> signal to it, and the shell exits. We will talk about sessions, leaders and terminals later in next series of posts.</p><p>We also can use “-” (dash, minus) char instead of a file name for some tools. It means to read a file content from the <code>stdin</code>. For example, it may be really useful with <code>diff</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ echo <span style=color:#e6db74>&#34;123&#34;</span> | diff -u /tmp/file1.txt -
</span></span><span style=display:flex><span>--- /tmp/file1.txt  	2022-07-10 21:42:02.256998049 +0000
</span></span><span style=display:flex><span>+++ -   2022-07-10 21:42:15.733486844 +0000
</span></span><span style=display:flex><span>@@ -1 +1 @@
</span></span><span style=display:flex><span>-124
</span></span><span style=display:flex><span>+123
</span></span></code></pre></div><p>Another advanced feature of the bash is a process <a href=https://tldp.org/LDP/abs/html/process-sub.html target=_blank rel=noopener>substitution</a>, which involves the duplication of file descriptors. Long story short, you can create tmp files with on demand and use them in other tools awaiting file parameters.</p><p>Process substitution uses <code>/dev/fd/&lt;n></code> files to send the results of the process(es) within parentheses to another process.</p><p>I like the following two examples. This approach helps improve my shell experience and saves me from creating temporary files. The first one is a <code>diff</code> example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ diff -u &lt;<span style=color:#f92672>(</span>cat /tmp/file.1 | sort | grep <span style=color:#e6db74>&#34;string&#34;</span><span style=color:#f92672>)</span> &lt;<span style=color:#f92672>(</span>echo <span style=color:#e6db74>&#34;string2&#34;</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>--- /dev/fd/63  2022-07-10 21:53:39.960846984 +0000
</span></span><span style=display:flex><span>+++ /dev/fd/62  2022-07-10 21:53:39.960846984 +0000
</span></span><span style=display:flex><span>@@ -1 +1 @@
</span></span><span style=display:flex><span>-string1
</span></span><span style=display:flex><span>+string2
</span></span></code></pre></div><p>And the following one helps with <code>strace</code> and <code>grep</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ strace -s0 -e openat -o &gt;<span style=color:#f92672>(</span>grep file1.db<span style=color:#f92672>)</span> python3 ./dup.py
</span></span><span style=display:flex><span><span style=color:#ae81ff>2243</span>
</span></span><span style=display:flex><span>openat<span style=color:#f92672>(</span>AT_FDCWD, <span style=color:#e6db74>&#34;/var/tmp/file1.db&#34;</span>, O_RDONLY|O_CLOEXEC<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>
</span></span></code></pre></div><a href=/docs/fd-pipe-session-terminal/2-pipes/ class="book-btn right-button">Read next chapter →</a></article><footer class=book-footer><div class="flex flex-wrap justify-between"></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#file-descriptor-and-open-file-description>File descriptor and open file description</a><ul><li><a href=#stdin-stdout-and-stderr><code>stdin</code>, <code>stdout</code> and <code>stderr</code></a></li><li><a href=#procfs-and-file-descriptors>Procfs and file descriptors</a></li><li><a href=#sharing-file-descriptors-between-parent-and-child-after-fork>Sharing file descriptors between parent and child after <code>fork()</code></a></li><li><a href=#duplication-of-file-descriptors>Duplication of file descriptors</a></li><li><a href=#execve-and-file-descriptors><code>Execve()</code> and file descriptors</a><ul><li><a href=#o_cloexec><code>O_CLOEXEC</code></a></li></ul></li><li><a href=#check-if-2-file-descriptors-share-the-same-open-file-description-with-kcmp>Check if 2 file descriptors share the same open file description with <code>kcmp()</code></a></li><li><a href=#more-ways-to-transfer-file-descriptors-between-processes-pidfd_getfd-and-unix-datagrams>More ways to transfer file descriptors between processes: <code>pidfd_getfd()</code> and Unix datagrams.</a></li><li><a href=#shell-redirections-and-file-descriptors>Shell redirections and file descriptors</a></li></ul></li></ul></nav></div></aside></main><div class=cookie-container><p>This website uses "<b>cookies</b>".
Using this website means you're OK with this.
If you are <b>NOT</b>, please close the site page.</p><button class=cookie-btn>
ACCEPT AND CLOSE</button></div><script src=/my_js/cookie.js></script></body></html>